<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <title>Image Editor & URL Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .header-gradient {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        }
        .canvas-container {
            max-width: 100%;
            max-height: 400px;
            overflow: auto;
        }
        #imageCanvas {
            max-width: 100%;
        }
    </style>
<header class="text-white py-8 text-center bg-cover bg-center" style="background-image: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(139, 92, 246, 0.8)), url('images (7).jpeg?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');">
    <h1 class="text-4xl font-bold mb-2">Image Editor & URL Converter</h1>
    <p class="text-lg">Transform your images: resize, edit, remove background, and convert to URL</p>
</header>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="mb-6">
                <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                    file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100">
            </div>

            <div class="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200 shadow-sm">
    <h2 class="text-lg font-semibold mb-3 text-gray-800">Original Image Properties</h2>
    <div class="grid grid-cols-2 gap-4 text-sm text-gray-700">
        <div class="flex justify-between p-2 bg-white rounded-md">
            <span class="font-medium">File Name:</span>
            <span id="originalName" class="text-gray-600">N/A</span>
        </div>
        <div class="flex justify-between p-2 bg-white rounded-md">
            <span class="font-medium">Dimensions:</span>
            <span id="originalDimensions" class="text-gray-600">N/A</span>
        </div>
        <div class="flex justify-between p-2 bg-white rounded-md">
            <span class="font-medium">File Size:</span>
            <span id="originalSize" class="text-gray-600">N/A</span>
        </div>
        <div class="flex justify-between p-2 bg-white rounded-md">
            <span class="font-medium">Format:</span>
            <span id="originalFormat" class="text-gray-600">N/A</span>
        </div>
    </div>
</div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h2 class="text-lg font-semibold mb-2">Image Preview</h2>
                    <div class="canvas-container">
                        <canvas id="imageCanvas" class="border border-gray-200 rounded-md"></canvas>
                    </div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold mb-2">Edit Options</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Output File Name</label>
                            <input type="text" id="outputName" placeholder="Enter file name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Resize Width (px)</label>
                            <input type="number" id="resizeWidth" min="10" max="4000" value="500" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Resize Height (px)</label>
                            <input type="number" id="resizeHeight" min="10" max="4000" value="500" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Maintain Aspect Ratio</label>
                            <input type="checkbox" id="maintainAspect" checked class="mt-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Target File Size</label>
                            <div class="flex space-x-2">
                                <input type="number" id="targetSize" min="1" value="" placeholder="Size" class="mt-1 block w-3/4 p-2 border border-gray-300 rounded-md">
                                <select id="sizeUnit" class="mt-1 block w-1/4 p-2 border border-gray-300 rounded-md">
                                    <option value="kb">KB</option>
                                    <option value="mb">MB</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Brightness</label>
                            <input type="range" id="brightness" min="0" max="2" step="0.1" value="1" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Contrast</label>
                            <input type="range" id="contrast" min="0" max="2" step="0.1" value="1" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Rotation (degrees)</label>
                            <input type="number" id="rotation" min="0" max="360" value="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Output Format</label>
                            <select id="outputFormat" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                <option value="image/png">PNG</option>
                                <option value="image/jpeg">JPEG</option>
                                <option value="image/webp">WebP</option>
                            </select>
                        </div>
                        <!-- Add "Upload" button -->
<button id="uploadButton" class="flex-1 py-2 px-4 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 disabled:bg-gray-400">Upload & Get URL</button>
                        <button id="removeBackground" class="w-full py-2 px-4 bg-purple-600 text-white rounded-md hover:bg-purple-700">Remove Background</button>
                        <button id="applyEdits" class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">Apply Edits</button>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-2">Data URL</h2>
                <textarea id="dataUrl" readonly class="w-full h-32 p-2 border border-gray-300 rounded-md font-mono text-sm bg-gray-50" placeholder="Data URL will appear here"></textarea>
                <div class="flex space-x-4 mt-2">
                    <button id="copyButton" disabled class="flex-1 py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400">Copy URL</button>
                    <button id="downloadButton" disabled class="flex-1 py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400">Download Image</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white text-center py-4">
        <p>Created with love by Richard O. Timothy</p>
    </footer>

    <script>
        const imageInput = document.getElementById('imageInput');
        const imageCanvas = document.getElementById('imageCanvas');
        const dataUrl = document.getElementById('dataUrl');
        const copyButton = document.getElementById('copyButton');
        const downloadButton = document.getElementById('downloadButton');
        const resizeWidth = document.getElementById('resizeWidth');
        const resizeHeight = document.getElementById('resizeHeight');
        const maintainAspect = document.getElementById('maintainAspect');
        const targetSize = document.getElementById('targetSize');
        const sizeUnit = document.getElementById('sizeUnit');
        const brightness = document.getElementById('brightness');
        const contrast = document.getElementById('contrast');
        const rotation = document.getElementById('rotation');
        const outputFormat = document.getElementById('outputFormat');
        const outputName = document.getElementById('outputName');
        const applyEdits = document.getElementById('applyEdits');
        const removeBackground = document.getElementById('removeBackground');
        const originalName = document.getElementById('originalName');
        const originalDimensions = document.getElementById('originalDimensions');
        const originalSize = document.getElementById('originalSize');
        const originalFormat = document.getElementById('originalFormat');
        const ctx = imageCanvas.getContext('2d');
        let originalImage = new Image();
        let editedImage = new Image();
        let originalAspectRatio = 1;

        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                originalName.textContent = file.name;
                originalFormat.textContent = file.type.split('/')[1].toUpperCase();
                originalSize.textContent = `${(file.size / 1024).toFixed(2)} KB`;
                outputName.value = file.name.split('.')[0]; // Set default output name
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImage.src = e.target.result;
                    editedImage.src = e.target.result;
                    originalImage.onload = function() {
                        originalAspectRatio = originalImage.width / originalImage.height;
                        originalDimensions.textContent = `${originalImage.width} x ${originalImage.height} px`;
                        resizeWidth.value = originalImage.width;
                        resizeHeight.value = originalImage.height;
                        applyImageEdits();
                    };
                };
                reader.readAsDataURL(file);
            } else {
                alert('Please select a valid image file');
                resetForm();
            }
        });

        function resetForm() {
            imageInput.value = '';
            dataUrl.value = '';
            copyButton.disabled = true;
            downloadButton.disabled = true;
            imageCanvas.width = 0;
            imageCanvas.height = 0;
            originalName.textContent = 'N/A';
            originalDimensions.textContent = 'N/A';
            originalSize.textContent = 'N/A';
            originalFormat.textContent = 'N/A';
            outputName.value = '';
            resizeWidth.value = 500;
            resizeHeight.value = 500;
            maintainAspect.checked = true;
        }

        resizeWidth.addEventListener('input', function() {
            if (maintainAspect.checked) {
                resizeHeight.value = Math.round(resizeWidth.value / originalAspectRatio);
            }
        });

        resizeHeight.addEventListener('input', function() {
            if (maintainAspect.checked) {
                resizeWidth.value = Math.round(resizeHeight.value * originalAspectRatio);
            }
        });

        function applyImageEdits() {
            let width = parseInt(resizeWidth.value) || 500;
            let height = parseInt(resizeHeight.value) || 500;
            const brightnessValue = parseFloat(brightness.value) || 1;
            const contrastValue = parseFloat(contrast.value) || 1;
            const rotationValue = parseInt(rotation.value) || 0;
            const format = outputFormat.value || 'image/png';
            let quality = format === 'image/jpeg' ? 0.8 : undefined;

            // Adjust quality for target file size
            const targetSizeValue = parseFloat(targetSize.value);
            if (targetSizeValue) {
                const targetBytes = sizeUnit.value === 'mb' ? targetSizeValue * 1024 * 1024 : targetSizeValue * 1024;
                quality = format === 'image/jpeg' || format === 'image/webp' ? estimateQuality(targetBytes) : undefined;
            }

            imageCanvas.width = width;
            imageCanvas.height = height;

            ctx.save();
            ctx.filter = `brightness(${brightnessValue}) contrast(${contrastValue})`;
            if (rotationValue) {
                ctx.translate(imageCanvas.width / 2, imageCanvas.height / 2);
                ctx.rotate((rotationValue * Math.PI) / 180);
                ctx.translate(-imageCanvas.width / 2, -imageCanvas.height / 2);
            }
            ctx.drawImage(editedImage, 0, 0, imageCanvas.width, imageCanvas.height);
            ctx.restore();

            dataUrl.value = imageCanvas.toDataURL(format, quality);
            copyButton.disabled = false;
            downloadButton.disabled = false;
        }

        function estimateQuality(targetBytes) {
            let quality = 0.8;
            let dataUrl;
            do {
                dataUrl = imageCanvas.toDataURL(outputFormat.value, quality);
                const byteLength = Math.round((dataUrl.length * 3) / 4); // Approximate base64 to bytes
                if (byteLength > targetBytes && quality > 0.1) {
                    quality -= 0.1;
                } else if (byteLength < targetBytes && quality < 1) {
                    quality += 0.1;
                } else {
                    break;
                }
            } while (Math.abs(byteLength - targetBytes) > 1024 && quality >= 0.1 && quality <= 1);
            return quality;
        }

        function removeImageBackground() {
            const width = parseInt(resizeWidth.value) || 500;
            imageCanvas.width = width;
            imageCanvas.height = (editedImage.height * width) / editedImage.width;

            ctx.drawImage(originalImage, 0, 0, imageCanvas.width, imageCanvas.height);
            const imageData = ctx.getImageData(0, 0, imageCanvas.width, imageCanvas.height);
            const data = imageData.data;

            // Simple background removal using thresholding
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                if (r > 200 && g > 200 && b > 200) {
                    data[i + 3] = 0; // Set alpha to 0 (transparent)
                }
            }

            ctx.putImageData(imageData, 0, 0);
            editedImage.src = imageCanvas.toDataURL('image/png');
            editedImage.onload = applyImageEdits;
        }

        applyEdits.addEventListener('click', applyImageEdits);
        removeBackground.addEventListener('click', removeImageBackground);

        copyButton.addEventListener('click', function() {
            dataUrl.select();
            try {
                document.execCommand('copy');
                alert('URL copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy URL');
            }
        });
uploadButton.addEventListener('click', async function() {
    imageCanvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append('image', blob, (outputName.value || 'edited-image') + '.' + outputFormat.value.split('/')[1]);
        
        uploadButton.disabled = true;
        uploadButton.textContent = 'Uploading...';
        
        try {
            const response = await fetch('https://examguide.onrender.com/api/images', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.url) {
                // Use the absolute URL for frontend consumption
                dataUrl.value = 'https://examguide.onrender.com' + result.url;
                copyButton.disabled = false;
                downloadButton.disabled = false;
                alert('Image uploaded! URL ready.');
            } else {
                alert('Upload failed.');
            }
        } catch (err) {
            alert('Error uploading image.');
        } finally {
            uploadButton.disabled = false;
            uploadButton.textContent = 'Upload & Get URL';
        }
    }, outputFormat.value, outputFormat.value === 'image/jpeg' ? 0.8 : undefined);
});
        downloadButton.addEventListener('click', function() {
            const format = outputFormat.value || 'image/png';
            const extension = format.split('/')[1];
            const filename = outputName.value || 'edited-image';
            const link = document.createElement('a');
            link.href = imageCanvas.toDataURL(format, format === 'image/jpeg' ? 0.8 : undefined);
            link.download = `${filename}.${extension}`;
            link.click();
        });
    </script>
</body>
</html>
