<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Central Mock Portal | OAUExam Suite</title>
  <meta name="viewport" content="width=device-width, initial-scale=0.85" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,600,800&display=swap">
  <link rel="icon" href="logo.png">
  <style>
    :root {
      --primary: #3a86ff;
      --primary-dark: #26549b;
      --accent: #8338ec;
      --success: #43aa8b;
      --warning: #ffbe0b;
      --danger: #ff3b47;
      --muted: #adb5bd;
      --bg: #f8faff;
      --bg-card: #f4f8fe;
      --white: #fff;
      --border: #e2eafc;
      --shadow: 0 4px 18px #3a86ff13;
      --radius: 18px;
      --radius-s: 12px;
      --radius-xs: 8px;
      --gradient: linear-gradient(90deg, #3a86ff 0%, #8338ec 100%);
      --gradient-accent: linear-gradient(90deg, #43aa8b 0%, #ffbe0b 100%);
      --table-head: #f4f8fe;
    }
    html, body {
      background: var(--bg);
      font-family: 'Inter', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      color: #23366e;
      letter-spacing: 0.01em;
    }
.table-responsive {
  width: 100%;
  overflow-x: auto;
}
.test-table {
  min-width: 700px;
}
.test-table td, .test-table th {
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
  max-width: 170px;
}
@media (max-width: 650px) {
  .test-table th:nth-child(2),
  .test-table td:nth-child(2),
  .test-table th:nth-child(3),
  .test-table td:nth-child(3) {
    display: none;
  }
  .test-table {
    min-width: 400px;
  }
  }
    /* Header */
    .header {
      background: var(--gradient);
      color: var(--white);
      padding: 44px 0 34px 0;
      position: relative;
      box-shadow: 0 2px 18px #3a86ff22;
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
      text-align: center;
    }
    .header .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      justify-content: center;
      margin-bottom: 6px;
    }
    .header .brand img {
      height: 42px;
      width: 42px;
      border-radius: var(--radius-xs);
      background: #fff;
      border: 2.5px solid var(--white);
      object-fit: contain;
      box-shadow: 0 1px 10px #3a86ff19;
    }
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 2.1rem;
      letter-spacing: 0.04em;
      font-weight: 800;
    }
    .header small {
      opacity: 0.95;
      font-size: 1.03em;
    }
    .notif-bell {
      position: absolute;
      top: 24px; right: 25px;
      font-size: 2.1rem;
      color: var(--warning);
      cursor: pointer;
      z-index: 30;
      filter: drop-shadow(0 2px 2px #3a86ff22);
      transition: color 0.18s;
    }
    .notif-bell:hover { color: #fff6b7; }
    .notif-bell .notif-dot {
      position: absolute;
      top: 5px; right: 8px;
      width: 13px; height: 13px;
      background: var(--danger);
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 0 5px #ff3b4733;
    }
    .notif-dropdown {
      position: absolute;
      top: 60px;
      right: 22px;
      background: #fff;
      border-radius: var(--radius-xs);
      box-shadow: var(--shadow);
      width: 330px;
      padding: 10px 0;
      z-index: 50;
      display: none;
      border: 1.3px solid var(--border);
    }
    .notif-dropdown.active { display: block; }
    .notif-dropdown .notif-item {
      padding: 13px 22px;
      border-bottom: 1px solid #e3e8ee;
      cursor: pointer;
      background: #fff;
      transition: background 0.11s;
    }
    .notif-dropdown .notif-item:hover {
      background: var(--bg-card);
    }
    .notif-dropdown .notif-title { font-weight: 700; color: var(--primary);}
    .notif-dropdown .notif-time { color: #888; font-size: 0.95em;}

    /* Main */
    .main {
      max-width: 900px;
      margin: 40px auto 0 auto;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 38px 32px 44px 32px;
      position: relative;
    }

    /* Profile section */
    .profile {
      display: flex;
      align-items: flex-start;
      gap: 28px;
      margin-bottom: 32px;
      border-bottom: 1.5px solid var(--border);
      padding-bottom: 20px;
      flex-wrap: wrap;
    }
    .profile-img {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 80px;
      width: 80px;
      background: var(--bg-card);
      border-radius: 50%;
      box-shadow: 0 1px 8px #3a86ff18;
      margin-top: 6px;
    }
    .profile-img img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #eaf1fb;
      border: 2px solid var(--primary);
      object-fit: cover;
      box-shadow: 0 1px 8px #3a86ff11;
    }
    .profile-info {
      flex: 1;
      min-width: 170px;
    }
    .profile-info h2 {
      margin: 0 0 6px 0;
      font-size: 1.42rem;
      font-weight: 800;
      color: var(--primary);
      letter-spacing: 0.01em;
    }
    .profile-info .meta {
      color: var(--accent);
      font-size: 1.05rem;
      margin: 4px 0;
      font-weight: 500;
    }
    .profile-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .profile-actions .btn-profile {
      background: var(--gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-xs);
      padding: 8px 18px;
      font-size: 1.02rem;
      font-weight: 600;
      box-shadow: 0 1px 7px #3a86ff14;
      cursor: pointer;
      transition: background 0.18s, box-shadow 0.2s;
    }
    .profile-actions .btn-profile:hover {
      background: var(--gradient-accent);
      color: #222;
      box-shadow: 0 2px 9px #43aa8b44;
    }
    .profile-info .support-link {
      color: var(--primary);
      text-decoration: underline;
      cursor: pointer;
      font-size: 1.01em;
      margin-top: 13px;
      display: inline-block;
      font-weight: 500;
    }

    /* Dashboard cards */
    .dashboard-cards {
      display: flex;
      gap: 20px;
      margin: 23px 0 12px 0;
      flex-wrap: wrap;
    }
    .dashboard-card {
      flex: 1 1 185px;
      background: var(--bg-card);
      border-radius: var(--radius-s);
      padding: 22px 15px 19px 15px;
      min-width: 145px;
      color: var(--primary-dark);
      font-weight: 600;
      box-shadow: 0 2px 14px #3a86ff0a;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      border: 1.5px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    .dashboard-card .card-title {
      font-size: 1.09rem;
      color: var(--accent);
      margin-bottom: 6px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .dashboard-card .card-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary);
    }
    .dashboard-card .cert-link {
      font-size: 1.03rem;
      color: var(--primary);
      text-decoration: underline;
      cursor: pointer;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .dashboard-card .cert-link:hover {
      color: var(--accent);
    }
    .dashboard-card #badgePanel {
      margin-top: 5px;
    }

    /* Recommendations */
    .recommend-box {
      background: var(--gradient-accent);
      border-radius: var(--radius-s);
      margin-bottom: 22px;
      margin-top: 7px;
      box-shadow: 0 2px 10px #ffbe0b13;
      display: flex;
      align-items: stretch;
      min-height: 84px;
      overflow: hidden;
      position: relative;
    }
    .recommend-icon-area {
      background: var(--gradient);
      width: 84px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 2.3rem;
      font-weight: bold;
      border-radius: var(--radius-s) 0 0 var(--radius-s);
      box-shadow: 0 2px 8px #3a86ff18;
      flex-shrink: 0;
    }
    .recommend-content {
      padding: 15px 23px 15px 19px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .recommend-title {
      font-weight: 800;
      color: var(--primary);
      font-size: 1.11em;
      margin: 0 0 6px 0;
    }
    .recommend-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 18px;
    }
    .recommend-list li {
      background: #fff;
      border-radius: var(--radius-xs);
      color: var(--primary-dark);
      font-size: 1em;
      font-weight: 500;
      box-shadow: 0 1px 7px #3a86ff10;
      padding: 7px 14px 7px 12px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 98px;
      margin-top: 2px;
      border-left: 4px solid var(--primary);
      animation: fadeInUp 0.6s cubic-bezier(.23,1.01,.42,.98);
    }
    .recommend-list li .badge {
      background: var(--accent);
      color: #fff;
      font-size: 0.94em;
      border-radius: 7px;
      margin-left: 8px;
      padding: 2.5px 10px;
      font-weight: 600;
      box-shadow: 0 1px 3px #8338ec13;
    }
    .recommend-list li .badge-excellent {
      background: var(--success);
      color: #fff;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(25px);}
      to { opacity: 1; transform: translateY(0);}
    }

    /* Tables */
    .test-table, .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 13px;
      background: var(--bg-card);
      border-radius: var(--radius-xs);
      overflow: hidden;
      box-shadow: 0 2px 9px #3a86ff0d;
    }
    .test-table th, .test-table td, .result-table th, .result-table td {
      padding: 11px 8px;
      border-bottom: 1px solid #e3e8ee;
      font-size: 1em;
      text-align: left;
    }
    .test-table th, .result-table th {
      background: var(--table-head);
      color: var(--primary);
      font-size: 1.01rem;
      font-weight: 700;
      border-bottom: 2px solid var(--border);
    }

    /* Section titles */
    .section-title {
      font-size: 1.13rem;
      font-weight: 700;
      margin: 34px 0 10px 0;
      color: var(--primary-dark);
      letter-spacing: 0.01em;
    }

    /* Announcement */
    .announcement {
      background: #fffbe6;
      border-left: 5px solid var(--warning);
      margin: 14px 0 0 0;
      padding: 13px 18px;
      border-radius: var(--radius-xs);
      font-size: 1.04em;
      color: #b08900;
      font-weight: 600;
      box-shadow: 0 1px 8px #ffbe0b22;
    }

    /* Buttons */
    .btn {
      background: var(--gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-xs);
      padding: 10px 19px;
      font-size: 1.02rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 1px 6px #3a86ff15;
      transition: background 0.17s;
    }
    .btn:hover {
      background: var(--gradient-accent);
      color: #222;
      box-shadow: 0 1px 10px #ffbe0b22;
    }
    .btn:disabled {
      background: #b1c7ee;
      cursor: not-allowed;
      color: #fff;
    }
    /* Badges */
    .badge {
      display: inline-block;
      background: var(--success);
      color: #fff;
      font-size: 1em;
      border-radius: 8px;
      padding: 2.5px 10px;
      margin-right: 7px;
      margin-top: 3px;
      font-weight: 700;
      box-shadow: 0 1px 7px #43aa8b22;
    }

    /* Modal */
    .modern-modal-backdrop, .modal-backdrop {
      position: fixed; top:0; left:0; width:100vw; height:100vh;
      background: rgba(58,134,255,0.13);
      z-index:1001; display: flex; align-items: center; justify-content: center;
    }
    .modern-modal, .review-modal {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 8px 36px #3a86ff30;
      padding: 36px 30px 24px 30px;
      max-width: 420px;
      width: 97vw;
      display: flex; flex-direction: column; align-items: flex-start;
      position: relative;
    }
    .modern-modal h3, .review-modal h3, .modern-modal h2 {
      margin: 0 0 17px 0;
      font-size: 1.22rem;
      color: var(--primary);
      font-weight: 700;
    }
    .modal-close, .close-modal {
      position: absolute; right: 15px; top: 13px;
      background: none; border: none; font-size: 2.1rem; color: #bbb; cursor: pointer;
      transition: color 0.17s;
    }
    .modal-close:hover, .close-modal:hover {
      color: var(--danger);
    }
    .profile-img-preview { width: 52px; height: 52px; border-radius: 50%; object-fit: cover; margin-bottom: 8px;}
    .modern-input {
      width: 100%; font-size: 1.02em; margin-bottom: 13px; padding: 10px 12px;
      border: 1.3px solid #d1e4f7; border-radius: 8px; background: #f8fdff;
      outline: none; transition: border 0.2s;
    }
    .modern-input:focus { border-color: var(--primary);}
    .modern-btn {
      width: 100%; padding: 11px 0; border: none;
      background: var(--gradient);
      color: #fff; font-size: 1.09em; border-radius: 8px;
      font-weight: 700; margin-top: 7px; cursor: pointer; transition: background 0.2s;
    }
    .modern-btn:hover { background: var(--gradient-accent); color: #222;}
    .review-question {
      margin-top: 11px;
      margin-bottom: 7px;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: #2d5da8;
    }
    .review-opts {
      margin-left: 13px;
      font-size: 1em;
      margin-bottom: 5px;
    }
    .review-correct {
      color: var(--success);
      font-weight: 700;
    }
    .review-wrong {
      color: var(--danger);
      font-weight: 700;
    }
    .review-expl {
      font-size: 1.01rem;
      color: var(--primary);
      background: var(--bg-card);
      border-radius: 8px;
      padding: 7px 12px;
      margin: 6px 0 10px 0;
    }
    hr {
      border: none;
      border-top: 1.2px solid var(--border);
      margin: 10px 0 8px 0;
    }

    /* Chat modal */
    .chat-modal {
      background: #fff; border-radius: var(--radius); box-shadow: 0 8px 42px #3a86ff33;
      max-width: 380px; width: 94vw; padding: 0; position: relative; display: flex; flex-direction: column; height: 90vh; max-height: 500px;
      border: 1.7px solid var(--border);
    }
    .chat-modal-header {
      background: var(--bg-card); border-bottom: 1.7px solid #e3e8ee; border-radius: var(--radius) var(--radius) 0 0;
      padding: 17px 18px; font-weight: bold; font-size: 1.05rem; color: var(--primary); display: flex; align-items: center; justify-content: space-between;
    }
    .chat-list {
      max-height: 140px; overflow-y: auto; padding: 0 16px 8px 16px; border-bottom: 1px solid #e3e8ee;
    }
    .chat-list .chat-user { padding: 7px 0; cursor:pointer; color: var(--primary);}
    .chat-list .chat-user.active { color: var(--accent); font-weight: 700; }
    .chat-modal-body { flex: 1; overflow-y: auto; padding: 12px 12px 2px 12px; background: #f7fbfd;}
    .chat-message { margin-bottom: 12px; display: flex; flex-direction: column; }
    .chat-message.self { align-items: flex-end; }
    .chat-message .chat-bubble {
      max-width: 80%; padding: 10px 13px; border-radius: 13px;
      background: #e9f3ff; color: #23366e; margin-bottom: 2px; display: inline-block;
      font-size: 1em;
      box-shadow: 0 1px 7px #3a86ff0a;
    }
    .chat-message.self .chat-bubble { background: var(--primary); color: #fff; }
    .chat-message .chat-meta { font-size: 0.91em; color: #888;}
    .chat-modal-footer {
      padding: 9px 13px 13px 13px; background: #fff;
      display: flex; gap: 8px; border-radius: 0 0 var(--radius) var(--radius); border-top: 1.2px solid #e3e8ee;
    }
    .chat-input { flex: 1; border-radius: 8px; border: 1.2px solid var(--border); padding: 8px 10px; font-size: 1em;}
    .chat-send-btn { background: var(--primary); color: #fff; border: none; border-radius: 8px; padding: 7px 14px; font-size: 1em; cursor: pointer;}
    .chat-send-btn:disabled { background: #ccc; }
    /* Responsive */
    @media (max-width: 650px) {
      .main { padding: 7px 2vw; }
      .dashboard-cards { flex-direction: column; gap: 13px;}
      .profile { flex-direction: column; gap: 13px; }
    }
    @media (max-width: 500px) {
      .header { padding: 13px 1vw 9px 1vw; }
      .main { padding: 2vw; }
      .dashboard-card { min-width: 88px; }
      .recommend-content { padding: 7px 2vw 8px 2vw;}
      .recommend-icon-area { min-width: 52px; font-size: 1.5rem;}
      .result-table th, .result-table td, .test-table th, .test-table td { font-size: 0.95em; }
      .section-title { font-size: 1.04rem; }
      .profile-info h2 { font-size: 1.15rem;}
    }
  </style>
</head>
<body>
  <div class="header">
    <span class="notif-bell" id="notifBell" onclick="toggleNotifDropdown()" title="Notifications">
      &#128276;
      <span id="notifDot" class="notif-dot" style="display:none"></span>
    </span>
    <div class="notif-dropdown" id="notifDropdown"></div>
    <div class="brand">
      <img src="logo.png" alt="OAU Logo" onerror="this.style.display='none'"/>
      <span style="font-size:1.12em;font-weight:800;letter-spacing:0.04em;">Lumina Scholar Portal</span>
    </div>
    <h1>Welcome, <span id="studentName">Scholar</span>!</h1>
    <div><small>Faculty: <span id="studentFaculty"></span> | Department: <span id="studentDept"></span></small></div>
  </div>
  <div class="main">
    <!-- Profile section -->
    <div class="profile">
      <div class="profile-img">
        <img src="lumina-avatar.png" alt="Profile" id="profilePic" onerror="this.src='https://ui-avatars.com/api/?name=Scholar&background=3a86ff&color=fff&rounded=true';"/>
      </div>
      <div class="profile-info">
        <h2 id="profileName">Your Name</h2>
        <div class="meta">Username: <span id="profileUser"></span></div>
        <div class="meta">Faculty: <span id="profileFaculty"></span> | Department: <span id="profileDept"></span></div>
        <div class="profile-actions">
          <button class="btn-profile" onclick="openProfileEdit()">Edit Profile</button>
          <button class="btn-profile" onclick="openChatModal()">Messages</button>
          <button class="btn-profile" onclick="logout()">Logout</button>
        </div>
        <a class="support-link" href="#" onclick="openSupport()">Need Help? Contact Support</a>
      </div>
    </div>
    <!-- Dashboard cards -->
    <div class="dashboard-cards">
      <div class="dashboard-card">
        <div class="card-title">Your Progress</div>
        <canvas id="progressChart" width="120" height="90"></canvas>
      </div>
      <div class="dashboard-card">
        <div class="card-title">Upcoming Test</div>
        <div class="card-value" id="upcomingTest">None</div>
        <div id="testCountdown" style="font-size:1.01rem; color:var(--primary);font-weight:600;"></div>
      </div>
      <div class="dashboard-card">
        <div class="card-title">Certificates</div>
        <div><span class="cert-link" onclick="downloadCertificate()">Download</span></div>
        <div id="badgePanel"></div>
      </div>
    </div>
    <!-- Recommendations (restyled) -->
    <div class="recommend-box">
      <div class="recommend-icon-area" title="Personalized Study Path">&#x1F4DA;</div>
      <div class="recommend-content">
        <div class="recommend-title">Personalized Study Recommendations</div>
        <ul class="recommend-list" id="recommendations"></ul>
      </div>
    </div>
    <!-- Announcements & Messaging -->
    <div class="announcement" id="announcementsPanel"></div>
    <!-- Test History with Review -->
    <div class="section-title">Assessment Performance & Reviews</div>
    <table class="result-table" id="historyTable">
      <thead><tr><th>Test</th><th>Date</th><th>Score</th><th>Review</th></tr></thead>
      <tbody></tbody>
    </table>
    <!-- Upcoming/scheduled tests -->
    <div class="section-title">Available Assessments</div>
<div id="testSpinner" style="display:none;text-align:center;padding:20px;">
  <div style="display:inline-block;width:38px;height:38px;border:4px solid #e3e8ee;border-top:4px solid #3a86ff;border-radius:50%;animation:spin 1s linear infinite;"></div>
</div>
<div class="table-responsive">
  <table class="test-table" id="availableTable">
    <thead>
      <tr>
        <th>Test</th>
        <th>Description</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
    <!-- Discussion/Help -->
    <div class="section-title">Need Academic Help?</div>
    <button class="btn" onclick="openDiscussion()">Go to Community Board</button>
  </div>
  <div id="modalRoot"></div>
  <div id="refreshSpinner" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(255,255,255,0.9);align-items:center;justify-content:center;">
  <div style="border:8px solid #f3f3f3;border-top:8px solid #3a86ff;border-radius:50%;width:60px;height:60px;animation:spin 1.1s linear infinite;"></div>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // CONFIG
    const API_URL = "https://examguide.onrender.com/api/";
    const token = localStorage.getItem("token");
    let student = {};
    let progressData = { labels: [], values: [] };
    let resultsCache = [];
    let setsCache = [];
    let nextTest = null;
    let nextTestStart = null;
    let facultiesCache = [];
    let departmentsCache = [];
    let usersCache = [];
    let chatListCache = [];
    let chatPollingInterval = null;
    let unreadMessages = [];

    // ========== PROFILE / FACULTY / DEPARTMENT ==========
    async function fetchFacultiesAndDepartments() {
      const [faculties, departments] = await Promise.all([
        fetch(API_URL + "faculties", { headers: { Authorization: "Bearer " + token } }).then(r => r.json()),
        fetch(API_URL + "departments", { headers: { Authorization: "Bearer " + token } }).then(r => r.json())
      ]);
      facultiesCache = faculties;
      departmentsCache = departments;
    }
    async function fetchAllUsers() {
      const resp = await fetch(API_URL + "users", { headers: { Authorization: "Bearer " + token } });
      usersCache = await resp.json();
    }
    async function fetchProfile(showProfileModalOnEmpty = true) {
      const resp = await fetch(API_URL + "auth/me", { headers: { Authorization: "Bearer " + token } });
      const data = await resp.json();
      student = data.user;
      document.getElementById("studentName").innerText = student.username;
      document.getElementById("profileName").innerText = student.username;
      document.getElementById("profileUser").innerText = student.username;
      document.getElementById("studentFaculty").innerText = student.faculty || "-";
      document.getElementById("studentDept").innerText = student.department || "-";
      document.getElementById("profileFaculty").innerText = student.faculty || "-";
      document.getElementById("profileDept").innerText = student.department || "-";
      if (student.profilePic) document.getElementById("profilePic").src = student.profilePic;
      else document.getElementById("profilePic").src = `https://ui-avatars.com/api/?name=${encodeURIComponent(student.username || 'Scholar')}&background=3a86ff&color=fff&rounded=true`;
      if (
        showProfileModalOnEmpty &&
        (
          !student.faculty ||
          !student.department ||
          !student.username ||
          student.username === "student"
        )
      ) {
        openProfileEdit(true);
      }
    }
    function autoRefreshWithSpinner(timeoutMs=1200) {
  const spinner = document.getElementById("refreshSpinner");
  if (spinner) {
    spinner.style.display = "flex";
    setTimeout(() => {
      location.reload();
    }, timeoutMs);
  } else {
    // Fallback: just reload
    location.reload();
  }
    }
    // ========== PROFILE MODAL ==========
    function openProfileEdit(isInitial = false) {
      let facultyOptions = facultiesCache.map(f => `<option value="${f._id}" ${student.faculty === f.name ? "selected" : ""}>${f.name}</option>`).join('');
      let currentFacultyId = facultiesCache.find(f => f.name === student.faculty)?._id || "";
      let deptOptions = departmentsCache
        .filter(d => !currentFacultyId || d.faculty === currentFacultyId)
        .map(d => `<option value="${d._id}" ${student.department === d.name ? "selected" : ""}>${d.name}</option>`).join('');
      let html = `
        <div class="modern-modal-backdrop" onclick="closeModal(event)">
          <div class="modern-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>${isInitial ? "Complete Your Profile" : "Edit Profile"}</h3>
            <label>Username</label>
            <input id="editUsername" class="modern-input" value="${student.username || ''}" maxlength="32">
            <label>Password</label>
            <input id="editPassword" class="modern-input" type="password" placeholder="Leave blank to keep current">
            <label>Profile Picture</label>
            <input type="file" id="editProfilePicFile" accept="image/*" class="profile-img-upload" onchange="handleProfilePicUpload(event)">
            <img id="profileImgPreview" class="profile-img-preview" style="display:none">
            <input id="editProfilePic" value="${student.profilePic||''}" style="display:none;">
            <label>Faculty</label>
            <select id="editFaculty" class="modern-input" onchange="updateDeptOptions()">
              <option value="">Select Faculty</option>
              ${facultyOptions}
            </select>
            <label>Department</label>
            <select id="editDepartment" class="modern-input">
              <option value="">Select Department</option>
              ${deptOptions}
            </select>
            <button class="modern-btn" onclick="submitProfileEdit(${!!isInitial})">${isInitial ? "Save & Continue" : "Save"}</button>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
      if (student.profilePic) {
        let img = document.getElementById("profileImgPreview");
        img.src = student.profilePic;
        img.style.display = "block";
      }
    }
    function updateDeptOptions() {
      const facultyId = document.getElementById("editFaculty").value;
      const deptSelect = document.getElementById("editDepartment");
      const filtered = departmentsCache.filter(d => d.faculty === facultyId);
      deptSelect.innerHTML = "<option value=''>Select Department</option>" + filtered.map(d =>
        `<option value="${d._id}">${d.name}</option>`
      ).join('');
    }
    function handleProfilePicUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById("profileImgPreview").src = e.target.result;
        document.getElementById("profileImgPreview").style.display = "block";
        document.getElementById("editProfilePic").value = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    async function submitProfileEdit(isInitial) {
      const username = document.getElementById("editUsername").value.trim();
      const password = document.getElementById("editPassword").value;
      const profilePic = document.getElementById("editProfilePic").value.trim();
      const facultyId = document.getElementById("editFaculty").value;
      const departmentId = document.getElementById("editDepartment").value;
      if (!username || !facultyId || !departmentId) return alert("All fields are required.");
      const facultyObj = facultiesCache.find(f => f._id === facultyId);
      const departmentObj = departmentsCache.find(d => d._id === departmentId);
      const payload = {
        username,
        password,
        profilePic,
        faculty: facultyObj ? facultyObj.name : "",
        department: departmentObj ? departmentObj.name : ""
      };
      const resp = await fetch(API_URL + "superadmin/me", {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        const data = await resp.json();
        alert(data.message || "Failed to update profile.");
        return;
      }
      alert("Profile updated.");
closeModal();
autoRefreshWithSpinner(1200); // 1.2 seconds spinner before reload
    }
    // ========== ANNOUNCEMENTS/NOTIFICATIONS ==========
    async function fetchAnnouncements() {
      const resp = await fetch(API_URL + "notifications", { headers: { Authorization: "Bearer " + token } });
      const notifs = await resp.json();
      let html = "";
      notifs.forEach(n => {
        html += `<div class="message-link" style="cursor:pointer;color:var(--primary);" onclick="openMessageModal('${n.title.replace(/'/g, "\\'")}', '${n.message.replace(/'/g, "\\'")}', '${n.createdAt}')"><strong>${n.title}:</strong> ${n.message.length>60?n.message.substring(0,57)+'...':n.message} <small style="color:#888;">(${(new Date(n.createdAt)).toLocaleString()})</small></div>`;
      });
      document.getElementById("announcementsPanel").innerHTML = html || "No new announcements.";
    }
    function openMessageModal(title, msg, date) {
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="review-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>${title}</h3>
            <div><small style="color:var(--primary)">${(new Date(date)).toLocaleString()}</small></div>
            <div style="margin-top:12px;">${msg}</div>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    // ========== NOTIFICATION BELL ==========
    function toggleNotifDropdown() {
      const dd = document.getElementById("notifDropdown");
      dd.classList.toggle("active");
      if (dd.classList.contains("active")) {
        renderNotifDropdown();
        document.getElementById("notifDot").style.display = "none";
        unreadMessages = [];
      }
    }
    function renderNotifDropdown() {
      let html = "";
      if (!chatListCache.length) html = "<div style='padding:18px;text-align:center;color:#aaa;'>No new messages.</div>";
      else chatListCache.slice(0, 8).forEach(chat => {
        html += `<div class="notif-item" onclick="openChatModal('${chat.otherUserId}')">
          <div class="notif-title">${chat.otherUserName}</div>
          <div class="notif-time">${(new Date(chat.lastMsgAt)).toLocaleString()}</div>
          <div>${chat.lastMsgText ? chat.lastMsgText.substring(0, 60) : ""}</div>
        </div>`;
      });
      document.getElementById("notifDropdown").innerHTML = html;
    }
    // ========== MESSAGING ==========
    async function openChatModal(otherUserId = "") {
  // Ensure user data is loaded
  if (!student.id) await fetchProfile(false);
  if (!usersCache.length) await fetchAllUsers();

  // Find students in same department, excluding current user
  const deptStudents = usersCache.filter(
    u => u.role === "student" && u.department === student.department && u._id !== student.id
  );

  // Optionally show admins
  const adminUsers = usersCache.filter(u => u.role === "admin" || u.role === "superadmin");

  // Build student list
  let studentListHtml = deptStudents.length
    ? deptStudents.map(u => `
        <div class="chat-user${otherUserId === u._id ? " active" : ""}" 
             onclick="openChatModal('${u._id}')">
          <span>${u.username}</span>
        </div>
      `).join('')
    : `<div style="padding:10px;color:#aaa;">No other students in your department.</div>`;

  let adminListHtml = adminUsers.length
    ? `<div style="margin-top:12px;font-weight:700;color:var(--accent);">Admins</div>` +
      adminUsers.map(u => `
        <div class="chat-user${otherUserId === u._id ? " active" : ""}" 
             onclick="openChatModal('${u._id}')">
          <span>${u.username}</span> <span style="font-size:0.93em;color:var(--accent);">(Admin)</span>
        </div>
      `).join('')
    : "";

  let html = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="chat-modal" onclick="event.stopPropagation()">
        <div class="chat-modal-header">
          <span>Direct Messages</span>
          <button class="close-modal" onclick="closeModal(event)">&times;</button>
        </div>
        <div style="padding:10px;">
          <div style="font-weight:700;color:var(--primary-dark);margin-bottom:4px;">Students in your Department</div>
          <div class="chat-list">${studentListHtml}</div>
          ${adminListHtml ? `<div class="chat-list">${adminListHtml}</div>` : ""}
        </div>
        <div class="chat-modal-body" id="chatBody"></div>
        <form class="chat-modal-footer" onsubmit="event.preventDefault(); sendChatMessage('${otherUserId}');">
          <input class="chat-input" id="chatInput" autocomplete="off" placeholder="Type a message..." />
          <button type="submit" class="chat-send-btn" id="chatSendBtn" disabled>Send</button>
        </form>
      </div>
    </div>
  `;
  document.getElementById("modalRoot").innerHTML = html;

  // Enable send button only if input is not empty
  document.getElementById("chatInput").addEventListener("input", function() {
    document.getElementById("chatSendBtn").disabled = !this.value.trim();
  });

  // Load chat if a user is selected, else show instructions
  if (otherUserId) fetchChatMessages(otherUserId);
  else document.getElementById("chatBody").innerHTML =
    '<div style="padding:40px;text-align:center;color:#aaa;">Select a student to start chatting.</div>';

  // Poll for messages if user is selected
  if (chatPollingInterval) clearInterval(chatPollingInterval);
  if (otherUserId) {
    chatPollingInterval = setInterval(() => fetchChatMessages(otherUserId, true), 3000);
  }
}
    async function fetchChatMessages(otherUserId, silent=false) {
      if (!otherUserId) return;
      const resp = await fetch(`${API_URL}messages/${otherUserId}`, { headers: { Authorization: "Bearer " + token } });
      const data = await resp.json();
      let html = "";
      data.forEach(msg => {
        html += `<div class="chat-message${msg.from === student.id ? " self" : ""}">
          <div class="chat-bubble">${msg.text}</div>
          <div class="chat-meta">${(new Date(msg.createdAt)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>`;
      });
      document.getElementById("chatBody").innerHTML = html || "<div style='color:#aaa;'>No messages yet.</div>";
      document.getElementById("chatBody").scrollTop = 99999;
      if (!silent) document.getElementById("chatInput").focus();
    }
    async function sendChatMessage(otherUserId) {
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      document.getElementById("chatSendBtn").disabled = true;
      await fetch(`${API_URL}messages/${otherUserId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ text })
      });
      fetchChatMessages(otherUserId);
    }
    // ========== MESSAGE POLLING FOR NOTIFICATIONS ==========
    async function pollChatsForNotifications() {
      const resp = await fetch(`${API_URL}messages/chats`, { headers: { Authorization: "Bearer " + token } });
      chatListCache = await resp.json();
      unreadMessages = chatListCache.filter(c => c.unreadCount > 0);
      document.getElementById("notifDot").style.display = unreadMessages.length ? "block" : "none";
      if (unreadMessages.length && !document.getElementById("newMsgPopup")) {
        showNewMessagePopup(unreadMessages[0]);
      }
    }
    function showNewMessagePopup(chat) {
      let html = `<div id="newMsgPopup" style="position:fixed;bottom:32px;right:16px;z-index:9999;background:#fff;padding:18px 26px;border-radius:18px;box-shadow:0 4px 22px #3a86ff44;">
        <b>New message from ${chat.otherUserName}</b>
        <div style="margin:8px 0 0 0;">${chat.lastMsgText?chat.lastMsgText.substring(0,90):""}</div>
        <button class="btn" onclick="openChatModal('${chat.otherUserId}');document.getElementById('newMsgPopup').remove();">View</button>
        <button class="btn" onclick="document.getElementById('newMsgPopup').remove();" style="background:#f4f8fe;color:var(--primary);">Dismiss</button>
      </div>`;
      document.body.insertAdjacentHTML("beforeend", html);
      setTimeout(() => { if (document.getElementById("newMsgPopup")) document.getElementById("newMsgPopup").remove(); }, 16000);
    }
    // ========== RECOMMENDATIONS, HISTORY, TESTS, ETC. ==========
    function recommendTopics() {
      const list = document.getElementById("recommendations");
      if (!resultsCache.length || !setsCache.length) {
        list.innerHTML = `<li><span style="color:var(--muted);font-style:italic;">Take more assessments to receive tailored recommendations!</span></li>`;
        return;
      }
      let lowest = resultsCache.reduce((acc, cur) => {
        if (cur.score !== undefined && cur.score !== null) {
          if (!acc[cur.examSet]) acc[cur.examSet] = [];
          acc[cur.examSet].push(cur.score);
        }
        return acc;
      }, {});
      let avgScores = Object.entries(lowest).map(([set, scores]) => ({
        set, avg: scores.reduce((a,b)=>a+b,0)/scores.length
      })).sort((a,b)=>a.avg-b.avg);
      let html = "";
      if (avgScores.length > 0) {
        avgScores.slice(0,2).forEach(s => {
          html += `<li>
            <span>Focus on <b>${s.set}</b> (avg: ${Math.round(s.avg)}%)</span>
            <span class="badge">Practice</span>
          </li>`;
        });
        avgScores.filter(s => s.avg >= 80).slice(0,1).forEach(s => {
          html += `<li>
            <span>Great job on <b>${s.set}</b>!</span>
            <span class="badge badge-excellent">Excellent</span>
          </li>`;
        });
      }
      if (!html) html = `<li><span style="color:var(--muted);font-style:italic;">No recommendations. Stellar performance!</span></li>`;
      list.innerHTML = html;
    }
    async function fetchHistory() {
      if (!student.id) return;
      const resp = await fetch(API_URL + "results/user/" + student.id, { headers: { Authorization: "Bearer " + token } });
      const results = await resp.json();
      resultsCache = results;
      let html = "";
      let setStats = {};
      let badgeHtml = "";
      if (results.length > 0) {
        results.forEach(r => {
          if (!setStats[r.examSet]) setStats[r.examSet] = [];
          setStats[r.examSet].push(r.score ?? 0);
        });
        if (results.length >= 5) badgeHtml += `<span class="badge">5+ Assessments</span>`;
        if (results.some(r=>r.score>=80)) badgeHtml += `<span class="badge">High Performer</span>`;
      }
      document.getElementById("badgePanel").innerHTML = badgeHtml;
      progressData.labels = Object.keys(setStats);
      progressData.values = progressData.labels.map(lbl => {
        let arr = setStats[lbl] || [];
        return arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
      });
      renderProgressChart(progressData);
      results.slice(0,10).forEach(r => {
        html += `<tr>
          <td>${r.examSet}</td>
          <td>${(new Date(r.submittedAt)).toLocaleString()}</td>
          <td>${r.score ?? "-"}</td>
          <td><button class="btn" onclick="reviewResult('${r._id}')">Review</button></td>
        </tr>`;
      });
      document.querySelector("#historyTable tbody").innerHTML = html || "<tr><td colspan=4>No history</td></tr>";
      recommendTopics();
    }
    function renderProgressChart(data) {
      const ctx = document.getElementById('progressChart').getContext('2d');
      if (window._progressChart) window._progressChart.destroy();
      window._progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: ['#3a86ff', '#8338ec', '#ffbe0b', '#43aa8b', '#f25f5c', '#6639ba']
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          cutout: "70%",
          responsive: false,
          maintainAspectRatio: false
        }
      });
    }
    // This version fetches schedules (with populated examSet) and displays scheduled, available, and completed tests
async function fetchAvailableTests() {
  const spinner = document.getElementById("testSpinner");
  const tbody = document.querySelector("#availableTable tbody");
  spinner.style.display = "block";
  tbody.innerHTML = ""; // Clear previous table content

  try {
    // Defensive: ensure student object is loaded
    if (!student.faculty || !student.department) {
      spinner.style.display = "none";
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999;">
        Please complete your profile to see available assessments.</td></tr>`;
      document.getElementById("upcomingTest").innerText = "None";
      document.getElementById("testCountdown").innerText = "";
      return;
    }

    const resp = await fetch(
      API_URL +
        `schedules?faculty=${student.facultyId}&department=${student.departmentId}`,
      { headers: { Authorization: "Bearer " + token } }
    );
    const schedules = await resp.json();
    spinner.style.display = "none";

    if (!Array.isArray(schedules) || schedules.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999;">
        No available assessments at this time.</td></tr>`;
      document.getElementById("upcomingTest").innerText = "None";
      document.getElementById("testCountdown").innerText = "";
      return;
    }

    let html = "";
    let soonest = null;
    const now = Date.now();

    schedules.forEach((sched) => {
      const set = sched.examSet;
      if (!set || set.status !== "ACTIVE") return;

      const taken = resultsCache.some((r) => r.examSet === set.title);
      const start = sched.start ? new Date(sched.start) : null;
      const end = sched.end ? new Date(sched.end) : null;
      const canTake =
        !taken &&
        set.status === "ACTIVE" &&
        start &&
        now >= start.getTime() &&
        (!end || now <= end.getTime());

      const isScheduled = start && now < start.getTime();

      let statusLabel = taken
        ? "Completed"
        : canTake
        ? "Available"
        : isScheduled
        ? "Scheduled"
        : "Closed";

      let btnHtml = canTake
        ? `<button class="btn" onclick="startTest('${set._id}')">Start</button>`
        : taken
        ? `<span style="color:var(--muted);">Completed</span>`
        : isScheduled
        ? `<span style="color:var(--muted);">Not Yet Open</span>`
        : `<span style="color:var(--muted);">Closed</span>`;

      html += `<tr>
        <td>${set.title}</td>
        <td>${set.description ? set.description : "-"}</td>
        <td>${start ? start.toLocaleString() : "-"}</td>
        <td>${end ? end.toLocaleString() : "-"}</td>
        <td>${statusLabel}</td>
        <td>${btnHtml}</td>
      </tr>`;

      // Track soonest upcoming test (after now)
      if (
        set.status === "ACTIVE" &&
        !taken &&
        start &&
        now < start.getTime() &&
        (!soonest || start.getTime() < new Date(soonest.start).getTime())
      ) {
        soonest = { ...sched, examSet: set };
      }
    });

    tbody.innerHTML =
      html ||
      `<tr><td colspan="6" style="text-align:center;color:#999;">
        No available assessments at this time.</td></tr>`;

    // Handle upcoming test display & countdown
    if (
      soonest &&
      soonest.start &&
      new Date(soonest.start).getTime() > now &&
      soonest.examSet
    ) {
      nextTest = soonest.examSet;
      nextTestStart = new Date(soonest.start).getTime();
      document.getElementById("upcomingTest").innerText = soonest.examSet.title;
      startCountdown();
    } else if (schedules.length > 0) {
      // Show first ACTIVE test as current if no upcoming scheduled
      const firstAvailable = schedules.find(
        (sched) => sched.examSet && sched.examSet.status === "ACTIVE"
      );
      if (firstAvailable && firstAvailable.examSet)
        document.getElementById("upcomingTest").innerText =
          firstAvailable.examSet.title;
      else document.getElementById("upcomingTest").innerText = "None";
      document.getElementById("testCountdown").innerText = "";
    } else {
      document.getElementById("upcomingTest").innerText = "None";
      document.getElementById("testCountdown").innerText = "";
    }
  } catch (err) {
    spinner.style.display = "none";
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#f25f5c;">
      Failed to load assessments.</td></tr>`;
    document.getElementById("upcomingTest").innerText = "None";
    document.getElementById("testCountdown").innerText = "";
  }
}function startCountdown() {
  const countdownEl = document.getElementById("testCountdown");
  const testTitleEl = document.getElementById("upcomingTest");
  if (!nextTestStart || !countdownEl || !testTitleEl) return;

  function updateCountdown() {
    const now = Date.now();
    const diff = nextTestStart - now;
    if (diff <= 0) {
      countdownEl.innerText = "Test is now available!";
      testTitleEl.innerText = nextTest.title + " (Now Available)";
      clearInterval(timer);
      return;
    }
    // Calculate time parts
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    let text = "";
    if (hours > 0) text += hours + "h ";
    if (hours > 0 || minutes > 0) text += minutes + "m ";
    text += seconds + "s";
    countdownEl.innerText = "Starts in " + text;
  }

  // Initial call and set interval
  updateCountdown();
  const timer = setInterval(updateCountdown, 1000);
}

  
    // ========== REVIEW ========== 
    async function reviewResult(id) {
      const resp = await fetch(API_URL + "results", { headers: { Authorization: "Bearer " + token } });
      const results = await resp.json();
      const result = results.find(r => r._id === id);
      if (!result) return alert("Result not found.");
      const setResp = await fetch(API_URL + "questionsets?title=" + encodeURIComponent(result.examSet), { headers: { Authorization: "Bearer " + token } });
      const sets = await setResp.json();
      const set = Array.isArray(sets) ? sets[0] : sets;
      if (!set) return alert("Question set not found.");
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="review-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>Review: ${set.title} (${result.score}%)</h3>
            <div style="max-height:280px; overflow-y: auto;">`;
      set.questions.forEach((q, idx) => {
        let stuAns = result.answers && result.answers[q.id];
        let correct = q.answer;
        html += `<div class="review-question">${idx+1}. ${q.question}</div>
          <div class="review-opts">Your Answer: <span class="${stuAns===correct?'review-correct':'review-wrong'}">${stuAns||'-'}</span>,
            Correct: <span class="review-correct">${correct}</span></div>
          <div class="review-expl">${q.explanation||''}</div><hr>`;
      });
      html += `</div></div></div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    function closeModal(e) {
      if (!e || e.target.classList.contains('modal-backdrop') || e.target.classList.contains('close-modal')) {
        document.getElementById("modalRoot").innerHTML = "";
        if (chatPollingInterval) clearInterval(chatPollingInterval);
      }
    }
    function startTest(setId) {
      window.location.href = `mock.html?set=${setId}`;
    }
    function openSupport() {
      window.open("mailto:support@luminaexam.com", "_blank");
    }
    function openDiscussion() {
      window.open("discussion.html", "_blank");
    }
    function downloadCertificate() {
      alert("Certificate download coming soon! (Generate PDF for passed exams)");
    }
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }
    // ========== INIT ==========
    async function init() {
      if (!token) return window.location.href = "mock-icthallb";
      await fetchFacultiesAndDepartments();
      await fetchAllUsers();
      await fetchProfile();
      await fetchHistory();
      await fetchAnnouncements();
      await fetchAvailableTests();
      pollChatsForNotifications();
      setInterval(pollChatsForNotifications, 8000);
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.notif-bell') && !e.target.closest('.notif-dropdown')) {
          document.getElementById("notifDropdown").classList.remove("active");
        }
      });
    }
    window.onload = init;
  </script>
</body>
</html>
