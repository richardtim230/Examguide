<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lumina Scholar Portal | LuminaExam Suite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap">
  <link rel="icon" href="lumina-logo.png">
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(120deg, #e9f3ff 0%, #f5f7fa 100%);
      margin: 0;
      min-height: 100vh;
      color: #1b263b;
    }
    .header {
      background: linear-gradient(90deg, #364fc7 0%, #4895ef 100%);
      color: #fff;
      padding: 32px 20px 24px 20px;
      position: relative;
      box-shadow: 0 2px 12px #23366e22;
      border-bottom-left-radius: 28px;
      border-bottom-right-radius: 28px;
    }
    .header .brand {
      display: flex;
      align-items: center;
      gap: 13px;
      margin-bottom: 3px;
    }
    .header .brand img {
      height: 40px;
      width: 40px;
      border-radius: 13px;
      background: #fff;
      border: 2px solid #fff;
      object-fit: contain;
      box-shadow: 0 1px 8px #00285536;
    }
    .header h1 {
      margin: 0 0 5px 0;
      font-size: 2.1rem;
      letter-spacing: 0.02em;
    }
    .header small {
      opacity: 0.93;
    }
    .main {
      max-width: 1100px;
      margin: 36px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 32px #2d5da811;
      padding: 44px 38px 46px 38px;
    }
    .profile {
      display: flex;
      align-items: center;
      gap: 38px;
      margin-bottom: 34px;
      border-bottom: 1.5px solid #e7eefc;
      padding-bottom: 16px;
    }
    .profile-img img {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      background: #eaf1fb;
      border: 3px solid #4895ef66;
      object-fit: cover;
      box-shadow: 0 2px 10px #4895ef11;
    }
    .profile-info {
      flex: 1;
    }
    .profile-info h2 {
      margin: 0 0 4px 0;
      font-size: 1.85rem;
      font-weight: 700;
      color: #364fc7;
      letter-spacing: 0.01em;
    }
    .profile-info .meta {
      color: #4895ef;
      font-size: 1.11rem;
      margin: 2.5px 0;
    }
    .profile-actions {
      margin-top: 8px;
    }
    .profile-actions .btn-profile {
      background: linear-gradient(90deg, #364fc7 60%, #4895ef 100%);
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 8px 21px;
      font-size: 1.07rem;
      margin-right: 7px;
      font-weight: 500;
      box-shadow: 0 1px 7px #4895ef11;
      cursor: pointer;
      transition: background 0.18s, box-shadow 0.2s;
    }
    .profile-actions .btn-profile:hover {
      background: linear-gradient(90deg, #4895ef 40%, #364fc7 100%);
      box-shadow: 0 2px 9px #2d5da844;
    }
    .profile-info .support-link {
      color: #364fc7;
      text-decoration: underline;
      cursor: pointer;
      font-size: 1.04em;
      margin-top: 8px;
      display: inline-block;
    }
    .section-title {
      font-size: 1.18rem;
      font-weight: 700;
      margin: 36px 0 13px 0;
      color: #364fc7;
      letter-spacing: 0.01em;
    }
    .dashboard-cards {
      display: flex;
      gap: 28px;
      margin: 22px 0 10px 0;
      flex-wrap: wrap;
    }
    .dashboard-card {
      flex: 1 1 210px;
      background: linear-gradient(120deg, #f4fafe 80%, #eaf1fb 100%);
      border-radius: 13px;
      padding: 20px 17px 18px 17px;
      min-width: 175px;
      color: #364fc7;
      font-weight: 600;
      box-shadow: 0 2px 16px #4895ef10;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      border: 1.5px solid #e3e7f7;
      position: relative;
    }
    .dashboard-card .card-title {
      font-size: 1.14rem;
      color: #4895ef;
      margin-bottom: 6px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    .dashboard-card .card-value {
      font-size: 1.95rem;
      font-weight: 700;
      color: #23366e;
    }
    .dashboard-card .cert-link {
      font-size: 1.03rem;
      color: #364fc7;
      text-decoration: underline;
      cursor: pointer;
      margin-bottom: 3px;
    }
    .progress-bar-bg {
      height: 18px;
      width: 100%;
      background: #e7eefc;
      border-radius: 8px;
      margin: 11px 0 0 0;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4895ef 30%, #364fc7 100%);
      border-radius: 8px;
      transition: width 0.4s;
    }
    .recommend-box {
      background: linear-gradient(90deg, #e9f3ff 80%, #f5f7fa 100%);
      border-left: 6px solid #4895ef;
      border-radius: 10px;
      padding: 16px 22px;
      margin-bottom: 17px;
      box-shadow: 0 1px 8px #4895ef0d;
    }
    .recommend-title {
      font-weight: 700;
      color: #364fc7;
      margin-bottom: 7px;
      font-size: 1.09em;
    }
    .test-table, .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
      background: #f8fafe;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 9px #eaf1fb55;
    }
    .test-table th, .test-table td, .result-table th, .result-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #e3e8ee;
      font-size: 1.01em;
      text-align: left;
    }
    .test-table th, .result-table th {
      background: #eaf1fb;
      color: #364fc7;
      font-size: 1.09rem;
      font-weight: 700;
    }
    .btn {
      background: linear-gradient(90deg, #4895ef 60%, #364fc7 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 22px;
      margin: 2px 0;
      font-size: 1.07rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1px 5px #4895ef11;
      transition: background 0.19s;
    }
    .btn:hover {
      background: linear-gradient(90deg, #364fc7 60%, #4895ef 100%);
      box-shadow: 0 1px 9px #364fc733;
    }
    .btn:disabled {
      background: #b1c7ee;
      cursor: not-allowed;
      color: #fff;
    }
    .announcement {
      background: #f5f7fa;
      border-left: 5px solid #4895ef;
      margin: 18px 0;
      padding: 15px 22px;
      border-radius: 9px;
      font-size: 1.08em;
      color: #23366e;
    }
    .support-link {
      color: #4895ef;
      text-decoration: underline;
      cursor: pointer;
      font-weight: 500;
    }
    .badge {
      display: inline-block;
      background: #48b16f;
      color: #fff;
      font-size: 1.04rem;
      border-radius: 8px;
      padding: 3px 12px;
      margin-right: 7px;
      margin-top: 5px;
      font-weight: 600;
      box-shadow: 0 1px 8px #48b16f22, 0 1px 2px #fff9;
    }
    /* Notification Bell */
    .notif-bell {
      position: absolute;
      top: 25px; right: 34px;
      font-size: 2.2rem;
      color: #ffe066;
      cursor: pointer;
      z-index: 30;
      filter: drop-shadow(0 2px 2px #00285522);
      transition: color 0.19s;
    }
    .notif-bell:hover { color: #fff9b2; }
    .notif-bell .notif-dot {
      position: absolute;
      top: 4px; right: 3px;
      width: 13px; height: 13px;
      background: #ff3b47;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 0 5px #ff3b4733;
    }
    .notif-dropdown {
      position: absolute;
      top: 58px;
      right: 32px;
      background: #fff;
      border-radius: 11px;
      box-shadow: 0 4px 24px #364fc722;
      width: 340px;
      padding: 10px 0;
      z-index: 50;
      display: none;
      border: 1.6px solid #eaf1fb;
    }
    .notif-dropdown.active { display: block; }
    .notif-dropdown .notif-item {
      padding: 12px 22px;
      border-bottom: 1px solid #e3e8ee;
      cursor: pointer;
      background: #fff;
      transition: background 0.11s;
    }
    .notif-dropdown .notif-item:hover {
      background: #eaf1fb;
    }
    .notif-dropdown .notif-title { font-weight: 700; color: #364fc7; }
    .notif-dropdown .notif-time { color: #888; font-size: 0.95em;}
    /* Chat modal */
    .chat-modal {
      background: #fff; border-radius: 15px; box-shadow: 0 8px 42px #364fc733;
      max-width: 420px; width: 95vw; padding: 0; position: relative; display: flex; flex-direction: column; height: 88vh; max-height: 550px;
      border: 1.7px solid #eaf1fb;
    }
    .chat-modal-header {
      background: #eaf1fb; border-bottom: 1.7px solid #e3e8ee; border-radius: 15px 15px 0 0;
      padding: 18px 22px; font-weight: bold; font-size: 1.19rem; color: #4895ef; display: flex; align-items: center; justify-content: space-between;
    }
    .chat-list {
      max-height: 160px; overflow-y: auto; padding: 0 20px 10px 20px; border-bottom: 1px solid #e3e8ee;
    }
    .chat-list .chat-user { padding: 9px 0; cursor:pointer; color: #364fc7;}
    .chat-list .chat-user.active { color: #4895ef; font-weight: 700; }
    .chat-modal-body { flex: 1; overflow-y: auto; padding: 18px 18px 2px 18px; background: #f7fbfd;}
    .chat-message { margin-bottom: 15px; display: flex; flex-direction: column; }
    .chat-message.self { align-items: flex-end; }
    .chat-message .chat-bubble {
      max-width: 80%; padding: 12px 18px; border-radius: 14px;
      background: #e9f3ff; color: #23366e; margin-bottom: 2px; display: inline-block;
      font-size: 1.01em;
      box-shadow: 0 1px 7px #4895ef0a;
    }
    .chat-message.self .chat-bubble { background: #4895ef; color: #fff; }
    .chat-message .chat-meta { font-size: 0.92em; color: #888;}
    .chat-modal-footer {
      padding: 13px 18px 17px 18px; background: #fff;
      display: flex; gap: 10px; border-radius: 0 0 15px 15px; border-top: 1.5px solid #e3e8ee;
    }
    .chat-input { flex: 1; border-radius: 8px; border: 1.6px solid #eaf1fb; padding: 9px 12px; font-size: 1.07em;}
    .chat-send-btn { background: #4895ef; color: #fff; border: none; border-radius: 8px; padding: 9px 18px; font-size: 1.07em; cursor: pointer;}
    .chat-send-btn:disabled { background: #ccc; }
    .profile-img-upload { margin-top: 8px; }
    .profile-img-preview { width: 68px; height: 68px; border-radius: 50%; object-fit: cover; margin-bottom: 8px;}
    /* Modal styles */
    .modern-modal-backdrop, .modal-backdrop {
      position: fixed; top:0; left:0; width:100vw; height:100vh;
      background: rgba(54,79,199,0.16);
      z-index:1001; display: flex; align-items: center; justify-content: center;
    }
    .review-modal, .modern-modal {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 36px #364fc730;
      padding: 34px 28px 26px 28px;
      max-width: 550px;
      width: 95vw;
      display: flex; flex-direction: column; align-items: flex-start;
      position: relative;
    }
    .review-modal h3, .modern-modal h3, .modern-modal h2 {
      margin: 0 0 19px 0;
      font-size: 1.38rem;
      color: #364fc7;
    }
    .modal-close, .close-modal {
      position: absolute; right: 18px; top: 16px;
      background: none; border: none; font-size: 2rem; color: #bbb; cursor: pointer;
      transition: color 0.17s;
    }
    .modal-close:hover, .close-modal:hover {
      color: #ff3b47;
    }
    .profile-pic-upload {
      display: flex; flex-direction: column; align-items: center; margin-bottom: 18px;
    }
    .profile-pic-upload img {
      width: 74px; height: 74px; border-radius: 50%; margin-bottom: 8px; object-fit: cover; border: 2px solid #4895ef;
    }
    .modern-input {
      width: 100%; font-size: 1.09em; margin-bottom: 16px; padding: 11px 15px;
      border: 1.7px solid #d1e4f7; border-radius: 9px; background: #f8fdff;
      outline: none; transition: border 0.2s;
    }
    .modern-input:focus { border-color: #4895ef; }
    .modern-btn {
      width: 100%; padding: 12px 0; border: none;
      background: linear-gradient(90deg, #4895ef 50%, #364fc7 100%);
      color: #fff; font-size: 1.13em; border-radius: 9px;
      font-weight: 700; margin-top: 8px; cursor: pointer; transition: background 0.2s;
    }
    .modern-btn:hover { background: linear-gradient(90deg, #364fc7 60%, #4895ef 100%); }
    /* Review modal details */
    .review-question {
      margin-top: 13px;
      margin-bottom: 7px;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: #23366e;
    }
    .review-opts {
      margin-left: 16px;
      font-size: 1em;
      margin-bottom: 5px;
    }
    .review-correct {
      color: #48b16f;
      font-weight: 700;
    }
    .review-wrong {
      color: #ff3b47;
      font-weight: 700;
    }
    .review-expl {
      font-size: 1.01rem;
      color: #4895ef;
      background: #eaf1fb;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 7px 0 10px 0;
    }
    hr {
      border: none;
      border-top: 1.2px solid #e7eefc;
      margin: 10px 0 8px 0;
    }
    /* Responsive */
    @media (max-width: 750px) {
      .main { padding: 13px 2vw; }
      .dashboard-cards { flex-direction: column; }
      .profile { flex-direction: column; gap: 18px; }
    }
    @media (max-width: 430px) {
      .header { padding: 22px 7px 13px 7px; }
      .main { padding: 2vw; }
      .dashboard-card { min-width: 120px; }
    }
  </style>
</head>
<body>
  <div class="header" style="position:relative;">
    <span class="notif-bell" id="notifBell" onclick="toggleNotifDropdown()" title="Notifications">
      &#128276;
      <span id="notifDot" class="notif-dot" style="display:none"></span>
    </span>
    <div class="notif-dropdown" id="notifDropdown"></div>
    <div class="brand">
      <img src="lumina-logo.png" alt="Lumina Logo" />
      <span style="font-size:1.25em;font-weight:700;letter-spacing:0.04em;">Lumina Scholar Portal</span>
    </div>
    <h1>Hello, <span id="studentName">Scholar</span>!</h1>
    <div><small>Faculty: <span id="studentFaculty"></span> | Department: <span id="studentDept"></span></small></div>
  </div>
  <div class="main">
    <!-- Profile section -->
    <div class="profile">
      <div class="profile-img"><img src="lumina-avatar.png" alt="Profile" id="profilePic"></div>
      <div class="profile-info">
        <h2 id="profileName">Your Name</h2>
        <div class="meta">Username: <span id="profileUser"></span></div>
        <div class="meta">Faculty: <span id="profileFaculty"></span> | Department: <span id="profileDept"></span></div>
        <div class="profile-actions">
          <button class="btn-profile" onclick="openProfileEdit()">Edit Profile</button>
          <button class="btn-profile" onclick="openChatModal()">Messages</button>
          <button class="btn-profile" onclick="logout()">Logout</button>
        </div>
        <a class="support-link" href="#" onclick="openSupport()">Need Help? Contact Support</a>
      </div>
    </div>
    <!-- Dashboard cards -->
    <div class="dashboard-cards">
      <div class="dashboard-card">
        <div class="card-title">Your Progress</div>
        <canvas id="progressChart" width="120" height="90"></canvas>
      </div>
      <div class="dashboard-card">
        <div class="card-title">Upcoming Test</div>
        <div class="card-value" id="upcomingTest">None</div>
        <div id="testCountdown" style="font-size:1.01rem; color:#4895ef;"></div>
      </div>
      <div class="dashboard-card">
        <div class="card-title">Certificates</div>
        <div><span class="cert-link" onclick="downloadCertificate()">Download</span></div>
        <div id="badgePanel"></div>
      </div>
    </div>
    <!-- Recommendations -->
    <div class="recommend-box">
      <div class="recommend-title">Personalized Recommendations</div>
      <ul style="margin:0 0 0 14px;" id="recommendations"></ul>
    </div>
    <!-- Announcements & Messaging -->
    <div class="announcement" id="announcementsPanel"></div>
    <!-- Test History with Review -->
    <div class="section-title">Test Performance & Reviews</div>
    <table class="result-table" id="historyTable">
      <thead><tr><th>Test</th><th>Date</th><th>Score</th><th>Review</th></tr></thead>
      <tbody></tbody>
    </table>
    <!-- Upcoming/scheduled tests -->
    <div class="section-title">Available Assessments</div>
    <table class="test-table" id="availableTable">
      <thead><tr><th>Test</th><th>Status</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
    <!-- Discussion/Help -->
    <div class="section-title">Need Academic Help?</div>
    <button class="btn" onclick="openDiscussion()">Go to Community Board</button>
  </div>
  <div id="modalRoot"></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // CONFIG
    const API_URL = "https://examguide.onrender.com/api/";
    const token = localStorage.getItem("token");
    let student = {};
    let progressData = { labels: [], values: [] };
    let resultsCache = [];
    let setsCache = [];
    let nextTest = null;
    let nextTestStart = null;
    let facultiesCache = [];
    let departmentsCache = [];
    let usersCache = [];
    let chatListCache = [];
    let chatPollingInterval = null;
    let unreadMessages = [];

    // ========== PROFILE / FACULTY / DEPARTMENT ==========
    async function fetchFacultiesAndDepartments() {
      const [faculties, departments] = await Promise.all([
        fetch(API_URL + "faculties", { headers: { Authorization: "Bearer " + token } }).then(r => r.json()),
        fetch(API_URL + "departments", { headers: { Authorization: "Bearer " + token } }).then(r => r.json())
      ]);
      facultiesCache = faculties;
      departmentsCache = departments;
    }
    async function fetchAllUsers() {
      // fetch all users for chat (admin and department students)
      const resp = await fetch(API_URL + "users", { headers: { Authorization: "Bearer " + token } });
      usersCache = await resp.json();
    }
    async function fetchProfile(showProfileModalOnEmpty = true) {
      const resp = await fetch(API_URL + "auth/me", { headers: { Authorization: "Bearer " + token } });
      const data = await resp.json();
      student = data.user;
      document.getElementById("studentName").innerText = student.username;
      document.getElementById("profileName").innerText = student.username;
      document.getElementById("profileUser").innerText = student.username;
      document.getElementById("studentFaculty").innerText = student.faculty || "-";
      document.getElementById("studentDept").innerText = student.department || "-";
      document.getElementById("profileFaculty").innerText = student.faculty || "-";
      document.getElementById("profileDept").innerText = student.department || "-";
      if (student.profilePic) document.getElementById("profilePic").src = student.profilePic;
      // If profile is incomplete, show modal!
      if (
        showProfileModalOnEmpty &&
        (
          !student.faculty ||
          !student.department ||
          !student.username ||
          student.username === "student"
        )
      ) {
        openProfileEdit(true);
      }
    }
    // ========== PROFILE MODAL ==========
    function openProfileEdit(isInitial = false) {
      let facultyOptions = facultiesCache.map(f => `<option value="${f._id}" ${student.faculty === f.name ? "selected" : ""}>${f.name}</option>`).join('');
      let currentFacultyId = facultiesCache.find(f => f.name === student.faculty)?._id || "";
      let deptOptions = departmentsCache
        .filter(d => !currentFacultyId || d.faculty === currentFacultyId)
        .map(d => `<option value="${d._id}" ${student.department === d.name ? "selected" : ""}>${d.name}</option>`).join('');
      let html = `
        <div class="modern-modal-backdrop" onclick="closeModal(event)">
          <div class="modern-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>${isInitial ? "Complete Your Profile" : "Edit Profile"}</h3>
            <label>Username</label>
            <input id="editUsername" class="modern-input" value="${student.username || ''}" maxlength="32">
            <label>Password</label>
            <input id="editPassword" class="modern-input" type="password" placeholder="Leave blank to keep current">
            <label>Profile Picture</label>
            <input type="file" id="editProfilePicFile" accept="image/*" class="profile-img-upload" onchange="handleProfilePicUpload(event)">
            <img id="profileImgPreview" class="profile-img-preview" style="display:none">
            <input id="editProfilePic" value="${student.profilePic||''}" style="display:none;">
            <label>Faculty</label>
            <select id="editFaculty" class="modern-input" onchange="updateDeptOptions()">
              <option value="">Select Faculty</option>
              ${facultyOptions}
            </select>
            <label>Department</label>
            <select id="editDepartment" class="modern-input">
              <option value="">Select Department</option>
              ${deptOptions}
            </select>
            <button class="modern-btn" onclick="submitProfileEdit(${!!isInitial})">${isInitial ? "Save & Continue" : "Save"}</button>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
      // If a profilePic URL is present, show preview
      if (student.profilePic) {
        let img = document.getElementById("profileImgPreview");
        img.src = student.profilePic;
        img.style.display = "block";
      }
    }
    function updateDeptOptions() {
      const facultyId = document.getElementById("editFaculty").value;
      const deptSelect = document.getElementById("editDepartment");
      const filtered = departmentsCache.filter(d => d.faculty === facultyId);
      deptSelect.innerHTML = "<option value=''>Select Department</option>" + filtered.map(d =>
        `<option value="${d._id}">${d.name}</option>`
      ).join('');
    }
    function handleProfilePicUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById("profileImgPreview").src = e.target.result;
        document.getElementById("profileImgPreview").style.display = "block";
        document.getElementById("editProfilePic").value = e.target.result; // Store as data URL
      };
      reader.readAsDataURL(file);
    }
    async function submitProfileEdit(isInitial) {
      const username = document.getElementById("editUsername").value.trim();
      const password = document.getElementById("editPassword").value;
      const profilePic = document.getElementById("editProfilePic").value.trim();
      const facultyId = document.getElementById("editFaculty").value;
      const departmentId = document.getElementById("editDepartment").value;
      if (!username || !facultyId || !departmentId) return alert("All fields are required.");
      const facultyObj = facultiesCache.find(f => f._id === facultyId);
      const departmentObj = departmentsCache.find(d => d._id === departmentId);
      const payload = {
        username,
        password,
        profilePic,
        faculty: facultyObj ? facultyObj.name : "",
        department: departmentObj ? departmentObj.name : ""
      };
      const resp = await fetch(API_URL + "superadmin/me", {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        const data = await resp.json();
        alert(data.message || "Failed to update profile.");
        return;
      }
      alert("Profile updated.");
      closeModal();
      await fetchProfile(false);
      if (isInitial) {
        await fetchHistory();
        await fetchAnnouncements();
        await fetchAvailableTests();
      }
    }
    // ========== ANNOUNCEMENTS/NOTIFICATIONS ==========
    async function fetchAnnouncements() {
      const resp = await fetch(API_URL + "notifications", { headers: { Authorization: "Bearer " + token } });
      const notifs = await resp.json();
      let html = "";
      notifs.forEach(n => {
        html += `<div class="message-link" style="cursor:pointer;color:#4895ef;" onclick="openMessageModal('${n.title.replace(/'/g, "\\'")}', '${n.message.replace(/'/g, "\\'")}', '${n.createdAt}')"><strong>${n.title}:</strong> ${n.message.length>60?n.message.substring(0,57)+'...':n.message} <small style="color:#888;">(${(new Date(n.createdAt)).toLocaleString()})</small></div>`;
      });
      document.getElementById("announcementsPanel").innerHTML = html || "No new announcements.";
    }
    function openMessageModal(title, msg, date) {
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="review-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>${title}</h3>
            <div><small style="color:#4895ef">${(new Date(date)).toLocaleString()}</small></div>
            <div style="margin-top:12px;">${msg}</div>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    // ========== NOTIFICATION BELL ==========
    function toggleNotifDropdown() {
      const dd = document.getElementById("notifDropdown");
      dd.classList.toggle("active");
      if (dd.classList.contains("active")) {
        renderNotifDropdown();
        document.getElementById("notifDot").style.display = "none";
        unreadMessages = [];
      }
    }
    function renderNotifDropdown() {
      let html = "";
      if (!chatListCache.length) html = "<div style='padding:18px;text-align:center;color:#aaa;'>No new messages.</div>";
      else chatListCache.slice(0, 8).forEach(chat => {
        html += `<div class="notif-item" onclick="openChatModal('${chat.otherUserId}')">
          <div class="notif-title">${chat.otherUserName}</div>
          <div class="notif-time">${(new Date(chat.lastMsgAt)).toLocaleString()}</div>
          <div>${chat.lastMsgText ? chat.lastMsgText.substring(0, 60) : ""}</div>
        </div>`;
      });
      document.getElementById("notifDropdown").innerHTML = html;
    }
    // ========== MESSAGING ==========
    async function openChatModal(otherUserId = "") {
      if (!usersCache.length) await fetchAllUsers();
      // Prepare chat list: admins and students in department, excluding self
      const adminUsers = usersCache.filter(u => u.role === "admin" || u.role === "superadmin");
      const deptUsers = usersCache.filter(u => u.department === student.department && u.role === "student" && u._id !== student.id);
      const chatUsers = [...adminUsers, ...deptUsers];
      let listHtml = chatUsers.map(u =>
        `<div class="chat-user${otherUserId === u._id ? " active" : ""}" onclick="openChatModal('${u._id}')">${u.username} ${u.role === "admin" || u.role === "superadmin" ? "(Admin)" : ""}</div>`
      ).join('');
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="chat-modal" onclick="event.stopPropagation()">
            <div class="chat-modal-header">
              <span>Direct Messages</span>
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
            </div>
            <div class="chat-list">${listHtml}</div>
            <div class="chat-modal-body" id="chatBody"></div>
            <form class="chat-modal-footer" onsubmit="event.preventDefault(); sendChatMessage('${otherUserId}');">
              <input class="chat-input" id="chatInput" autocomplete="off" placeholder="Type a message..." />
              <button type="submit" class="chat-send-btn" id="chatSendBtn" disabled>Send</button>
            </form>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
      document.getElementById("chatInput").addEventListener("input", function() {
        document.getElementById("chatSendBtn").disabled = !this.value.trim();
      });
      if (otherUserId) fetchChatMessages(otherUserId);
      else document.getElementById("chatBody").innerHTML = '<div style="padding:30px 0;text-align:center;color:#aaa;">Select a user to chat with.</div>';
      // Poll for new messages in this chat
      if (chatPollingInterval) clearInterval(chatPollingInterval);
      if (otherUserId) {
        chatPollingInterval = setInterval(() => fetchChatMessages(otherUserId, true), 3000);
      }
    }
    async function fetchChatMessages(otherUserId, silent=false) {
      if (!otherUserId) return;
      const resp = await fetch(`${API_URL}messages/${otherUserId}`, { headers: { Authorization: "Bearer " + token } });
      const data = await resp.json();
      let html = "";
      data.forEach(msg => {
        html += `<div class="chat-message${msg.from === student.id ? " self" : ""}">
          <div class="chat-bubble">${msg.text}</div>
          <div class="chat-meta">${(new Date(msg.createdAt)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>`;
      });
      document.getElementById("chatBody").innerHTML = html || "<div style='color:#aaa;'>No messages yet.</div>";
      document.getElementById("chatBody").scrollTop = 99999;
      if (!silent) document.getElementById("chatInput").focus();
    }
    async function sendChatMessage(otherUserId) {
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      document.getElementById("chatSendBtn").disabled = true;
      await fetch(`${API_URL}messages/${otherUserId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ text })
      });
      fetchChatMessages(otherUserId);
    }
    // ========== MESSAGE POLLING FOR NOTIFICATIONS ==========
    async function pollChatsForNotifications() {
      const resp = await fetch(`${API_URL}messages/chats`, { headers: { Authorization: "Bearer " + token } });
      chatListCache = await resp.json();
      unreadMessages = chatListCache.filter(c => c.unreadCount > 0);
      document.getElementById("notifDot").style.display = unreadMessages.length ? "block" : "none";
      if (unreadMessages.length && !document.getElementById("newMsgPopup")) {
        showNewMessagePopup(unreadMessages[0]);
      }
    }
    function showNewMessagePopup(chat) {
      let html = `<div id="newMsgPopup" style="position:fixed;bottom:32px;right:34px;z-index:9999;background:#fff;padding:20px 36px;border-radius:20px;box-shadow:0 4px 22px #364fc744;">
        <b>New message from ${chat.otherUserName}</b>
        <div style="margin:9px 0 0 0;">${chat.lastMsgText?chat.lastMsgText.substring(0,90):""}</div>
        <button class="btn" onclick="openChatModal('${chat.otherUserId}');document.getElementById('newMsgPopup').remove();">View</button>
        <button class="btn" onclick="document.getElementById('newMsgPopup').remove();" style="background:#eaf1fb;color:#364fc7;">Dismiss</button>
      </div>`;
      document.body.insertAdjacentHTML("beforeend", html);
      setTimeout(() => { if (document.getElementById("newMsgPopup")) document.getElementById("newMsgPopup").remove(); }, 16000);
    }
    // ========== RECOMMENDATIONS, HISTORY, TESTS, ETC. ==========
    function recommendTopics() {
      if (!resultsCache.length || !setsCache.length) {
        document.getElementById("recommendations").innerHTML = "<li>Take more tests to receive personalized recommendations!</li>";
        return;
      }
      let lowest = resultsCache.reduce((acc, cur) => {
        if (cur.score !== undefined && cur.score !== null) {
          if (!acc[cur.examSet]) acc[cur.examSet] = [];
          acc[cur.examSet].push(cur.score);
        }
        return acc;
      }, {});
      let avgScores = Object.entries(lowest).map(([set, scores]) => ({
        set, avg: scores.reduce((a,b)=>a+b,0)/scores.length
      })).sort((a,b)=>a.avg-b.avg);
      let html = "";
      avgScores.slice(0,2).forEach(s => {
        html += `<li>Boost your grasp on <b>${s.set}</b> (avg: ${Math.round(s.avg)}%) <span class="badge">Practice</span></li>`;
      });
      if (!html) html = "<li>No recommendations. Stellar performance!</li>";
      document.getElementById("recommendations").innerHTML = html;
    }
    async function fetchHistory() {
      if (!student.id) return;
      const resp = await fetch(API_URL + "results/user/" + student.id, { headers: { Authorization: "Bearer " + token } });
      const results = await resp.json();
      resultsCache = results;
      let html = "";
      let setStats = {};
      let badgeHtml = "";
      if (results.length > 0) {
        results.forEach(r => {
          if (!setStats[r.examSet]) setStats[r.examSet] = [];
          setStats[r.examSet].push(r.score ?? 0);
        });
        if (results.length >= 5) badgeHtml += `<span class="badge">5+ Assessments</span>`;
        if (results.some(r=>r.score>=80)) badgeHtml += `<span class="badge">High Performer</span>`;
      }
      document.getElementById("badgePanel").innerHTML = badgeHtml;
      progressData.labels = Object.keys(setStats);
      progressData.values = progressData.labels.map(lbl => {
        let arr = setStats[lbl] || [];
        return arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
      });
      renderProgressChart(progressData);
      results.slice(0,10).forEach(r => {
        html += `<tr>
          <td>${r.examSet}</td>
          <td>${(new Date(r.submittedAt)).toLocaleString()}</td>
          <td>${r.score ?? "-"}</td>
          <td><button class="btn" onclick="reviewResult('${r._id}')">Review</button></td>
        </tr>`;
      });
      document.querySelector("#historyTable tbody").innerHTML = html || "<tr><td colspan=4>No history</td></tr>";
      recommendTopics();
    }
    function renderProgressChart(data) {
      const ctx = document.getElementById('progressChart').getContext('2d');
      if (window._progressChart) window._progressChart.destroy();
      window._progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: ['#4895ef', '#364fc7', '#ffe066', '#48b16f', '#f25f5c', '#6639ba']
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          cutout: "70%",
          responsive: false,
          maintainAspectRatio: false
        }
      });
    }
    async function fetchAvailableTests() {
      if (!student.faculty || !student.department) {
        document.querySelector("#availableTable tbody").innerHTML = "<tr><td colspan=3>Please complete your profile to see available assessments.</td></tr>";
        document.getElementById("upcomingTest").innerText = "None";
        document.getElementById("testCountdown").innerText = "";
        return;
      }
      const resp = await fetch(API_URL + `questionsets?faculty=${encodeURIComponent(student.faculty)}&department=${encodeURIComponent(student.department)}`,
        { headers: { Authorization: "Bearer " + token } });
      const sets = await resp.json();
      setsCache = sets;
      let html = "";
      let soonest = null;
      sets.forEach(set => {
        if (set.status !== "ACTIVE") return;
        let taken = resultsCache.some(r=>r.examSet===set.title);
        let sched = set.schedule || {};
        let now = Date.now();
        let canTake = !taken && (!sched.start || now >= new Date(sched.start).getTime());
        let btn = `<button class="btn" onclick="startTest('${set._id}')"
          ${canTake ? "" : "disabled"}>${taken ? "Completed" : "Start"}</button>`;
        html += `<tr>
          <td>${set.title}</td>
          <td>${taken ? "Completed" : (canTake ? "Available" : "Scheduled")}</td>
          <td>${btn}</td>
        </tr>`;
        if (!soonest || (sched.start && new Date(sched.start).getTime() < new Date(soonest.start).getTime())) soonest = set;
      });
      document.querySelector("#availableTable tbody").innerHTML = html || "<tr><td colspan=3>No available assessments</td></tr>";
      if (soonest && soonest.schedule && soonest.schedule.start && new Date(soonest.schedule.start).getTime() > Date.now()) {
        nextTest = soonest;
        nextTestStart = new Date(soonest.schedule.start).getTime();
        document.getElementById("upcomingTest").innerText = soonest.title;
        startCountdown();
      } else if (sets.length > 0) {
        document.getElementById("upcomingTest").innerText = sets[0].title;
        document.getElementById("testCountdown").innerText = "";
      } else {
        document.getElementById("upcomingTest").innerText = "None";
        document.getElementById("testCountdown").innerText = "";
      }
    }
    function startCountdown() {
      if (!nextTestStart) return;
      function updateCountdown() {
        let now = Date.now();
        let diff = Math.max(0, Math.floor((nextTestStart - now)/1000));
        let h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60), s = diff%60;
        document.getElementById("testCountdown").innerText =
          diff > 0 ? `Starts in ${h}h ${m}m ${s}s` : "Available now!";
        if (diff > 0) setTimeout(updateCountdown, 1000);
      }
      updateCountdown();
    }
    // ========== REVIEW ========== 
    async function reviewResult(id) {
      const resp = await fetch(API_URL + "results", { headers: { Authorization: "Bearer " + token } });
      const results = await resp.json();
      const result = results.find(r => r._id === id);
      if (!result) return alert("Result not found.");
      const setResp = await fetch(API_URL + "questionsets?title=" + encodeURIComponent(result.examSet), { headers: { Authorization: "Bearer " + token } });
      const sets = await setResp.json();
      const set = Array.isArray(sets) ? sets[0] : sets;
      if (!set) return alert("Question set not found.");
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="review-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>Review: ${set.title} (${result.score}%)</h3>
            <div style="max-height:380px; overflow-y: auto;">`;
      set.questions.forEach((q, idx) => {
        let stuAns = result.answers && result.answers[q.id];
        let correct = q.answer;
        html += `<div class="review-question">${idx+1}. ${q.question}</div>
          <div class="review-opts">Your Answer: <span class="${stuAns===correct?'review-correct':'review-wrong'}">${stuAns||'-'}</span>,
            Correct: <span class="review-correct">${correct}</span></div>
          <div class="review-expl">${q.explanation||''}</div><hr>`;
      });
      html += `</div></div></div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    function closeModal(e) {
      if (!e || e.target.classList.contains('modal-backdrop') || e.target.classList.contains('close-modal')) {
        document.getElementById("modalRoot").innerHTML = "";
        if (chatPollingInterval) clearInterval(chatPollingInterval);
      }
    }
    function startTest(setId) {
      window.location.href = `mock.html?set=${setId}`;
    }
    function openSupport() {
      window.open("mailto:support@luminaexam.com", "_blank");
    }
    function openDiscussion() {
      window.open("discussion.html", "_blank");
    }
    function downloadCertificate() {
      alert("Certificate download coming soon! (Generate PDF for passed exams)");
    }
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }
    // ========== INIT ==========
    async function init() {
      if (!token) return window.location.href = "mock-icthallb";
      await fetchFacultiesAndDepartments();
      await fetchAllUsers();
      await fetchProfile();
      await fetchHistory();
      await fetchAnnouncements();
      await fetchAvailableTests();
      pollChatsForNotifications();
      setInterval(pollChatsForNotifications, 8000);
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.notif-bell') && !e.target.closest('.notif-dropdown')) {
          document.getElementById("notifDropdown").classList.remove("active");
        }
      });
    }
    window.onload = init;
  </script>
</body>
</html>
