<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lumina Scholar Portal | LuminaExam Suite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap">
  <link rel="icon" href="lumina-logo.png">
  <style>
    :root {
      --lumina-primary: #3a86ff;
      --lumina-accent: #8338ec;
      --lumina-green: #43aa8b;
      --lumina-yellow: #ffbe0b;
      --lumina-bg: #f8faff;
      --lumina-bg-card: #f4f8fe;
      --lumina-border: #e2eafc;
      --lumina-shadow: 0 4px 24px #3a86ff15;
      --lumina-radius: 18px;
      --lumina-radius-s: 12px;
      --lumina-radius-xs: 8px;
      --lumina-dark: #264653;
      --lumina-light: #fff;
      --lumina-muted: #adb5bd;
      --lumina-gradient: linear-gradient(90deg, #3a86ff 0%, #8338ec 100%);
      --lumina-gradient-secondary: linear-gradient(90deg, #43aa8b 0%, #ffbe0b 100%);
    }
    html, body {
      background: var(--lumina-bg);
      font-family: 'Inter', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      color: var(--lumina-dark);
      letter-spacing: 0.01em;
    }
    .header {
      background: var(--lumina-gradient);
      color: var(--lumina-light);
      padding: 42px 0 30px 0;
      position: relative;
      box-shadow: 0 2px 18px #3a86ff22;
      border-bottom-left-radius: var(--lumina-radius);
      border-bottom-right-radius: var(--lumina-radius);
      text-align: center;
    }
    .header .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      justify-content: center;
      margin-bottom: 4px;
    }
    .header .brand img {
      height: 46px;
      width: 46px;
      border-radius: var(--lumina-radius-xs);
      background: #fff;
      border: 2.5px solid var(--lumina-light);
      object-fit: contain;
      box-shadow: 0 1px 10px #3a86ff19;
    }
    .header h1 {
      margin: 0 0 7px 0;
      font-size: 2.35rem;
      letter-spacing: 0.04em;
      font-weight: 800;
    }
    .header small {
      opacity: 0.94;
      font-size: 1.06em;
    }
    /* Notification */
    .notif-bell {
      position: absolute;
      top: 24px; right: 37px;
      font-size: 2.1rem;
      color: var(--lumina-yellow);
      cursor: pointer;
      z-index: 30;
      filter: drop-shadow(0 2px 2px #3a86ff22);
      transition: color 0.19s;
    }
    .notif-bell:hover { color: #fff6b7; }
    .notif-bell .notif-dot {
      position: absolute;
      top: 5px; right: 7px;
      width: 13px; height: 13px;
      background: #ff3b47;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 0 5px #ff3b4733;
    }
    .notif-dropdown {
      position: absolute;
      top: 60px;
      right: 32px;
      background: #fff;
      border-radius: var(--lumina-radius-xs);
      box-shadow: var(--lumina-shadow);
      width: 340px;
      padding: 10px 0;
      z-index: 50;
      display: none;
      border: 1.6px solid var(--lumina-border);
    }
    .notif-dropdown.active { display: block; }
    .notif-dropdown .notif-item {
      padding: 13px 22px;
      border-bottom: 1px solid #e3e8ee;
      cursor: pointer;
      background: #fff;
      transition: background 0.11s;
    }
    .notif-dropdown .notif-item:hover {
      background: var(--lumina-bg-card);
    }
    .notif-dropdown .notif-title { font-weight: 700; color: var(--lumina-primary);}
    .notif-dropdown .notif-time { color: #888; font-size: 0.95em;}
    /* Main */
    .main {
      max-width: 1200px;
      margin: 42px auto 0 auto;
      background: var(--lumina-light);
      border-radius: var(--lumina-radius);
      box-shadow: var(--lumina-shadow);
      padding: 52px 46px 55px 46px;
      position: relative;
    }
    /* Profile */
    .profile {
      display: flex;
      align-items: flex-start;
      gap: 44px;
      margin-bottom: 44px;
      border-bottom: 1.5px solid var(--lumina-border);
      padding-bottom: 24px;
      flex-wrap: wrap;
    }
    .profile-img {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100px;
      width: 100px;
      background: var(--lumina-bg-card);
      border-radius: 50%;
      box-shadow: 0 1px 8px #3a86ff18;
      margin-top: 6px;
    }
    .profile-img img {
      width: 84px;
      height: 84px;
      border-radius: 50%;
      background: #eaf1fb;
      border: 3px solid var(--lumina-primary);
      object-fit: cover;
      box-shadow: 0 2px 10px #3a86ff11;
    }
    .profile-info {
      flex: 1;
      min-width: 210px;
    }
    .profile-info h2 {
      margin: 0 0 7px 0;
      font-size: 2rem;
      font-weight: 800;
      color: var(--lumina-primary);
      letter-spacing: 0.01em;
    }
    .profile-info .meta {
      color: var(--lumina-accent);
      font-size: 1.11rem;
      margin: 4.5px 0;
      font-weight: 500;
    }
    .profile-actions {
      margin-top: 14px;
    }
    .profile-actions .btn-profile {
      background: var(--lumina-gradient);
      color: #fff;
      border: none;
      border-radius: var(--lumina-radius-xs);
      padding: 9px 26px;
      font-size: 1.11rem;
      margin-right: 13px;
      font-weight: 600;
      box-shadow: 0 1px 7px #3a86ff14;
      cursor: pointer;
      transition: background 0.18s, box-shadow 0.2s;
    }
    .profile-actions .btn-profile:hover {
      background: var(--lumina-gradient-secondary);
      color: #222;
      box-shadow: 0 2px 9px #43aa8b44;
    }
    .profile-info .support-link {
      color: var(--lumina-primary);
      text-decoration: underline;
      cursor: pointer;
      font-size: 1.08em;
      margin-top: 14px;
      display: inline-block;
      font-weight: 500;
    }
    /* Dashboard */
    .dashboard-cards {
      display: flex;
      gap: 32px;
      margin: 26px 0 18px 0;
      flex-wrap: wrap;
    }
    .dashboard-card {
      flex: 1 1 240px;
      background: var(--lumina-bg-card);
      border-radius: var(--lumina-radius-s);
      padding: 30px 20px 23px 20px;
      min-width: 190px;
      color: var(--lumina-dark);
      font-weight: 600;
      box-shadow: 0 2px 18px #3a86ff0a;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      border: 1.5px solid var(--lumina-border);
      position: relative;
      overflow: hidden;
    }
    .dashboard-card .card-title {
      font-size: 1.19rem;
      color: var(--lumina-accent);
      margin-bottom: 7px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .dashboard-card .card-value {
      font-size: 2.05rem;
      font-weight: 800;
      color: var(--lumina-primary);
    }
    .dashboard-card .cert-link {
      font-size: 1.13rem;
      color: var(--lumina-primary);
      text-decoration: underline;
      cursor: pointer;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .dashboard-card .cert-link:hover {
      color: var(--lumina-accent);
    }
    /* Recommendations (Restyled) */
    .recommend-box {
      background: var(--lumina-gradient-secondary);
      border-radius: var(--lumina-radius-s);
      padding: 0;
      margin-bottom: 30px;
      margin-top: 2px;
      box-shadow: 0 2px 16px #ffbe0b13;
      display: flex;
      align-items: stretch;
      min-height: 120px;
      overflow: hidden;
      position: relative;
    }
    .recommend-icon-area {
      background: var(--lumina-gradient);
      min-width: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 3.5rem;
      font-weight: bold;
      border-radius: var(--lumina-radius-s) 0 0 var(--lumina-radius-s);
      box-shadow: 0 2px 14px #3a86ff18;
      margin-right: 0;
      flex-shrink: 0;
    }
    .recommend-content {
      padding: 26px 34px 26px 24px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .recommend-title {
      font-weight: 800;
      color: var(--lumina-primary);
      font-size: 1.24em;
      letter-spacing: 0.01em;
      margin: 0 0 6px 0;
    }
    .recommend-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 22px 45px;
    }
    .recommend-list li {
      background: #fff;
      border-radius: var(--lumina-radius-xs);
      color: var(--lumina-dark);
      font-size: 1.07em;
      font-weight: 500;
      box-shadow: 0 1px 8px #3a86ff14;
      padding: 12px 20px 12px 16px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 120px;
      margin-top: 7px;
      border-left: 5px solid var(--lumina-primary);
      animation: fadeInUp 0.6s cubic-bezier(.23,1.01,.42,.98);
    }
    .recommend-list li .badge {
      background: var(--lumina-primary);
      color: #fff;
      font-size: 0.96em;
      border-radius: 7px;
      margin-left: 10px;
      padding: 3px 12px;
      font-weight: 600;
      box-shadow: 0 1px 5px #3a86ff19;
    }
    .recommend-list li .badge-practice {
      background: var(--lumina-accent);
      color: #fff;
    }
    .recommend-list li .badge-excellent {
      background: var(--lumina-green);
      color: #fff;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(25px);}
      to { opacity: 1; transform: translateY(0);}
    }
    /* Tables */
    .test-table, .result-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      background: var(--lumina-bg-card);
      border-radius: var(--lumina-radius-xs);
      overflow: hidden;
      box-shadow: 0 2px 9px #3a86ff0d;
    }
    .test-table th, .test-table td, .result-table th, .result-table td {
      padding: 14px 10px;
      border-bottom: 1px solid #e3e8ee;
      font-size: 1.05em;
      text-align: left;
      background: transparent;
    }
    .test-table th, .result-table th {
      background: var(--lumina-bg-card);
      color: var(--lumina-primary);
      font-size: 1.13rem;
      font-weight: 700;
      border-bottom: 2.5px solid var(--lumina-border);
    }
    .btn {
      background: var(--lumina-gradient);
      color: #fff;
      border: none;
      border-radius: var(--lumina-radius-xs);
      padding: 11px 27px;
      margin: 2px 0;
      font-size: 1.11rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 1px 6px #3a86ff15;
      transition: background 0.18s;
    }
    .btn:hover {
      background: var(--lumina-gradient-secondary);
      color: #222;
      box-shadow: 0 1px 10px #ffbe0b22;
    }
    .btn:disabled {
      background: #b1c7ee;
      cursor: not-allowed;
      color: #fff;
    }
    .announcement {
      background: #fffbec;
      border-left: 6px solid var(--lumina-yellow);
      margin: 18px 0;
      padding: 17px 30px;
      border-radius: var(--lumina-radius-xs);
      font-size: 1.14em;
      color: #b08900;
      font-weight: 600;
      box-shadow: 0 1px 9px #ffbe0b22;
    }
    .badge {
      display: inline-block;
      background: var(--lumina-green);
      color: #fff;
      font-size: 1.04rem;
      border-radius: 8px;
      padding: 3px 13px;
      margin-right: 9px;
      margin-top: 5px;
      font-weight: 700;
      box-shadow: 0 1px 8px #43aa8b22;
    }
    /* Modal */
    .modern-modal-backdrop, .modal-backdrop {
      position: fixed; top:0; left:0; width:100vw; height:100vh;
      background: rgba(58,134,255,0.13);
      z-index:1001; display: flex; align-items: center; justify-content: center;
    }
    .modern-modal, .review-modal {
      background: #fff;
      border-radius: var(--lumina-radius);
      box-shadow: 0 8px 36px #3a86ff30;
      padding: 38px 34px 29px 34px;
      max-width: 570px;
      width: 97vw;
      display: flex; flex-direction: column; align-items: flex-start;
      position: relative;
    }
    .modern-modal h3, .review-modal h3, .modern-modal h2 {
      margin: 0 0 20px 0;
      font-size: 1.48rem;
      color: var(--lumina-primary);
      font-weight: 700;
    }
    .modal-close, .close-modal {
      position: absolute; right: 19px; top: 17px;
      background: none; border: none; font-size: 2.1rem; color: #bbb; cursor: pointer;
      transition: color 0.17s;
    }
    .modal-close:hover, .close-modal:hover {
      color: #ff3b47;
    }
    .profile-img-preview { width: 74px; height: 74px; border-radius: 50%; object-fit: cover; margin-bottom: 8px;}
    .modern-input {
      width: 100%; font-size: 1.11em; margin-bottom: 16px; padding: 12px 15px;
      border: 1.7px solid #d1e4f7; border-radius: 9px; background: #f8fdff;
      outline: none; transition: border 0.2s;
    }
    .modern-input:focus { border-color: var(--lumina-primary);}
    .modern-btn {
      width: 100%; padding: 12px 0; border: none;
      background: var(--lumina-gradient);
      color: #fff; font-size: 1.13em; border-radius: 9px;
      font-weight: 700; margin-top: 8px; cursor: pointer; transition: background 0.2s;
    }
    .modern-btn:hover { background: var(--lumina-gradient-secondary); color: #222;}
    /* Review modal details */
    .review-question {
      margin-top: 13px;
      margin-bottom: 7px;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: var(--lumina-dark);
    }
    .review-opts {
      margin-left: 16px;
      font-size: 1em;
      margin-bottom: 5px;
    }
    .review-correct {
      color: var(--lumina-green);
      font-weight: 700;
    }
    .review-wrong {
      color: #ff3b47;
      font-weight: 700;
    }
    .review-expl {
      font-size: 1.03rem;
      color: var(--lumina-primary);
      background: var(--lumina-bg-card);
      border-radius: 8px;
      padding: 8px 12px;
      margin: 7px 0 10px 0;
    }
    hr {
      border: none;
      border-top: 1.2px solid var(--lumina-border);
      margin: 10px 0 8px 0;
    }
    /* Chat modal */
    .chat-modal {
      background: #fff; border-radius: var(--lumina-radius); box-shadow: 0 8px 42px #3a86ff33;
      max-width: 440px; width: 96vw; padding: 0; position: relative; display: flex; flex-direction: column; height: 90vh; max-height: 560px;
      border: 1.7px solid var(--lumina-border);
    }
    .chat-modal-header {
      background: var(--lumina-bg-card); border-bottom: 1.7px solid #e3e8ee; border-radius: var(--lumina-radius) var(--lumina-radius) 0 0;
      padding: 19px 23px; font-weight: bold; font-size: 1.19rem; color: var(--lumina-primary); display: flex; align-items: center; justify-content: space-between;
    }
    .chat-list {
      max-height: 160px; overflow-y: auto; padding: 0 20px 10px 20px; border-bottom: 1px solid #e3e8ee;
    }
    .chat-list .chat-user { padding: 9px 0; cursor:pointer; color: var(--lumina-primary);}
    .chat-list .chat-user.active { color: var(--lumina-accent); font-weight: 700; }
    .chat-modal-body { flex: 1; overflow-y: auto; padding: 18px 18px 2px 18px; background: #f7fbfd;}
    .chat-message { margin-bottom: 15px; display: flex; flex-direction: column; }
    .chat-message.self { align-items: flex-end; }
    .chat-message .chat-bubble {
      max-width: 80%; padding: 12px 18px; border-radius: 14px;
      background: #e9f3ff; color: var(--lumina-dark); margin-bottom: 2px; display: inline-block;
      font-size: 1.02em;
      box-shadow: 0 1px 7px #3a86ff0a;
    }
    .chat-message.self .chat-bubble { background: var(--lumina-primary); color: #fff; }
    .chat-message .chat-meta { font-size: 0.92em; color: #888;}
    .chat-modal-footer {
      padding: 13px 18px 17px 18px; background: #fff;
      display: flex; gap: 10px; border-radius: 0 0 var(--lumina-radius) var(--lumina-radius); border-top: 1.5px solid #e3e8ee;
    }
    .chat-input { flex: 1; border-radius: 8px; border: 1.6px solid var(--lumina-border); padding: 9px 12px; font-size: 1.07em;}
    .chat-send-btn { background: var(--lumina-primary); color: #fff; border: none; border-radius: 8px; padding: 9px 18px; font-size: 1.07em; cursor: pointer;}
    .chat-send-btn:disabled { background: #ccc; }
    /* Responsive */
    @media (max-width: 900px) {
      .main { padding: 17px 2vw; }
      .dashboard-cards { flex-direction: column; gap: 25px;}
      .profile { flex-direction: column; gap: 18px; }
      .recommend-box { flex-direction: column;}
      .recommend-icon-area { border-radius: var(--lumina-radius-s) var(--lumina-radius-s) 0 0; min-width: 100%; justify-content: flex-start; padding-left: 10vw;}
      .recommend-content { padding: 16px 10vw 20px 10vw;}
    }
    @media (max-width: 520px) {
      .header { padding: 23px 1vw 13px 1vw; }
      .main { padding: 2vw; }
      .dashboard-card { min-width: 110px; }
      .recommend-content { padding: 13px 2vw 16px 2vw;}
      .recommend-icon-area { padding-left: 0;}
    }
  </style>
</head>
<body>
  <div class="header">
    <span class="notif-bell" id="notifBell" onclick="toggleNotifDropdown()" title="Notifications">
      &#128276;
      <span id="notifDot" class="notif-dot" style="display:none"></span>
    </span>
    <div class="notif-dropdown" id="notifDropdown"></div>
    <div class="brand">
      <img src="lumina-logo.png" alt="Lumina Logo" />
      <span style="font-size:1.32em;font-weight:800;letter-spacing:0.04em;">Lumina Scholar Portal</span>
    </div>
    <h1>Welcome, <span id="studentName">Scholar</span>!</h1>
    <div><small>Faculty: <span id="studentFaculty"></span> | Department: <span id="studentDept"></span></small></div>
  </div>
  <div class="main">
    <!-- Profile section -->
    <div class="profile">
      <div class="profile-img"><img src="lumina-avatar.png" alt="Profile" id="profilePic"></div>
      <div class="profile-info">
        <h2 id="profileName">Your Name</h2>
        <div class="meta">Username: <span id="profileUser"></span></div>
        <div class="meta">Faculty: <span id="profileFaculty"></span> | Department: <span id="profileDept"></span></div>
        <div class="profile-actions">
          <button class="btn-profile" onclick="openProfileEdit()">Edit Profile</button>
          <button class="btn-profile" onclick="openChatModal()">Messages</button>
          <button class="btn-profile" onclick="logout()">Logout</button>
        </div>
        <a class="support-link" href="#" onclick="openSupport()">Need Help? Contact Support</a>
      </div>
    </div>
    <!-- Dashboard cards -->
    <div class="dashboard-cards">
      <div class="dashboard-card">
        <div class="card-title">Your Progress</div>
        <canvas id="progressChart" width="120" height="90"></canvas>
      </div>
      <div class="dashboard-card">
        <div class="card-title">Upcoming Test</div>
        <div class="card-value" id="upcomingTest">None</div>
        <div id="testCountdown" style="font-size:1.05rem; color:var(--lumina-primary);font-weight:600;"></div>
      </div>
      <div class="dashboard-card">
        <div class="card-title">Certificates</div>
        <div><span class="cert-link" onclick="downloadCertificate()">Download</span></div>
        <div id="badgePanel"></div>
      </div>
    </div>
    <!-- Recommendations (restyled) -->
    <div class="recommend-box">
      <div class="recommend-icon-area" title="Personalized Study Path">&#x1F4DA;</div>
      <div class="recommend-content">
        <div class="recommend-title">Personalized Study Recommendations</div>
        <ul class="recommend-list" id="recommendations"></ul>
      </div>
    </div>
    <!-- Announcements & Messaging -->
    <div class="announcement" id="announcementsPanel"></div>
    <!-- Test History with Review -->
    <div class="section-title">Assessment Performance & Reviews</div>
    <table class="result-table" id="historyTable">
      <thead><tr><th>Test</th><th>Date</th><th>Score</th><th>Review</th></tr></thead>
      <tbody></tbody>
    </table>
    <!-- Upcoming/scheduled tests -->
    <div class="section-title">Available Assessments</div>
    <table class="test-table" id="availableTable">
      <thead><tr><th>Test</th><th>Status</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
    <!-- Discussion/Help -->
    <div class="section-title">Need Academic Help?</div>
    <button class="btn" onclick="openDiscussion()">Go to Community Board</button>
  </div>
  <div id="modalRoot"></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // CONFIG
    const API_URL = "https://examguide.onrender.com/api/";
    const token = localStorage.getItem("token");
    let student = {};
    let progressData = { labels: [], values: [] };
    let resultsCache = [];
    let setsCache = [];
    let nextTest = null;
    let nextTestStart = null;
    let facultiesCache = [];
    let departmentsCache = [];
    let usersCache = [];
    let chatListCache = [];
    let chatPollingInterval = null;
    let unreadMessages = [];

    // ========== PROFILE / FACULTY / DEPARTMENT ==========
    async function fetchFacultiesAndDepartments() {
      const [faculties, departments] = await Promise.all([
        fetch(API_URL + "faculties", { headers: { Authorization: "Bearer " + token } }).then(r => r.json()),
        fetch(API_URL + "departments", { headers: { Authorization: "Bearer " + token } }).then(r => r.json())
      ]);
      facultiesCache = faculties;
      departmentsCache = departments;
    }
    async function fetchAllUsers() {
      const resp = await fetch(API_URL + "users", { headers: { Authorization: "Bearer " + token } });
      usersCache = await resp.json();
    }
    async function fetchProfile(showProfileModalOnEmpty = true) {
      const resp = await fetch(API_URL + "auth/me", { headers: { Authorization: "Bearer " + token } });
      const data = await resp.json();
      student = data.user;
      document.getElementById("studentName").innerText = student.username;
      document.getElementById("profileName").innerText = student.username;
      document.getElementById("profileUser").innerText = student.username;
      document.getElementById("studentFaculty").innerText = student.faculty || "-";
      document.getElementById("studentDept").innerText = student.department || "-";
      document.getElementById("profileFaculty").innerText = student.faculty || "-";
      document.getElementById("profileDept").innerText = student.department || "-";
      if (student.profilePic) document.getElementById("profilePic").src = student.profilePic;
      if (
        showProfileModalOnEmpty &&
        (
          !student.faculty ||
          !student.department ||
          !student.username ||
          student.username === "student"
        )
      ) {
        openProfileEdit(true);
      }
    }
    // ========== PROFILE MODAL ==========
    function openProfileEdit(isInitial = false) {
      let facultyOptions = facultiesCache.map(f => `<option value="${f._id}" ${student.faculty === f.name ? "selected" : ""}>${f.name}</option>`).join('');
      let currentFacultyId = facultiesCache.find(f => f.name === student.faculty)?._id || "";
      let deptOptions = departmentsCache
        .filter(d => !currentFacultyId || d.faculty === currentFacultyId)
        .map(d => `<option value="${d._id}" ${student.department === d.name ? "selected" : ""}>${d.name}</option>`).join('');
      let html = `
        <div class="modern-modal-backdrop" onclick="closeModal(event)">
          <div class="modern-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>${isInitial ? "Complete Your Profile" : "Edit Profile"}</h3>
            <label>Username</label>
            <input id="editUsername" class="modern-input" value="${student.username || ''}" maxlength="32">
            <label>Password</label>
            <input id="editPassword" class="modern-input" type="password" placeholder="Leave blank to keep current">
            <label>Profile Picture</label>
            <input type="file" id="editProfilePicFile" accept="image/*" class="profile-img-upload" onchange="handleProfilePicUpload(event)">
            <img id="profileImgPreview" class="profile-img-preview" style="display:none">
            <input id="editProfilePic" value="${student.profilePic||''}" style="display:none;">
            <label>Faculty</label>
            <select id="editFaculty" class="modern-input" onchange="updateDeptOptions()">
              <option value="">Select Faculty</option>
              ${facultyOptions}
            </select>
            <label>Department</label>
            <select id="editDepartment" class="modern-input">
              <option value="">Select Department</option>
              ${deptOptions}
            </select>
            <button class="modern-btn" onclick="submitProfileEdit(${!!isInitial})">${isInitial ? "Save & Continue" : "Save"}</button>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
      if (student.profilePic) {
        let img = document.getElementById("profileImgPreview");
        img.src = student.profilePic;
        img.style.display = "block";
      }
    }
    function updateDeptOptions() {
      const facultyId = document.getElementById("editFaculty").value;
      const deptSelect = document.getElementById("editDepartment");
      const filtered = departmentsCache.filter(d => d.faculty === facultyId);
      deptSelect.innerHTML = "<option value=''>Select Department</option>" + filtered.map(d =>
        `<option value="${d._id}">${d.name}</option>`
      ).join('');
    }
    function handleProfilePicUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById("profileImgPreview").src = e.target.result;
        document.getElementById("profileImgPreview").style.display = "block";
        document.getElementById("editProfilePic").value = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    async function submitProfileEdit(isInitial) {
      const username = document.getElementById("editUsername").value.trim();
      const password = document.getElementById("editPassword").value;
      const profilePic = document.getElementById("editProfilePic").value.trim();
      const facultyId = document.getElementById("editFaculty").value;
      const departmentId = document.getElementById("editDepartment").value;
      if (!username || !facultyId || !departmentId) return alert("All fields are required.");
      const facultyObj = facultiesCache.find(f => f._id === facultyId);
      const departmentObj = departmentsCache.find(d => d._id === departmentId);
      const payload = {
        username,
        password,
        profilePic,
        faculty: facultyObj ? facultyObj.name : "",
        department: departmentObj ? departmentObj.name : ""
      };
      const resp = await fetch(API_URL + "superadmin/me", {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        const data = await resp.json();
        alert(data.message || "Failed to update profile.");
        return;
      }
      alert("Profile updated.");
      closeModal();
      await fetchProfile(false);
      if (isInitial) {
        await fetchHistory();
        await fetchAnnouncements();
        await fetchAvailableTests();
      }
    }
    // ========== ANNOUNCEMENTS/NOTIFICATIONS ==========
    async function fetchAnnouncements() {
      const resp = await fetch(API_URL + "notifications", { headers: { Authorization: "Bearer " + token } });
      const notifs = await resp.json();
      let html = "";
      notifs.forEach(n => {
        html += `<div class="message-link" style="cursor:pointer;color:var(--lumina-primary);" onclick="openMessageModal('${n.title.replace(/'/g, "\\'")}', '${n.message.replace(/'/g, "\\'")}', '${n.createdAt}')"><strong>${n.title}:</strong> ${n.message.length>60?n.message.substring(0,57)+'...':n.message} <small style="color:#888;">(${(new Date(n.createdAt)).toLocaleString()})</small></div>`;
      });
      document.getElementById("announcementsPanel").innerHTML = html || "No new announcements.";
    }
    function openMessageModal(title, msg, date) {
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="review-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>${title}</h3>
            <div><small style="color:var(--lumina-primary)">${(new Date(date)).toLocaleString()}</small></div>
            <div style="margin-top:12px;">${msg}</div>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    // ========== NOTIFICATION BELL ==========
    function toggleNotifDropdown() {
      const dd = document.getElementById("notifDropdown");
      dd.classList.toggle("active");
      if (dd.classList.contains("active")) {
        renderNotifDropdown();
        document.getElementById("notifDot").style.display = "none";
        unreadMessages = [];
      }
    }
    function renderNotifDropdown() {
      let html = "";
      if (!chatListCache.length) html = "<div style='padding:18px;text-align:center;color:#aaa;'>No new messages.</div>";
      else chatListCache.slice(0, 8).forEach(chat => {
        html += `<div class="notif-item" onclick="openChatModal('${chat.otherUserId}')">
          <div class="notif-title">${chat.otherUserName}</div>
          <div class="notif-time">${(new Date(chat.lastMsgAt)).toLocaleString()}</div>
          <div>${chat.lastMsgText ? chat.lastMsgText.substring(0, 60) : ""}</div>
        </div>`;
      });
      document.getElementById("notifDropdown").innerHTML = html;
    }
    // ========== MESSAGING ==========
    async function openChatModal(otherUserId = "") {
      if (!usersCache.length) await fetchAllUsers();
      const adminUsers = usersCache.filter(u => u.role === "admin" || u.role === "superadmin");
      const deptUsers = usersCache.filter(u => u.department === student.department && u.role === "student" && u._id !== student.id);
      const chatUsers = [...adminUsers, ...deptUsers];
      let listHtml = chatUsers.map(u =>
        `<div class="chat-user${otherUserId === u._id ? " active" : ""}" onclick="openChatModal('${u._id}')">${u.username} ${u.role === "admin" || u.role === "superadmin" ? "(Admin)" : ""}</div>`
      ).join('');
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="chat-modal" onclick="event.stopPropagation()">
            <div class="chat-modal-header">
              <span>Direct Messages</span>
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
            </div>
            <div class="chat-list">${listHtml}</div>
            <div class="chat-modal-body" id="chatBody"></div>
            <form class="chat-modal-footer" onsubmit="event.preventDefault(); sendChatMessage('${otherUserId}');">
              <input class="chat-input" id="chatInput" autocomplete="off" placeholder="Type a message..." />
              <button type="submit" class="chat-send-btn" id="chatSendBtn" disabled>Send</button>
            </form>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
      document.getElementById("chatInput").addEventListener("input", function() {
        document.getElementById("chatSendBtn").disabled = !this.value.trim();
      });
      if (otherUserId) fetchChatMessages(otherUserId);
      else document.getElementById("chatBody").innerHTML = '<div style="padding:30px 0;text-align:center;color:#aaa;">Select a user to chat with.</div>';
      if (chatPollingInterval) clearInterval(chatPollingInterval);
      if (otherUserId) {
        chatPollingInterval = setInterval(() => fetchChatMessages(otherUserId, true), 3000);
      }
    }
    async function fetchChatMessages(otherUserId, silent=false) {
      if (!otherUserId) return;
      const resp = await fetch(`${API_URL}messages/${otherUserId}`, { headers: { Authorization: "Bearer " + token } });
      const data = await resp.json();
      let html = "";
      data.forEach(msg => {
        html += `<div class="chat-message${msg.from === student.id ? " self" : ""}">
          <div class="chat-bubble">${msg.text}</div>
          <div class="chat-meta">${(new Date(msg.createdAt)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>`;
      });
      document.getElementById("chatBody").innerHTML = html || "<div style='color:#aaa;'>No messages yet.</div>";
      document.getElementById("chatBody").scrollTop = 99999;
      if (!silent) document.getElementById("chatInput").focus();
    }
    async function sendChatMessage(otherUserId) {
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      document.getElementById("chatSendBtn").disabled = true;
      await fetch(`${API_URL}messages/${otherUserId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ text })
      });
      fetchChatMessages(otherUserId);
    }
    // ========== MESSAGE POLLING FOR NOTIFICATIONS ==========
    async function pollChatsForNotifications() {
      const resp = await fetch(`${API_URL}messages/chats`, { headers: { Authorization: "Bearer " + token } });
      chatListCache = await resp.json();
      unreadMessages = chatListCache.filter(c => c.unreadCount > 0);
      document.getElementById("notifDot").style.display = unreadMessages.length ? "block" : "none";
      if (unreadMessages.length && !document.getElementById("newMsgPopup")) {
        showNewMessagePopup(unreadMessages[0]);
      }
    }
    function showNewMessagePopup(chat) {
      let html = `<div id="newMsgPopup" style="position:fixed;bottom:32px;right:34px;z-index:9999;background:#fff;padding:22px 40px;border-radius:20px;box-shadow:0 4px 22px #3a86ff44;">
        <b>New message from ${chat.otherUserName}</b>
        <div style="margin:11px 0 0 0;">${chat.lastMsgText?chat.lastMsgText.substring(0,90):""}</div>
        <button class="btn" onclick="openChatModal('${chat.otherUserId}');document.getElementById('newMsgPopup').remove();">View</button>
        <button class="btn" onclick="document.getElementById('newMsgPopup').remove();" style="background:#f4f8fe;color:var(--lumina-primary);">Dismiss</button>
      </div>`;
      document.body.insertAdjacentHTML("beforeend", html);
      setTimeout(() => { if (document.getElementById("newMsgPopup")) document.getElementById("newMsgPopup").remove(); }, 16000);
    }
    // ========== RECOMMENDATIONS, HISTORY, TESTS, ETC. ==========
    function recommendTopics() {
      const list = document.getElementById("recommendations");
      if (!resultsCache.length || !setsCache.length) {
        list.innerHTML = `<li><span style="color:var(--lumina-muted);font-style:italic;">Take more assessments to receive tailored recommendations!</span></li>`;
        return;
      }
      let lowest = resultsCache.reduce((acc, cur) => {
        if (cur.score !== undefined && cur.score !== null) {
          if (!acc[cur.examSet]) acc[cur.examSet] = [];
          acc[cur.examSet].push(cur.score);
        }
        return acc;
      }, {});
      let avgScores = Object.entries(lowest).map(([set, scores]) => ({
        set, avg: scores.reduce((a,b)=>a+b,0)/scores.length
      })).sort((a,b)=>a.avg-b.avg);
      let html = "";
      if (avgScores.length > 0) {
        avgScores.slice(0,2).forEach(s => {
          html += `<li>
            <span>Focus on <b>${s.set}</b> (avg: ${Math.round(s.avg)}%)</span>
            <span class="badge badge-practice">Practice</span>
          </li>`;
        });
        avgScores.filter(s => s.avg >= 80).slice(0,1).forEach(s => {
          html += `<li>
            <span>Great job on <b>${s.set}</b>!</span>
            <span class="badge badge-excellent">Excellent</span>
          </li>`;
        });
      }
      if (!html) html = `<li><span style="color:var(--lumina-muted);font-style:italic;">No recommendations. Stellar performance!</span></li>`;
      list.innerHTML = html;
    }
    async function fetchHistory() {
      if (!student.id) return;
      const resp = await fetch(API_URL + "results/user/" + student.id, { headers: { Authorization: "Bearer " + token } });
      const results = await resp.json();
      resultsCache = results;
      let html = "";
      let setStats = {};
      let badgeHtml = "";
      if (results.length > 0) {
        results.forEach(r => {
          if (!setStats[r.examSet]) setStats[r.examSet] = [];
          setStats[r.examSet].push(r.score ?? 0);
        });
        if (results.length >= 5) badgeHtml += `<span class="badge">5+ Assessments</span>`;
        if (results.some(r=>r.score>=80)) badgeHtml += `<span class="badge">High Performer</span>`;
      }
      document.getElementById("badgePanel").innerHTML = badgeHtml;
      progressData.labels = Object.keys(setStats);
      progressData.values = progressData.labels.map(lbl => {
        let arr = setStats[lbl] || [];
        return arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
      });
      renderProgressChart(progressData);
      results.slice(0,10).forEach(r => {
        html += `<tr>
          <td>${r.examSet}</td>
          <td>${(new Date(r.submittedAt)).toLocaleString()}</td>
          <td>${r.score ?? "-"}</td>
          <td><button class="btn" onclick="reviewResult('${r._id}')">Review</button></td>
        </tr>`;
      });
      document.querySelector("#historyTable tbody").innerHTML = html || "<tr><td colspan=4>No history</td></tr>";
      recommendTopics();
    }
    function renderProgressChart(data) {
      const ctx = document.getElementById('progressChart').getContext('2d');
      if (window._progressChart) window._progressChart.destroy();
      window._progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: ['#3a86ff', '#8338ec', '#ffbe0b', '#43aa8b', '#f25f5c', '#6639ba']
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          cutout: "70%",
          responsive: false,
          maintainAspectRatio: false
        }
      });
    }
    async function fetchAvailableTests() {
      if (!student.faculty || !student.department) {
        document.querySelector("#availableTable tbody").innerHTML = "<tr><td colspan=3>Please complete your profile to see available assessments.</td></tr>";
        document.getElementById("upcomingTest").innerText = "None";
        document.getElementById("testCountdown").innerText = "";
        return;
      }
      const resp = await fetch(API_URL + `questionsets?faculty=${encodeURIComponent(student.faculty)}&department=${encodeURIComponent(student.department)}`,
        { headers: { Authorization: "Bearer " + token } });
      const sets = await resp.json();
      setsCache = sets;
      let html = "";
      let soonest = null;
      sets.forEach(set => {
        if (set.status !== "ACTIVE") return;
        let taken = resultsCache.some(r=>r.examSet===set.title);
        let sched = set.schedule || {};
        let now = Date.now();
        let canTake = !taken && (!sched.start || now >= new Date(sched.start).getTime());
        let btn = `<button class="btn" onclick="startTest('${set._id}')"
          ${canTake ? "" : "disabled"}>${taken ? "Completed" : "Start"}</button>`;
        html += `<tr>
          <td>${set.title}</td>
          <td>${taken ? "Completed" : (canTake ? "Available" : "Scheduled")}</td>
          <td>${btn}</td>
        </tr>`;
        if (!soonest || (sched.start && new Date(sched.start).getTime() < new Date(soonest.start).getTime())) soonest = set;
      });
      document.querySelector("#availableTable tbody").innerHTML = html || "<tr><td colspan=3>No available assessments</td></tr>";
      if (soonest && soonest.schedule && soonest.schedule.start && new Date(soonest.schedule.start).getTime() > Date.now()) {
        nextTest = soonest;
        nextTestStart = new Date(soonest.schedule.start).getTime();
        document.getElementById("upcomingTest").innerText = soonest.title;
        startCountdown();
      } else if (sets.length > 0) {
        document.getElementById("upcomingTest").innerText = sets[0].title;
        document.getElementById("testCountdown").innerText = "";
      } else {
        document.getElementById("upcomingTest").innerText = "None";
        document.getElementById("testCountdown").innerText = "";
      }
    }
    function startCountdown() {
      if (!nextTestStart) return;
      function updateCountdown() {
        let now = Date.now();
        let diff = Math.max(0, Math.floor((nextTestStart - now)/1000));
        let h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60), s = diff%60;
        document.getElementById("testCountdown").innerText =
          diff > 0 ? `Starts in ${h}h ${m}m ${s}s` : "Available now!";
        if (diff > 0) setTimeout(updateCountdown, 1000);
      }
      updateCountdown();
    }
    // ========== REVIEW ========== 
    async function reviewResult(id) {
      const resp = await fetch(API_URL + "results", { headers: { Authorization: "Bearer " + token } });
      const results = await resp.json();
      const result = results.find(r => r._id === id);
      if (!result) return alert("Result not found.");
      const setResp = await fetch(API_URL + "questionsets?title=" + encodeURIComponent(result.examSet), { headers: { Authorization: "Bearer " + token } });
      const sets = await setResp.json();
      const set = Array.isArray(sets) ? sets[0] : sets;
      if (!set) return alert("Question set not found.");
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="review-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>Review: ${set.title} (${result.score}%)</h3>
            <div style="max-height:380px; overflow-y: auto;">`;
      set.questions.forEach((q, idx) => {
        let stuAns = result.answers && result.answers[q.id];
        let correct = q.answer;
        html += `<div class="review-question">${idx+1}. ${q.question}</div>
          <div class="review-opts">Your Answer: <span class="${stuAns===correct?'review-correct':'review-wrong'}">${stuAns||'-'}</span>,
            Correct: <span class="review-correct">${correct}</span></div>
          <div class="review-expl">${q.explanation||''}</div><hr>`;
      });
      html += `</div></div></div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    function closeModal(e) {
      if (!e || e.target.classList.contains('modal-backdrop') || e.target.classList.contains('close-modal')) {
        document.getElementById("modalRoot").innerHTML = "";
        if (chatPollingInterval) clearInterval(chatPollingInterval);
      }
    }
    function startTest(setId) {
      window.location.href = `mock.html?set=${setId}`;
    }
    function openSupport() {
      window.open("mailto:support@luminaexam.com", "_blank");
    }
    function openDiscussion() {
      window.open("discussion.html", "_blank");
    }
    function downloadCertificate() {
      alert("Certificate download coming soon! (Generate PDF for passed exams)");
    }
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }
    // ========== INIT ==========
    async function init() {
      if (!token) return window.location.href = "mock-icthallb";
      await fetchFacultiesAndDepartments();
      await fetchAllUsers();
      await fetchProfile();
      await fetchHistory();
      await fetchAnnouncements();
      await fetchAvailableTests();
      pollChatsForNotifications();
      setInterval(pollChatsForNotifications, 8000);
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.notif-bell') && !e.target.closest('.notif-dropdown')) {
          document.getElementById("notifDropdown").classList.remove("active");
        }
      });
    }
    window.onload = init;
  </script>
</body>
</html>
