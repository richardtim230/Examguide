<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Central Mock Portal | OAUExam Suite</title>
  <meta name="viewport" content="width=device-width, initial-scale=0.79" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,600,800&display=swap">
  <link rel="icon" href="logo.png">
<link rel="stylesheet" href="./dashboard.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Great+Vibes&display=swap');
/* You can include this in your <style> or dashboard.css for certificate styling */

#certificateTemplate, #certificateContent {
  font-family: 'Montserrat', sans-serif !important;
    }
/* Add this to your dashboard.css or in a <style> tag */
.scoreboard-container {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 2px 18px #3a86ff18;
  padding: 24px 0 18px 0;
  margin: 28px auto 18px auto;
  max-width: 440px;
}
.scoreboard-title {
  text-align: center;
  font-size: 1.25rem;
  font-weight: bold;
  color: #23366e;
  margin-bottom: 10px;
  letter-spacing: 0.5px;
}
.scoreboard-list {
  display: flex;
  justify-content: space-around;
  align-items: flex-end;
  gap: 16px;
}
.scoreboard-item {
  background: #f7faff;
  border-radius: 14px;
  padding: 10px 16px;
  text-align: center;
  box-shadow: 0 2px 8px #3a86ff11;
  min-width: 90px;
  position: relative;
}
.scoreboard-item .scoreboard-rank {
  font-size: 1.1em;
  font-weight: bold;
  color: #3a86ff;
  margin-bottom: 4px;
}
.scoreboard-avatar {
  width: 48px; height: 48px; border-radius: 50%; object-fit: cover; margin-bottom: 4px;
  border: 2px solid #3a86ff33;
}
.scoreboard-name {
  font-size: 1.07em;
  font-weight: 600;
  color: #23366e;
}
.scoreboard-score {
  font-size: 1.01em;
  color: #455c8a;
  margin-top: 3px;
}
.scoreboard-badge {
  display: inline-block;
  font-size: 1.36em;
  margin-top: 6px;
}
.badge-rank-1 { color: #f7b500; }
.badge-rank-2 { color: #a8b0b8; }
.badge-rank-3 { color: #c47c39; }
  .modal-backdrop {
  position: fixed; inset: 0; z-index: 2000;
  background: rgba(58,134,255,0.13);
  display: flex; align-items: center; justify-content: center;
}
.modal {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 8px 36px #0002;
  animation: popIn 0.22s;
}
@keyframes popIn {
  from { transform: scale(0.92) translateY(30px); opacity: 0.3;}
  to { transform: scale(1) translateY(0); opacity: 1;}
}
.btn {
  background: #3a86ff;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 1.07em;
  font-weight: 700;
  padding: 12px 0;
  cursor: pointer;
  transition: background 0.15s;
}
.btn:hover { filter: brightness(1.08); }
.close-modal {
  background: none;
  border: none;
  font-size: 2em;
  color: #888;
  cursor: pointer;
}
 
.result-table, .test-table {
  width: 95%;
  border-collapse: separate;
  border-spacing: 0;
  background: #fff;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 2px 16px #3a86ff18;
  margin: 14px 0 22px 0;
  font-size: 1.06rem;
  min-width: 340px;
}

.result-table thead tr, .test-table thead tr {
  background: linear-gradient(90deg, #3a86ff 60%, #4cc9f0 100%);
  color: #fff;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.result-table th, .result-table td,
.test-table th, .test-table td {
  padding: 11px 14px;
  text-align: left;
  border-bottom: 1px solid #e3e8ee;
}

.result-table th:last-child, .result-table td:last-child,
.test-table th:last-child, .test-table td:last-child {
  text-align: center;
}

.result-table tbody tr, .test-table tbody tr {
  transition: background 0.18s;
}

.result-table tbody tr:nth-child(even),
.test-table tbody tr:nth-child(even) {
  background: #f7faff;
}

.result-table tbody tr:hover,
.test-table tbody tr:hover {
  background: #e3f0ff;
}

.result-table td, .test-table td {
  color: #23366e;
}

.result-table td button,
.test-table td button,
.test-table td .btn {
  background: linear-gradient(90deg, #3a86ff 60%, #4cc9f0 100%);
  color: #fff;
  border: none;
  border-radius: 7px;
  padding: 7px 18px;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.15s, box-shadow 0.18s;
  font-weight: 600;
  box-shadow: 0 2px 7px #3a86ff22;
}
.result-table td button:hover,
.test-table td button:hover,
.test-table td .btn:hover {
  background: linear-gradient(90deg, #4cc9f0 0%, #3a86ff 100%);
  color: #fff;
}

/* Responsive: horizontal scroll on small screens */
@media (max-width: 800px) {
  .result-table, .test-table {
    font-size: 0.99rem;
    min-width: 390px;
    width: 100%;
    display: block;
    overflow-x: auto;
  }
  .result-table thead, .test-table thead {
    display: table-header-group;
  }
}

/* Optional: Add a subtle border radius to the first/last cell */
.result-table th:first-child, .result-table td:first-child,
.test-table th:first-child, .test-table td:first-child {
  border-top-left-radius: 12px;
}
.result-table th:last-child, .result-table td:last-child,
.test-table th:last-child, .test-table td:last-child {
  border-top-right-radius: 12px;
}

/* Optional: Style empty table rows (no data) */
.result-table tbody tr:only-child td,
.test-table tbody tr:only-child td {
  text-align: center;
  color: #888;
  font-style: italic;
  background: #f8faff;
}

/* Utility: .table-responsive wrapper for scrollable tables */
.table-responsive {
  width: 100%;
  overflow-x: auto;
  margin: 0;
  border-radius: 14px;
}
  </style>
</head>
<body>
  <!-- Place this at the very top inside your <body> -->
<div id="preloaderSpinner" style="
  position:fixed;z-index:99999;top:0;left:0;width:100vw;height:100vh;
  background:rgba(255,255,255,0.97);display:flex;align-items:center;justify-content:center;
  transition:opacity 0.3s;
">
  <div style="text-align:center;">
    <div style="
      display:inline-block;width:80px;height:80px;border:8px solid #e3e8ee;
      border-top:8px solid #3a86ff;border-radius:50%;animation:spin 1s linear infinite;
    "></div>
    <div style="margin-top:18px;color:#3a86ff;font-weight:700;font-size:1.3em;">Loading dashboard...</div>
  </div>
</div>
<style>
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
  <div class="header">
  <span class="notif-bell" id="notifBell" onclick="toggleNotifDropdown()" title="Notifications">
    &#128276;
    <span id="notifDot" class="notif-dot"></span>
  </span>
  <div class="notif-dropdown" id="notifDropdown"></div>
  <div class="brand">
    <img src="logo.png" alt="OAU Logo" onerror="this.style.display='none'"/>
    <span class="brand-title">CENTRAL MOCK PLATFORM</span>
  </div>
  <h1>Welcome, <span id="studentName">Scholar</span>!</h1>
  <div class="student-info">
    <small>Faculty: <span id="studentFaculty"></span> | Department: <span id="studentDept"></span></small>
  </div>
      </div>
  
  <div class="main">
    <!-- Profile section -->
    <div class="profile">
      <div class="profile-img">
        <img src="lumina-avatar.png" alt="Profile" id="profilePic" onerror="this.src='https://ui-avatars.com/api/?name=Scholar&background=3a86ff&color=fff&rounded=true';"/>
      </div>
      <div class="profile-info">
        <h2 id="profileName">Your Name</h2>
        <div class="meta">Username: <span id="profileUser"></span></div>
        <div class="meta">Faculty: <span id="profileFaculty"></span> | Department: <span id="profileDept"></span></div>
        <div class="profile-actions">
          <button class="btn-profile" onclick="openProfileEdit()">Edit Profile</button>
          <button class="btn-profile" onclick="window.open('chat.html', '_blank', 'noopener'); return false;">
  Messages
</button>
          <button class="btn-profile" onclick="logout()">Logout</button>
        </div>
        <a class="support-link" href="#" onclick="openSupport()">Need Help? Contact Support</a>
      </div>
          </div>
    <!-- Dashboard cards -->
    <div class="dashboard-card">
  <div class="card-title">Your Progress</div>
  <div id="progressList" style="max-height:110px;overflow-y:auto;"></div>
</div>
      <div class="dashboard-card">
        <div class="card-title">Upcoming Test</div>
        <div class="card-value" id="upcomingTest">None</div>
        <div id="testCountdown" style="font-size:1.01rem; color:var(--primary);font-weight:600;"></div>
      </div>
      <div class="dashboard-card">
        <div class="card-title">Certificates</div>
        <div><span class="cert-link" onclick="downloadCertificate()">Download</span></div>
        <div id="badgePanel"></div>
      </div>
    
    <!-- Recommendations (restyled) -->
    <div class="recommend-box">
      <div class="recommend-icon-area" title="Personalized Study Path">&#x1F4DA;</div>
      <div class="recommend-content">
        <div class="recommend-title">Personalized Study Recommendations</div>
        <ul class="recommend-list" id="recommendations"></ul>
      </div>
    </div>
  <!-- Place this in your HTML, ideally inside <body> or as the last child, or just copy the style to your main style -->
<template id="scheduleModalTemplate">
  <div class="schedule-modal-backdrop" onclick="closeModal(event)">
    <div class="schedule-modal" onclick="event.stopPropagation()">
      <button class="schedule-modal-close" onclick="closeModal(event)" title="Close">&times;</button>
      <div class="schedule-cover">
        <img src="close-up-african-graduate-student-with-books_380164-231442.jpg" alt="Schedule Cover" class="schedule-cover-img" />
        <div class="schedule-cover-overlay">
          <div class="schedule-main-title">Current Scheduled Assessment</div>
        </div>
      </div>
      <div class="schedule-content">
        <div class="schedule-info">
          <div class="schedule-title" id="schedTitle">Test Title Here</div>
          <div class="schedule-desc" id="schedDesc">Short description about the test or any important info for the candidate goes here.</div>
          <div class="schedule-detail-grid">
            <div>
              <span class="sched-label">Start:</span>
              <span id="schedStart">-</span>
            </div>
            <div>
              <span class="sched-label">End:</span>
              <span id="schedEnd">-</span>
            </div>
            <div>
              <span class="sched-label">Status:</span>
              <span id="schedStatus">-</span>
            </div>
          </div>
        </div>
        <div id="schedStartBtnWrap" style="text-align:center;margin-top:2em;">
          <button class="schedule-start-btn" id="schedStartBtn" style="display:none;" onclick="startTest(currentSchedId);">Start Assessment</button>
        </div>
      </div>
    </div>
  </div>
</template>

<style>
.schedule-modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(58,134,255,0.21);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.schedule-modal {
  width: 80vw;
  max-width: 700px;
  min-width: 320px;
  max-height: 85vh;
  background: #fff;
  border-radius: 22px;
  box-shadow: 0 10px 45px #3a86ff33;
  overflow: hidden;
  position: relative;
  display: flex;
  flex-direction: column;
  animation: popIn 0.22s;
}
@keyframes popIn {
  from { transform: scale(0.92) translateY(30px); opacity: 0.3;}
  to { transform: scale(1) translateY(0); opacity: 1;}
}
.schedule-modal-close {
  position: absolute;
  top: 13px;
  right: 20px;
  background: none;
  border: none;
  font-size: 2.2rem;
  color: #fff;
  z-index: 11;
  cursor: pointer;
  opacity: 0.93;
  transition: color 0.17s;
}
.schedule-modal-close:hover { color: var(--danger);}
.schedule-cover {
  position: relative;
  width: 100%;
  height: 180px;
  background: #e7f0fa;
  overflow: hidden;
  display: flex;
  align-items: flex-end;
  border-bottom-left-radius: 22px;
  border-bottom-right-radius: 22px;
}
.schedule-cover-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: brightness(0.92) blur(0.5px);
  pointer-events: none;
  user-select: none;
}
.schedule-cover-overlay {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  padding: 0 0 22px 0;
  background: linear-gradient(0deg, #3a86ffbb 60%, #3a86ff11 95%);
  color: #fff;
  width: 100%;
  text-align: center;
}
.schedule-main-title {
  font-size: 1.4rem;
  font-weight: 800;
  letter-spacing: 0.03em;
  text-shadow: 0 2px 15px #3a86ff66;
}
.schedule-content {
  padding: 30px 6vw 34px 6vw;
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: space-between;
}
.schedule-info {
  margin-top: 12px;
  margin-bottom: 8px;
}
.schedule-title {
  font-size: 1.17rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 8px;
}
.schedule-desc {
  color: #455c8a;
  font-size: 1.02em;
  margin-bottom: 16px;
}
.schedule-detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  background: #f8faff;
  border-radius: 12px;
  padding: 16px 10px;
  margin-bottom: 9px;
  font-size: 1.03em;
  color: #354a6c;
  font-weight: 600;
}
.sched-label {
  color: var(--accent);
  font-weight: 700;
  margin-right: 5px;
}
.schedule-start-btn {
  margin: 0 auto;
  display: inline-block;
  padding: 13px 44px;
  font-size: 1.13rem;
  font-weight: 700;
  border-radius: 12px;
  background: var(--gradient);
  color: #fff;
  border: none;
  box-shadow: 0 4px 15px #3a86ff15;
  cursor: pointer;
  transition: background 0.18s, color 0.18s;
}
.schedule-start-btn:hover {
  background: var(--gradient-accent);
  color: #23366e;
}
@media (max-width: 900px) {
  .schedule-modal { width: 95vw; }
}
@media (max-width: 650px) {
  .schedule-modal { width: 98vw; min-width: 0; }
  .schedule-content { padding: 18px 2vw 16px 2vw;}
  .schedule-cover { height: 120px; }
  .schedule-main-title { font-size: 1.02rem;}
  .schedule-modal-close { font-size: 2rem; right: 13px; }
}
</style>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Great+Vibes&display=swap" rel="stylesheet">
<!-- Redesigned Certificate Template for Exams -->
<div id="certificateTemplate" style="display:none;position:fixed;top:-9999px;left:-9999px;width:1200px;height:850px;background:#fff;">
  <div id="certificateContent"
       style="width:1200px;height:850px;position:relative;font-family:'Montserrat',sans-serif;background:#fff;overflow:hidden;">
    <!-- Top Purple/Gold Wave SVG -->
    <svg width="1200" height="220" viewBox="0 0 1200 220" style="position:absolute;top:0;left:0;z-index:1;">
      <defs>
        <linearGradient id="wave1" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#8928ad"/>
          <stop offset="50%" stop-color="#c7148f"/>
          <stop offset="100%" stop-color="#ffe082"/>
        </linearGradient>
      </defs>
      <path d="M0,0 Q400,60 800,0 Q1000,-20 1200,40 L1200,220 L0,220 Z"
            fill="url(#wave1)"/>
    </svg>
    <!-- Best Award Badge -->
    <div style="position:absolute;top:55px;right:100px;z-index:2;">
      <svg width="150" height="150" viewBox="0 0 150 150">
        <defs>
          <radialGradient id="badgeGold" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#fffde4"/>
            <stop offset="50%" stop-color="#ffe082"/>
            <stop offset="100%" stop-color="#bfa043"/>
          </radialGradient>
        </defs>
        <circle cx="75" cy="75" r="65" fill="url(#badgeGold)" stroke="#bfa043" stroke-width="6"/>
        <circle cx="75" cy="75" r="52" fill="none" stroke="#bfa043" stroke-width="2" opacity="0.56"/>
      </svg>
      <div style="position:absolute;top:0;left:0;width:150px;height:150px;display:flex;align-items:center;justify-content:center;">
        <span style="font-family:'Montserrat',sans-serif;font-size:1.45em;font-weight:900;color:#7a5700;text-align:center;">
          TOP<br/>SCORE
        </span>
      </div>
    </div>
    <!-- Main Certificate Content -->
    <div style="position:relative;z-index:3;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
      <!-- Title -->
      <div style="margin-top:110px;font-size:3.2rem;font-weight:900;letter-spacing:7px;color:#8928ad;text-align:center;">
        CERTIFICATE
      </div>
      <div style="font-size:2.0rem;font-weight:900;letter-spacing:2px;color:#222;margin-top:10px;margin-bottom:30px;text-transform:uppercase;">
        <span style="color:#232323;">OF</span> <span style="color:#232323;">ACHIEVEMENT</span>
      </div>
      <!-- Certificate text -->
      <div style="font-size:1.25rem;color:#232323;margin-bottom:15px;">
        This is to certify that
      </div>
      <!-- Student Name -->
      <div id="certStudentName"
           style="font-family:'Great Vibes',cursive;font-size:2.6rem;font-weight:400;color:#8928ad;padding:0 20px;text-align:center;margin-bottom:10px;border-bottom:2.5px solid #222;min-width:360px;max-width:700px;">
      </div>
      <!-- Participation text/description -->
      <div id="certAwardText"
           style="font-size:1.16rem;color:#232323;max-width:820px;margin-bottom:38px;text-align:center;">
        has successfully participated in the <span id="certExamTitle"></span> conducted by <span id="certHost"></span> 
        <span id="certScoreText"></span>
      </div>
      <!-- Optional: extra info -->
      <div id="certExtra" style="font-size:1.06rem;color:#555;margin-bottom:20px;"></div>
      <!-- Signature/Date -->
      <div style="display:flex;justify-content:space-between;width:70%;margin-top:60px;">
        <div style="text-align:center;width:260px;">
          <div style="border-top:2.3px solid #222;width:100px;margin:0 auto 8px auto;"></div>
          <div style="font-size:1.1rem;color:#232323;">Signature</div>
        </div>
        <div style="text-align:center;width:260px;">
          <div style="border-top:2.3px solid #222;width:100px;margin:0 auto 8px auto;"></div>
          <div style="font-size:1.1rem;color:#232323;">Date: <span id="certDate"></span></div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Add html2canvas from CDN before closing </body> -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


<!-- Place this wherever you want the leaderboard to appear, e.g. middle of .main -->
<div id="leaderboardContainer" class="scoreboard-container"></div>


    <!-- Announcements & Messaging -->
    <div class="announcement" id="announcementsPanel"></div>
    <!-- Test History with Review -->
<!-- ...existing HTML... -->

<!-- Assessment Performance & Reviews -->
<div class="section-title">Assessment Performance & Reviews</div>
<div class="result-table-container">
  <table class="result-table" id="historyTable">
    <thead>
      <tr>
        <th>Test</th>
        <th>Date</th>
        <th>Score</th>
        <th>
          Review 
        </th>
      </tr>
    </thead>
    <tbody>
      <!-- Populated by JS -->
    </tbody>
  </table>
  <div id="historyPagination" class="table-pagination"></div>
</div>

<!-- Upcoming/scheduled tests -->
<div class="section-title">Available Assessments</div>
<div id="testSpinner" style="display:none;text-align:center;padding:20px;">
  <div style="display:inline-block;width:38px;height:38px;border:4px solid #e3e8ee;border-top:4px solid #3a86ff;border-radius:50%;animation:spin 1s linear infinite;"></div>
</div>
<div class="table-responsive">
  <table class="test-table" id="availableTable">
    <thead>
      <tr>
        <th>Test</th>
        <th>Description</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="availablePagination" class="table-pagination"></div>
</div>

<!-- ...rest of HTML ... -->

<style>
.table-pagination {
  text-align: center;
  margin: 12px 0 0 0;
  user-select: none;
}
.table-pagination button {
  margin: 0 5px;
  padding: 4px 13px;
  font-size: 1em;
  background: #f7faff;
  color: #3a86ff;
  border: 1px solid #3a86ff44;
  border-radius: 7px;
  cursor: pointer;
  transition: background 0.13s;
}
.table-pagination button.active,
.table-pagination button:hover {
  background: #3a86ff;
  color: #fff;
}
.table-pagination button[disabled] {
  opacity: 0.6;
  cursor: not-allowed;
  background: #e3e8ee !important;
  color: #888 !important;
}
</style>
    <!-- Discussion/Help -->
    <div class="section-title">Need Academic Help?</div>
    <button class="btn" onclick="openDiscussion()">Go to Community Board</button>
  </div>
  <div id="modalRoot"></div>
  <div id="refreshSpinner" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(255,255,255,0.9);align-items:center;justify-content:center;">
  <div style="border:8px solid #f3f3f3;border-top:8px solid #3a86ff;border-radius:50%;width:60px;height:60px;animation:spin 1.1s linear infinite;"></div>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
(function() {
  const spinner = document.getElementById("preloaderSpinner");
  let spinnerCanHide = false;
  let dataLoaded = false;

  // Hide spinner helper (safe for multiple calls)
  function hideSpinner() {
    if (spinner && spinner.style.display !== "none") {
      spinner.style.opacity = "0";
      setTimeout(() => { spinner.style.display = "none"; }, 350);
    }
  }

  // Minimum spinner duration: 10 seconds
  setTimeout(() => {
    spinnerCanHide = true;
    if (dataLoaded) hideSpinner();
  }, 10000);

  // Patch your main init() function to call this when all data is ready!
  window.hidePreloaderSpinner = function() {
    dataLoaded = true;
    if (spinnerCanHide) hideSpinner();
    // else: spinner auto-hides after the 10s timeout
  }
})();
    // Place this at the VERY TOP of your main JS file, before any fetches are made

// Save the original fetch function
const originalFetch = window.fetch;

// Utility: Force logout and redirect
function forceLogout() {
  localStorage.removeItem("token");
  window.location.href = "mock-icthallb"; // Replace with your login page if different
}

// Patch global fetch
window.fetch = async function(resource, options = {}) {
  // Always add Authorization header if token exists and not already set
  const token = localStorage.getItem("token");
  if (token && resource && typeof resource === "string" && resource.startsWith("http")) {
    options.headers = options.headers || {};
    if (!options.headers["Authorization"] && !options.headers["authorization"]) {
      options.headers["Authorization"] = "Bearer " + token;
    }
  }

  try {
    const response = await originalFetch(resource, options);

    // If unauthorized, force logout
    if (response.status === 401 || response.status === 403) {
      forceLogout();
      // Optionally: throw error to stop further code
      throw new Error("Session expired. Logging out...");
    }
    return response;
  } catch (err) {
    // If fetch itself fails (e.g., network down), you can also force logout if desired
    // forceLogout();
    throw err;
  }
};
    // CONFIG
    const API_URL = "https://examguide.onrender.com/api/";
    const token = localStorage.getItem("token");
    let student = {};
    let progressData = { labels: [], values: [] };
    let resultsCache = [];
    let setsCache = [];
    let nextTest = null;
    let nextTestStart = null;
    let facultiesCache = [];
    let departmentsCache = [];
    let usersCache = [];
    let chatListCache = [];
    let chatPollingInterval = null;
    let unreadMessages = [];

    // ========== PROFILE / FACULTY / DEPARTMENT ==========
    async function fetchFacultiesAndDepartments() {
      const [faculties, departments] = await Promise.all([
        fetch(API_URL + "faculties", { headers: { Authorization: "Bearer " + token } }).then(r => r.json()),
        fetch(API_URL + "departments", { headers: { Authorization: "Bearer " + token } }).then(r => r.json())
      ]);
      facultiesCache = faculties;
      departmentsCache = departments;
    }
    async function fetchAllUsers() {
      const resp = await fetch(API_URL + "users", { headers: { Authorization: "Bearer " + token } });
      usersCache = await resp.json();
    }
  async function fetchProfile(showProfileModalOnEmpty = true) {
  const resp = await fetch(API_URL + "auth/me", { headers: { Authorization: "Bearer " + token } });
  const data = await resp.json();
  student = data.user;
  student.id = student._id || student.id; // Ensure ID is set
  // Match by name to get the ObjectId (for faculty and department)
  const facultyObj = facultiesCache.find(f => f.name === student.faculty);
  const departmentObj = departmentsCache.find(d => d.name === student.department);
  student.facultyId = facultyObj ? facultyObj._id : "";
  student.departmentId = departmentObj ? departmentObj._id : "";

  document.getElementById("studentName").innerText = student.username;
  document.getElementById("profileName").innerText = student.username;
  document.getElementById("profileUser").innerText = student.username;
  document.getElementById("studentFaculty").innerText = student.faculty || "-";
  document.getElementById("studentDept").innerText = student.department || "-";
  document.getElementById("profileFaculty").innerText = student.faculty || "-";
  document.getElementById("profileDept").innerText = student.department || "-";
  if (student.profilePic) document.getElementById("profilePic").src = student.profilePic;
  else document.getElementById("profilePic").src = `https://ui-avatars.com/api/?name=${encodeURIComponent(student.username || 'Scholar')}&background=3a86ff&color=fff&rounded=true`;
  if (
    showProfileModalOnEmpty &&
    (
      !student.faculty ||
      !student.department ||
      !student.username ||
      student.username === "student"
    )
  ) {
    openProfileEdit(true);
  }
}
    function autoRefreshWithSpinner(timeoutMs=1200) {
  const spinner = document.getElementById("refreshSpinner");
  if (spinner) {
    spinner.style.display = "flex";
    setTimeout(() => {
      location.reload();
    }, timeoutMs);
  } else {
    // Fallback: just reload
    location.reload();
  }
    }

    async function checkForBroadcast() {
  try {
    const resp = await fetch(API_URL + "broadcasts/latest", {
      headers: { Authorization: "Bearer " + token }
    });
    const b = await resp.json();
    if (!b || b.seenBy?.includes(student.id)) return; // Already seen
    showBroadcastPopup(b);
  } catch {}
}

function showBroadcastPopup(broadcast) {
  // Modal style similar to provided image
  let color = {
    info: "#3a86ff", 
    success: "#43aa8b", 
    warning: "#ffb300", 
    danger: "#ff3b47"
  }[broadcast.type || "info"];
  
  document.getElementById("modalRoot").innerHTML = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:380px;border-radius:18px;box-shadow:0 6px 32px #0003;padding:0;">
        <div style="background:${color};padding:14px 24px;border-top-left-radius:18px;border-top-right-radius:18px;color:#fff;font-weight:700;font-size:1.18em;">
          ${broadcast.title}
          <button class="close-modal" onclick="closeModal(event)" style="float:right;background:none;border:none;font-size:1.7em;color:#fff;opacity:0.83;">&times;</button>
        </div>
        <div style="padding:22px 18px;">
          ${broadcast.imageUrl ? `<img src="${broadcast.imageUrl}" alt="info" style="max-width:100%;border-radius:8px;margin-bottom:14px;">` : ""}
          <div style="font-size:1.07em;margin-bottom:12px;white-space:pre-wrap;">${broadcast.message}</div>
          ${broadcast.link ? `<a href="${broadcast.link}" target="_blank" style="color:${color};text-decoration:underline;font-size:1.05em;">Read more</a><br>` : ""}
          <button class="btn" style="width:100%;margin-top:18px;background:${color};" onclick="ackBroadcast('${broadcast._id}')">OK, Got it</button>
        </div>
      </div>
    </div>`;
}

async function ackBroadcast(id) {
  await fetch(API_URL + "broadcasts/ack/" + id, {
    method: "POST",
    headers: { Authorization: "Bearer " + token }
  });
  closeModal();
}

// Call this on dashboard page load
window.addEventListener("load", checkForBroadcast);
    // ========== PROFILE MODAL ==========
    function openProfileEdit(isInitial = false) {
      let facultyOptions = facultiesCache.map(f => `<option value="${f._id}" ${student.faculty === f.name ? "selected" : ""}>${f.name}</option>`).join('');
      let currentFacultyId = facultiesCache.find(f => f.name === student.faculty)?._id || "";
      let deptOptions = departmentsCache
        .filter(d => !currentFacultyId || d.faculty === currentFacultyId)
        .map(d => `<option value="${d._id}" ${student.department === d.name ? "selected" : ""}>${d.name}</option>`).join('');
      let html = `
        <div class="modern-modal-backdrop" onclick="closeModal(event)">
          <div class="modern-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>${isInitial ? "Complete Your Profile" : "Edit Profile"}</h3>
            <label>Username</label>
            <input id="editUsername" class="modern-input" value="${student.username || ''}" maxlength="32">
            <label>Password</label>
            <input id="editPassword" class="modern-input" type="password" placeholder="Leave blank to keep current">
            <label>Profile Picture</label>
            <input type="file" id="editProfilePicFile" accept="image/*" class="profile-img-upload" onchange="handleProfilePicUpload(event)">
            <img id="profileImgPreview" class="profile-img-preview" style="display:none">
            <input id="editProfilePic" value="${student.profilePic||''}" style="display:none;">
            <label>Faculty</label>
            <select id="editFaculty" class="modern-input" onchange="updateDeptOptions()">
              <option value="">Select Faculty</option>
              ${facultyOptions}
            </select>
            <label>Department</label>
            <select id="editDepartment" class="modern-input">
              <option value="">Select Department</option>
              ${deptOptions}
            </select>
            <button class="modern-btn" onclick="submitProfileEdit(${!!isInitial})">${isInitial ? "Save & Continue" : "Save"}</button>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
      if (student.profilePic) {
        let img = document.getElementById("profileImgPreview");
        img.src = student.profilePic;
        img.style.display = "block";
      }
    }
    function updateDeptOptions() {
      const facultyId = document.getElementById("editFaculty").value;
      const deptSelect = document.getElementById("editDepartment");
      const filtered = departmentsCache.filter(d => d.faculty === facultyId);
      deptSelect.innerHTML = "<option value=''>Select Department</option>" + filtered.map(d =>
        `<option value="${d._id}">${d.name}</option>`
      ).join('');
    }
    function handleProfilePicUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById("profileImgPreview").src = e.target.result;
        document.getElementById("profileImgPreview").style.display = "block";
        document.getElementById("editProfilePic").value = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    async function submitProfileEdit(isInitial) {
      const username = document.getElementById("editUsername").value.trim();
      const password = document.getElementById("editPassword").value;
      const profilePic = document.getElementById("editProfilePic").value.trim();
      const facultyId = document.getElementById("editFaculty").value;
      const departmentId = document.getElementById("editDepartment").value;
      if (!username || !facultyId || !departmentId) return alert("All fields are required.");
      const facultyObj = facultiesCache.find(f => f._id === facultyId);
      const departmentObj = departmentsCache.find(d => d._id === departmentId);
      const payload = {
        username,
        password,
        profilePic,
        faculty: facultyObj ? facultyObj.name : "",
        department: departmentObj ? departmentObj.name : ""
      };
      const resp = await fetch(API_URL + "superadmin/me", {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        const data = await resp.json();
        alert(data.message || "Failed to update profile.");
        return;
      }
      alert("Profile updated.");
closeModal();
autoRefreshWithSpinner(1200); // 1.2 seconds spinner before reload
    }
    // ========== ANNOUNCEMENTS/NOTIFICATIONS ==========
    async function fetchAnnouncements() {
      const resp = await fetch(API_URL + "notifications", { headers: { Authorization: "Bearer " + token } });
      const notifs = await resp.json();
      let html = "";
      notifs.forEach(n => {
        html += `<div class="message-link" style="cursor:pointer;color:var(--primary);" onclick="openMessageModal('${n.title.replace(/'/g, "\\'")}', '${n.message.replace(/'/g, "\\'")}', '${n.createdAt}')"><strong>${n.title}:</strong> ${n.message.length>60?n.message.substring(0,57)+'...':n.message} <small style="color:#888;">(${(new Date(n.createdAt)).toLocaleString()})</small></div>`;
      });
      document.getElementById("announcementsPanel").innerHTML = html || "No new announcements.";
    }
    function openMessageModal(title, msg, date) {
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="review-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>${title}</h3>
            <div><small style="color:var(--primary)">${(new Date(date)).toLocaleString()}</small></div>
            <div style="margin-top:12px;">${msg}</div>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    // ========== NOTIFICATION BELL ==========
    function toggleNotifDropdown() {
      const dd = document.getElementById("notifDropdown");
      dd.classList.toggle("active");
      if (dd.classList.contains("active")) {
        renderNotifDropdown();
        document.getElementById("notifDot").style.display = "none";
        unreadMessages = [];
      }
    }
    function renderNotifDropdown() {
      let html = "";
      if (!chatListCache.length) html = "<div style='padding:18px;text-align:center;color:#aaa;'>No new messages.</div>";
      else chatListCache.slice(0, 8).forEach(chat => {
        html += `<div class="notif-item" onclick="openChatModal('${chat.otherUserId}')">
          <div class="notif-title">${chat.otherUserName}</div>
          <div class="notif-time">${(new Date(chat.lastMsgAt)).toLocaleString()}</div>
          <div>${chat.lastMsgText ? chat.lastMsgText.substring(0, 60) : ""}</div>
        </div>`;
      });
      document.getElementById("notifDropdown").innerHTML = html;
    }
    // ========== MESSAGING ==========
    async function openChatModal(otherUserId = "") {
  // Ensure user data is loaded
  if (!student.id) await fetchProfile(false);
  if (!usersCache.length) await fetchAllUsers();

  // Find students in same department, excluding current user
  const deptStudents = usersCache.filter(
    u => u.role === "student" && u.department === student.department && u._id !== student.id
  );

  // Optionally show admins
  const adminUsers = usersCache.filter(u => u.role === "admin" || u.role === "superadmin");

  // Build student list
  let studentListHtml = deptStudents.length
    ? deptStudents.map(u => `
        <div class="chat-user${otherUserId === u._id ? " active" : ""}" 
             onclick="openChatModal('${u._id}')">
          <span>${u.username}</span>
        </div>
      `).join('')
    : `<div style="padding:10px;color:#aaa;">No other students in your department.</div>`;

  let adminListHtml = adminUsers.length
    ? `<div style="margin-top:12px;font-weight:700;color:var(--accent);">Admins</div>` +
      adminUsers.map(u => `
        <div class="chat-user${otherUserId === u._id ? " active" : ""}" 
             onclick="openChatModal('${u._id}')">
          <span>${u.username}</span> <span style="font-size:0.93em;color:var(--accent);">(Admin)</span>
        </div>
      `).join('')
    : "";

  let html = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="chat-modal" onclick="event.stopPropagation()">
        <div class="chat-modal-header">
          <span>Direct Messages</span>
          <button class="close-modal" onclick="closeModal(event)">&times;</button>
        </div>
        <div style="padding:10px;">
          <div style="font-weight:700;color:var(--primary-dark);margin-bottom:4px;">Students in your Department</div>
          <div class="chat-list">${studentListHtml}</div>
          ${adminListHtml ? `<div class="chat-list">${adminListHtml}</div>` : ""}
        </div>
        <div class="chat-modal-body" id="chatBody"></div>
        <form class="chat-modal-footer" onsubmit="event.preventDefault(); sendChatMessage('${otherUserId}');">
          <input class="chat-input" id="chatInput" autocomplete="off" placeholder="Type a message..." />
          <button type="submit" class="chat-send-btn" id="chatSendBtn" disabled>Send</button>
        </form>
      </div>
    </div>
  `;
  document.getElementById("modalRoot").innerHTML = html;

  // Enable send button only if input is not empty
  document.getElementById("chatInput").addEventListener("input", function() {
    document.getElementById("chatSendBtn").disabled = !this.value.trim();
  });

  // Load chat if a user is selected, else show instructions
  if (otherUserId) fetchChatMessages(otherUserId);
  else document.getElementById("chatBody").innerHTML =
    '<div style="padding:40px;text-align:center;color:#aaa;">Select a student to start chatting.</div>';

  // Poll for messages if user is selected
  if (chatPollingInterval) clearInterval(chatPollingInterval);
  if (otherUserId) {
    chatPollingInterval = setInterval(() => fetchChatMessages(otherUserId, true), 3000);
  }
}
    async function fetchChatMessages(otherUserId, silent=false) {
      if (!otherUserId) return;
      const resp = await fetch(`${API_URL}messages/${otherUserId}`, { headers: { Authorization: "Bearer " + token } });
      const data = await resp.json();
      let html = "";
      data.forEach(msg => {
        html += `<div class="chat-message${msg.from === student.id ? " self" : ""}">
          <div class="chat-bubble">${msg.text}</div>
          <div class="chat-meta">${(new Date(msg.createdAt)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>`;
      });
      document.getElementById("chatBody").innerHTML = html || "<div style='color:#aaa;'>No messages yet.</div>";
      document.getElementById("chatBody").scrollTop = 99999;
      if (!silent) document.getElementById("chatInput").focus();
    }
    async function sendChatMessage(otherUserId) {
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      document.getElementById("chatSendBtn").disabled = true;
      await fetch(`${API_URL}messages/${otherUserId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ text })
      });
      fetchChatMessages(otherUserId);
    }
    // ========== MESSAGE POLLING FOR NOTIFICATIONS ==========
    async function pollChatsForNotifications() {
      const resp = await fetch(`${API_URL}messages/chats`, { headers: { Authorization: "Bearer " + token } });
      chatListCache = await resp.json();
      unreadMessages = chatListCache.filter(c => c.unreadCount > 0);
      document.getElementById("notifDot").style.display = unreadMessages.length ? "block" : "none";
      if (unreadMessages.length && !document.getElementById("newMsgPopup")) {
        showNewMessagePopup(unreadMessages[0]);
      }
    }
    function showNewMessagePopup(chat) {
      let html = `<div id="newMsgPopup" style="position:fixed;bottom:32px;right:16px;z-index:9999;background:#fff;padding:18px 26px;border-radius:18px;box-shadow:0 4px 22px #3a86ff44;">
        <b>New message from ${chat.otherUserName}</b>
        <div style="margin:8px 0 0 0;">${chat.lastMsgText?chat.lastMsgText.substring(0,90):""}</div>
        <button class="btn" onclick="openChatModal('${chat.otherUserId}');document.getElementById('newMsgPopup').remove();">View</button>
        <button class="btn" onclick="document.getElementById('newMsgPopup').remove();" style="background:#f4f8fe;color:var(--primary);">Dismiss</button>
      </div>`;
      document.body.insertAdjacentHTML("beforeend", html);
      setTimeout(() => { if (document.getElementById("newMsgPopup")) document.getElementById("newMsgPopup").remove(); }, 16000);
    }
    // ========== RECOMMENDATIONS, HISTORY, TESTS, ETC. ==========
    function recommendTopics() {
      const list = document.getElementById("recommendations");
      if (!resultsCache.length || !setsCache.length) {
        list.innerHTML = `<li><span style="color:var(--muted);font-style:italic;">Take more assessments to receive tailored recommendations!</span></li>`;
        return;
      }
      let lowest = resultsCache.reduce((acc, cur) => {
        if (cur.score !== undefined && cur.score !== null) {
          if (!acc[cur.examSet]) acc[cur.examSet] = [];
          acc[cur.examSet].push(cur.score);
        }
        return acc;
      }, {});
      let avgScores = Object.entries(lowest).map(([set, scores]) => ({
        set, avg: scores.reduce((a,b)=>a+b,0)/scores.length
      })).sort((a,b)=>a.avg-b.avg);
      let html = "";
      if (avgScores.length > 0) {
        avgScores.slice(0,2).forEach(s => {
          html += `<li>
            <span>Focus on <b>${s.set}</b> (avg: ${Math.round(s.avg)}%)</span>
            <span class="badge">Practice</span>
          </li>`;
        });
        avgScores.filter(s => s.avg >= 80).slice(0,1).forEach(s => {
          html += `<li>
            <span>Great job on <b>${s.set}</b>!</span>
            <span class="badge badge-excellent">Excellent</span>
          </li>`;
        });
      }
      if (!html) html = `<li><span style="color:var(--muted);font-style:italic;">No recommendations. Stellar performance!</span></li>`;
      list.innerHTML = html;
    }

   
    // Place after all previous JS, or in existing <script> blocks

// ===== PAGINATION GLOBALS =====
const HISTORY_PAGE_SIZE = 5;
const AVAILABLE_PAGE_SIZE = 5;
let historyPage = 1;
let availablePage = 1;
let availableSchedulesCache = []; // stores uniqueSchedules (for Available Assessments)

// ===== PAGINATION CONTROLS BUILDER =====
function buildPagination(total, page, pageSize, onPageChangeFnName, targetDivId) {
  const totalPages = Math.ceil(total / pageSize);
  if (totalPages <= 1) {
    document.getElementById(targetDivId).innerHTML = '';
    return;
  }
  let html = '';
  html += `<button onclick="${onPageChangeFnName}(1)" ${page === 1 ? 'disabled' : ''}>First</button>`;
  html += `<button onclick="${onPageChangeFnName}(${page - 1})" ${page === 1 ? 'disabled' : ''}>&lt;</button>`;
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || Math.abs(page - i) <= 2) {
      html += `<button onclick="${onPageChangeFnName}(${i})" ${page === i ? 'class="active"' : ''}>${i}</button>`;
    } else if (i === page - 3 || i === page + 3) {
      html += '<span style="margin:0 5px;">...</span>';
    }
  }
  html += `<button onclick="${onPageChangeFnName}(${page + 1})" ${page === totalPages ? 'disabled' : ''}>&gt;</button>`;
  html += `<button onclick="${onPageChangeFnName}(${totalPages})" ${page === totalPages ? 'disabled' : ''}>Last</button>`;
  document.getElementById(targetDivId).innerHTML = html;
}

// ======= HISTORY TABLE PAGINATION =======
function renderHistoryTablePage(page) {
  if (!Array.isArray(resultsCache)) return;
  historyPage = page;
  const tbody = document.querySelector("#historyTable tbody");
  const start = (page - 1) * HISTORY_PAGE_SIZE;
  const end = start + HISTORY_PAGE_SIZE;

  let html = "";
  resultsCache.slice(start, end).forEach(r => {
    const examTitle =
      r.examSet && typeof r.examSet === "object"
        ? (r.examSet.title || "")
        : ""; // fallback to empty string, never show ID
    html += `<tr>
      <td>${examTitle}</td>
      <td>${(new Date(r.submittedAt)).toLocaleString()}</td>
      <td>${r.score ?? "-"}</td>
      <td><button class="btn" onclick="openReviewTab('${r._id}')">Review</button></td>
    </tr>`;
  });
  tbody.innerHTML = html || "<tr><td colspan=4>No history</td></tr>";

  // Pagination controls
  buildPagination(resultsCache.length, page, HISTORY_PAGE_SIZE, 'renderHistoryTablePage', 'historyPagination');
}

// Override fetchHistory to use pagination
async function fetchHistory() {
  if (!student.id) return;
  const resp = await fetch(API_URL + "results/user/" + student.id, { headers: { Authorization: "Bearer " + token } });
  const results = await resp.json();
  resultsCache = results;
  renderHistoryTablePage(1); // Show first page
  renderProgressList();
  recommendTopics();
}

// ======= AVAILABLE ASSESSMENTS PAGINATION =======
function renderAvailableTablePage(page) {
  availablePage = page;
  const tbody = document.querySelector("#availableTable tbody");
  const start = (page - 1) * AVAILABLE_PAGE_SIZE;
  const end = start + AVAILABLE_PAGE_SIZE;
  let html = "";

  if (!Array.isArray(availableSchedulesCache) || availableSchedulesCache.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999;">
      No available assessments at this time.</td></tr>`;
    buildPagination(0, 1, AVAILABLE_PAGE_SIZE, 'renderAvailableTablePage', 'availablePagination');
    return;
  }

  const now = Date.now();
  availableSchedulesCache.slice(start, end).forEach((sched) => {
    const set = sched.examSet;
    if (!set || set.status !== "ACTIVE") return;
    const taken = resultsCache.some((r) => r.examSet === set.title);
    const startDt = sched.start ? new Date(sched.start) : null;
    const endDt = sched.end ? new Date(sched.end) : null;
    const canTake =
      !taken &&
      set.status === "ACTIVE" &&
      startDt &&
      now >= startDt.getTime() &&
      (!endDt || now <= endDt.getTime());

    const isScheduled = startDt && now < startDt.getTime();

    let statusLabel = taken
      ? "Completed"
      : canTake
      ? "Available"
      : isScheduled
      ? "Scheduled"
      : "Closed";

    let btnHtml = canTake
      ? `<button class="btn" onclick="startTest('${set._id}')">Start</button>`
      : taken
      ? `<span style="color:var(--muted);">Completed</span>`
      : isScheduled
      ? `<span style="color:var(--muted);">Not Yet Open</span>`
      : `<span style="color:var(--muted);">Closed</span>`;

    html += `<tr>
      <td>${set.title}</td>
      <td>${set.description ? set.description : "-"}</td>
      <td>${startDt ? startDt.toLocaleString() : "-"}</td>
      <td>${endDt ? endDt.toLocaleString() : "-"}</td>
      <td>${statusLabel}</td>
      <td>${btnHtml}</td>
    </tr>`;
  });

  tbody.innerHTML = html || `<tr><td colspan="6" style="text-align:center;color:#999;">
    No available assessments at this time.</td></tr>`;

  buildPagination(availableSchedulesCache.length, page, AVAILABLE_PAGE_SIZE, 'renderAvailableTablePage', 'availablePagination');
}

// Override fetchAvailableTests to cache schedules and use pagination
async function fetchAvailableTests() {
  const spinner = document.getElementById("testSpinner");
  const tbody = document.querySelector("#availableTable tbody");
  spinner.style.display = "block";
  tbody.innerHTML = "";

  try {
    if (!student.faculty || !student.department) {
      spinner.style.display = "none";
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999;">
        Please complete your profile to see available assessments.</td></tr>`;
      document.getElementById("upcomingTest").innerText = "None";
      document.getElementById("testCountdown").innerText = "";
      buildPagination(0, 1, AVAILABLE_PAGE_SIZE, 'renderAvailableTablePage', 'availablePagination');
      return;
    }

    const resp = await fetch(
      API_URL +
        `schedules?faculty=${student.facultyId}&department=${student.departmentId}`,
      { headers: { Authorization: "Bearer " + token } }
    );
    const schedules = await resp.json();
    spinner.style.display = "none";

    // Remove Duplicate Schedules, use examSet._id or title
    const uniqueSchedules = [];
    const seenExamSetIds = new Set();
    for (const sched of schedules) {
      const set = sched.examSet;
      if (!set) continue;
      const key = set._id || set.title;
      if (!key || seenExamSetIds.has(key)) continue;
      seenExamSetIds.add(key);
      uniqueSchedules.push(sched);
    }
    availableSchedulesCache = uniqueSchedules;
    renderAvailableTablePage(1); // Show first page

    // Handle upcoming test display & countdown (reuse as in your original code)
    let soonest = null;
    const now = Date.now();
    uniqueSchedules.forEach((sched) => {
      const set = sched.examSet;
      if (!set || set.status !== "ACTIVE") return;
      const taken = resultsCache.some((r) => r.examSet === set.title);
      const start = sched.start ? new Date(sched.start) : null;
      if (
        set.status === "ACTIVE" &&
        !taken &&
        start &&
        now < start.getTime() &&
        (!soonest || start.getTime() < new Date(soonest.start).getTime())
      ) {
        soonest = { ...sched, examSet: set };
      }
    });

    if (
      soonest &&
      soonest.start &&
      new Date(soonest.start).getTime() > now &&
      soonest.examSet
    ) {
      nextTest = soonest.examSet;
      nextTestStart = new Date(soonest.start).getTime();
      document.getElementById("upcomingTest").innerText = soonest.examSet.title;
      startCountdown();
    } else if (uniqueSchedules.length > 0) {
      const firstAvailable = uniqueSchedules.find(
        (sched) => sched.examSet && sched.examSet.status === "ACTIVE"
      );
      if (firstAvailable && firstAvailable.examSet)
        document.getElementById("upcomingTest").innerText =
          firstAvailable.examSet.title;
      else document.getElementById("upcomingTest").innerText = "None";
      document.getElementById("testCountdown").innerText = "";
    } else {
      document.getElementById("upcomingTest").innerText = "None";
      document.getElementById("testCountdown").innerText = "";
    }

  } catch (err) {
    spinner.style.display = "none";
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#f25f5c;">
      Failed to load assessments.</td></tr>`;
    document.getElementById("upcomingTest").innerText = "None";
    document.getElementById("testCountdown").innerText = "";
    buildPagination(0, 1, AVAILABLE_PAGE_SIZE, 'renderAvailableTablePage', 'availablePagination');
  }
}
    function renderProgressList() {
  const list = document.getElementById("progressList");
  if (!resultsCache.length) {
    list.innerHTML = `<div style="color:var(--muted);font-style:italic;">No exams taken yet.</div>`;
    return;
  }
  const items = resultsCache
    .sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt))
    .slice(0, 7)
    .map(r =>
      `<div style="padding:6px 0;border-bottom:1px solid #e3e8ee;">
        <b>${r.examSet && r.examSet.title ? r.examSet.title : r.examSet}</b> 
        <span style="color:var(--primary);font-weight:700;">${r.score ?? '-'}</span>%
        <span style="color:#888;font-size:0.95em;float:right;">${(new Date(r.submittedAt)).toLocaleDateString()}</span>
      </div>`
    ).join('');
  list.innerHTML = items;
}
    
async function fetchHistory() {
  if (!student.id) return;
  const resp = await fetch(API_URL + "results/user/" + student.id, { headers: { Authorization: "Bearer " + token } });
  const results = await resp.json();
  resultsCache = results;

  // Update Progress Card
  renderProgressList();



  // Update Assessment Performance Table
  let html = "";
  results.slice(0, 10).forEach(r => {
    const examTitle =
  r.examSet && typeof r.examSet === "object"
    ? (r.examSet.title || "")
    : ""; // fallback to empty string, never show ID
  html += `<tr>
    <td>${examTitle}</td>
    <td>${(new Date(r.submittedAt)).toLocaleString()}</td>
    <td>${r.score ?? "-"}</td>
    <td><button class="btn" onclick="openReviewTab('${r._id}')">Review</button></td>
  </tr>`;
});
  document.querySelector("#historyTable tbody").innerHTML = html || "<tr><td colspan=4>No history</td></tr>";

  recommendTopics();
}
    function openReviewTab(sessionId) {
  window.open('review.html?session=' + encodeURIComponent(sessionId), '_blank');
    }
  
    
  function startCountdown() {
  const countdownEl = document.getElementById("testCountdown");
  const testTitleEl = document.getElementById("upcomingTest");
  if (!nextTestStart || !countdownEl || !testTitleEl) return;

  function updateCountdown() {
    const now = Date.now();
    const diff = nextTestStart - now;
    if (diff <= 0) {
      countdownEl.innerText = "Test is now available!";
      testTitleEl.innerText = nextTest.title + " (Now Available)";
      clearInterval(timer);
      return;
    }
    // Calculate time parts
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    let text = "";
    if (hours > 0) text += hours + "h ";
    if (hours > 0 || minutes > 0) text += minutes + "m ";
    text += seconds + "s";
    countdownEl.innerText = "Starts in " + text;
  }

  // Initial call and set interval
  updateCountdown();
  const timer = setInterval(updateCountdown, 1000);
}

  
    // ========== REVIEW ========== 
    async function reviewResult(id) {
      const resp = await fetch(API_URL + "results", { headers: { Authorization: "Bearer " + token } });
      const results = await resp.json();
      const result = results.find(r => r._id === id);
      if (!result) return alert("Result not found.");
      const setResp = await fetch(API_URL + "questionsets?title=" + encodeURIComponent(result.examSet), { headers: { Authorization: "Bearer " + token } });
      const sets = await setResp.json();
      const set = Array.isArray(sets) ? sets[0] : sets;
      if (!set) return alert("Question set not found.");
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="review-modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h3>Review: ${set.title} (${result.score}%)</h3>
            <div style="max-height:280px; overflow-y: auto;">`;
      set.questions.forEach((q, idx) => {
        let stuAns = result.answers && result.answers[q.id];
        let correct = q.answer;
        html += `<div class="review-question">${idx+1}. ${q.question}</div>
          <div class="review-opts">Your Answer: <span class="${stuAns===correct?'review-correct':'review-wrong'}">${stuAns||'-'}</span>,
            Correct: <span class="review-correct">${correct}</span></div>
          <div class="review-expl">${q.explanation||''}</div><hr>`;
      });
      html += `</div></div></div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    function closeModal(e) {
      if (!e || e.target.classList.contains('modal-backdrop') || e.target.classList.contains('close-modal')) {
        document.getElementById("modalRoot").innerHTML = "";
        if (chatPollingInterval) clearInterval(chatPollingInterval);
      }
    }
    function startTest(examSetId) {
  window.location.href = `test.html?examSet=${encodeURIComponent(examSetId)}`;
}
    
    function openSupport() {
      window.open("mailto:richardochuko14@gmail.com", "_blank");
    }
    function openDiscussion() {
      window.open("discussion.html", "_blank");
    }
    
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "mock-icthallb";
    }

  function closeModal(e) {
  // If called programmatically or from a close button/backdrop, close modalRoot
  if (
    !e ||
    (e.target &&
      (
        e.target.classList.contains('modal-backdrop') ||
        e.target.classList.contains('close-modal') ||
        e.target.classList.contains('schedule-modal-backdrop') ||
        e.target.classList.contains('schedule-modal-close')
      )
    )
  ) {
    document.getElementById("modalRoot").innerHTML = "";
    if (typeof chatPollingInterval !== "undefined" && chatPollingInterval) clearInterval(chatPollingInterval);
  }
}
    

// Utility to show modal and fill info
function showScheduleModal(schedule) {
  currentSchedId = schedule.examSet._id;
  const template = document.getElementById("scheduleModalTemplate");
  if (!template) return;
  document.getElementById("modalRoot").innerHTML = "";
  document.getElementById("modalRoot").appendChild(template.content.cloneNode(true));

  // Fill modal info
  document.getElementById("schedTitle").innerText = schedule.examSet.title || "-";
  document.getElementById("schedDesc").innerText = schedule.examSet.description || "No description provided.";
  document.getElementById("schedStart").innerText = schedule.start ? new Date(schedule.start).toLocaleString() : "-";
  document.getElementById("schedEnd").innerText = schedule.end ? new Date(schedule.end).toLocaleString() : "-";
  // Status logic
  const now = Date.now();
  let status = "Closed";
  if (schedule.examSet.status === "ACTIVE") {
    if (schedule.start && now < new Date(schedule.start).getTime()) status = "Scheduled";
    else if (
      schedule.start &&
      schedule.end &&
      now >= new Date(schedule.start).getTime() &&
      now <= new Date(schedule.end).getTime()
    ) status = "Available";
    else if (schedule.end && now > new Date(schedule.end).getTime()) status = "Closed";
  }
  document.getElementById("schedStatus").innerText = status;

  // Show/hide start button
  const taken = window.resultsCache?.some(r => (r.examSet === (schedule.examSet.title || schedule.examSet._id)));
  if (
    status === "Available" &&
    !taken
  ) {
    document.getElementById("schedStartBtn").style.display = "inline-block";
  } else {
    document.getElementById("schedStartBtn").style.display = "none";
  }
}

// Waits until student/resultsCache/schedule data are loaded, then pops up modal
async function showScheduleOnLoad() {
  // Wait for profile/resultsCache/student to be ready
  let tries = 0;
  function ready() {
    // Modify these conditions if your variables have different names
    return student && student.facultyId && student.departmentId && Array.isArray(resultsCache);
  }
  while (!ready() && tries < 15) {
    await new Promise(r => setTimeout(r, 250));
    tries++;
  }
  if (!ready()) return;

  try {
    const resp = await fetch(
      API_URL +
        `schedules?faculty=${student.facultyId}&department=${student.departmentId}`,
      { headers: { Authorization: "Bearer " + token } }
    );
    const schedules = await resp.json();
    if (!Array.isArray(schedules) || schedules.length === 0) return;

    // Find current or next available test
    const now = Date.now();
    let activeSched = schedules.find(sched =>
      sched.examSet &&
      sched.examSet.status === "ACTIVE" &&
      sched.start &&
      now <= new Date(sched.end).getTime()
    );
    if (!activeSched) {
      // Fallback: show first scheduled in future
      activeSched = schedules.find(sched =>
        sched.examSet &&
        sched.examSet.status === "ACTIVE" &&
        sched.start &&
        now < new Date(sched.start).getTime()
      );
    }
    if (activeSched) showScheduleModal(activeSched);
  } catch (e) { /* fail silently */ }
}


    window.addEventListener("load", init);

// Add this script to your student.html, after html2canvas import
// Use this version for your fillCertInfo and downloadCertificate logic

function fillCertInfo({
  name,
  examTitle = "Central Mock Examination",
  host = "OAUExam Suite",
  score = "",
  extra = ""
}) {
  document.getElementById('certStudentName').innerText = name || '';
  document.getElementById('certExamTitle').innerText = examTitle || '';
  document.getElementById('certHost').innerText = host || '';
  document.getElementById('certScoreText').innerHTML = score ? `<br>with a score of <b>${score}%</b>` : '';
  document.getElementById('certExtra').innerText = extra || '';
  document.getElementById('certDate').innerText = new Date().toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'});
}

async function downloadCertificate() {
  // Fetch or compute actual values from your dashboard logic
  const name = document.getElementById('profileName').innerText || 'Scholar';
  const examTitle = window.lastCompletedTestTitle || 'Central Mock Examination';
  const score = window.lastCompletedTestScore || '';
  fillCertInfo({ name, examTitle, score });

  const certDiv = document.getElementById('certificateTemplate');
  certDiv.style.display = 'block';
  setTimeout(() => {
    html2canvas(certDiv, {backgroundColor: null, useCORS: true, scale:2}).then(canvas => {
      certDiv.style.display = 'none';
      const link = document.createElement('a');
      link.download = `Certificate_${examTitle.replace(/[^\w]/g,'_')}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  }, 180);
  }

let broadcastCache = [];

async function fetchBroadcasts() {
  const resp = await fetch(API_URL + "broadcasts", { headers: { Authorization: "Bearer " + token } });
  broadcastCache = await resp.json() || [];
}

function renderNotifDropdown() {
  let html = "";

  // Render broadcast notifications
  if (broadcastCache.length) {
    broadcastCache.forEach(b => {
      html += `<div class="notif-item" style="background:#f7faff;cursor:pointer;" onclick="openBroadcastPopup('${b._id}')">
        <span style="font-weight:bold;color:#3a86ff;">[Broadcast]</span> ${b.title}
        <div class="notif-time">${(new Date(b.createdAt)).toLocaleString()}</div>
      </div>`;
    });
    html += '<hr style="margin:5px 0;">';
  }

  // ...existing chat/messages rendering...
  if (!chatListCache.length) html += "<div style='padding:18px;text-align:center;color:#aaa;'>No new messages.</div>";
  else chatListCache.slice(0, 8).forEach(chat => {
    html += `<div class="notif-item" onclick="openChatModal('${chat.otherUserId}')">
      <div class="notif-title">${chat.otherUserName}</div>
      <div class="notif-time">${(new Date(chat.lastMsgAt)).toLocaleString()}</div>
      <div>${chat.lastMsgText ? chat.lastMsgText.substring(0, 60) : ""}</div>
    </div>`;
  });

  document.getElementById("notifDropdown").innerHTML = html;
}

function openBroadcastPopup(broadcastId) {
  const b = broadcastCache.find(x => x._id === broadcastId);
  if (!b) return;
  showBroadcastPopup(b);
}

// In your init() after fetching profile and chats:

// ==============================
// Leadership Scoreboard Feature
// ==============================

// Global cache for leaderboard data
let leaderboardCache = [];

// Fetch leaderboard from the backend API endpoint
async function fetchLeaderboard() {
  try {
    const resp = await fetch("/api/results/leaderboard/top", {
      headers: { "Authorization": "Bearer " + localStorage.getItem("token") }
    });
    if (!resp.ok) throw new Error("Failed to fetch leaderboard");
    leaderboardCache = await resp.json();
  } catch (e) {
    leaderboardCache = [];
  }
}

// Render the top 3 scholars in the leaderboard container
function renderLeaderboard() {
  const lb = leaderboardCache.slice(0, 3);
  let html = `<div class="scoreboard-title"> Top Scholars</div>
    <div class="scoreboard-list">
      ${
        lb.length > 0
        ? lb.map((stu, idx) => `
          <div class="scoreboard-item rank-${idx+1}">
            <div class="scoreboard-rank">#${idx+1}</div>
            <img src="${stu.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(stu.fullname||stu.username)}&background=3a86ff&color=fff&rounded=true`}" class="scoreboard-avatar" alt="Profile">
            <div class="scoreboard-name">${stu.fullname || stu.username}</div>
            <div class="scoreboard-score">${stu.totalScore} pts</div>
            <span class="scoreboard-badge badge-rank-${idx+1}">${['','',''][idx]}</span>
          </div>
        `).join('')
        : `<div style="width:100%;text-align:center;color:#888;font-size:1.05em;padding:12px 0;">No leaderboard data yet.</div>`
      }
    </div>`;
  document.getElementById("leaderboardContainer").innerHTML = html;
}

// Show the daily winner popup at 8AM and 9PM
function showWinnerPopup() {
  if (!leaderboardCache.length) return;
  const winner = leaderboardCache[0];
  let html = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:370px; box-shadow:0 6px 32px #0003; border-radius:18px;">
        <div style="background:#3a86ff; color:#fff; border-top-left-radius:18px; border-top-right-radius:18px; padding:18px 0; text-align:center;">
          <div style="font-size:2.4em;"></div>
          <div style="font-size:1.4em;font-weight:bold;">Daily Champion</div>
        </div>
        <div style="padding:32px 20px 20px 20px; text-align:center;">
          <img src="${winner.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(winner.fullname||winner.username)}&background=3a86ff&color=fff&rounded=true`}" style="width:88px;height:88px;border-radius:50%;border:3px solid #3a86ff;margin-bottom:16px;">
          <div style="font-size:1.23em; font-weight:700; color:#23366e; margin-bottom:8px;">${winner.fullname || winner.username}</div>
          <div style="color:#3a86ff; font-size:1.02em;">Congratulations! You are the top scorer with <b>${winner.totalScore}</b> points!</div>
          <div style="margin-top:15px;"><span class="scoreboard-badge badge-rank-1"></span> <span style="color:#f7b500;font-weight:700;">Gold Badge</span></div>
        </div>
      </div>
    </div>
  `;
  document.getElementById("modalRoot").innerHTML = html;
}

// Check and show winner popup at 8:00AM and 9:00PM (once per hour per day)
function checkAndShowWinnerPopup() {
  const now = new Date();
  const hour = now.getHours();
  const minute = now.getMinutes();
  const key = `leaderboardPopupShown_${now.getFullYear()}_${now.getMonth()}_${now.getDate()}_${hour}`;
  if (((hour === 8 && minute === 0) || (hour === 21 && minute === 0)) && !localStorage.getItem(key)) {
    showWinnerPopup();
    localStorage.setItem(key, "true");
  }
}



// Call this after the DOM is ready to setup the leaderboard
async function setupLeaderboard() {
  await fetchLeaderboard();
  renderLeaderboard();
  setInterval(checkAndShowWinnerPopup, 60 * 1000);
}

// Call setupLeaderboard() after login or main dashboard page load
window.addEventListener("DOMContentLoaded", setupLeaderboard);

let currentSchedId = null;
// ========== INIT ==========
    async function init() {
  if (!token) return window.location.href = "mock-icthallb";
  await fetchFacultiesAndDepartments();
  await fetchAllUsers();
  await fetchProfile();
  await fetchHistory();
  await fetchAnnouncements();
  await fetchBroadcasts();
  await fetchAvailableTests();
  pollChatsForNotifications();
  setInterval(pollChatsForNotifications, 8000);
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.notif-bell') && !e.target.closest('.notif-dropdown')) {
      document.getElementById("notifDropdown").classList.remove("active");
    }
  });
  window.hidePreloaderSpinner();

  // <<< Add this here, after all data is loaded >>>
  showScheduleOnLoad();
}
  </script>
</body>
</html>
