<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.8"/>
  <title>CBT Test</title>

  <!-- MathJax and KaTeX for math rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- MathJax Setup -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)'], ['\\[', '\\]'], ['$', '$']],
        displayMath: [['\\[', '\\]'], ['$$', '$$']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0B0B45;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(120deg, #141E30 0%, #2d6a99 100%);
      padding: 0;
      position: relative;
      margin-bottom: 16px;
      box-shadow: 0 4px 18px 0 #001c3c44;
    }

    .header-inner {
      max-width: 1050px;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: stretch;
      padding: 0 16px;
      min-height: 110px;
      position: relative;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      min-width: 250px;
      z-index: 2;
      padding-left: 8px;
    }
    .exam-title {
      font-size: 1.35rem;
      font-weight: bold;
      letter-spacing: 0.5px;
      color: #fff;
      margin-bottom: 8px;
      margin-top: 14px;
      text-shadow: 0 2px 8px #001c3c44;
    }
    .candidate-name {
      font-size: 1rem;
      color: #bdeaff;
      background: rgba(0,198,255,0.08);
      border-radius: 6px;
      padding: 5px 13px;
      font-weight: 500;
      margin-bottom: 10px;
      display: inline-block;
    }

    .header-center {
      flex: 1 0 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-width: 220px;
      z-index: 1;
      padding: 14px 5px 10px 5px;
      position: relative;
    }
    .school-logo {
      width: 66px;
      height: 66px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 4px 24px #00c6ff33;
      margin-bottom: 8px;
      object-fit: cover;
      border: 3px solid #0072ff44;
      display: block;
    }
    .school-name {
      font-size: 1.3rem;
      font-weight: bold;
      color: #fff;
      letter-spacing: 1.2px;
      text-align: center;
      text-shadow: 0 2px 8px #001c3c44;
    }
    .test-subtitle {
      font-size: 1.01rem;
      color: #bdeaff;
      margin-top: 4px;
      letter-spacing: 0.7px;
      text-align: center;
      font-weight: 500;
      text-shadow: 0 1px 5px #001c3c44;
    }

    #timer {
      font-weight: bold;
      font-size: 1.01rem;
      background: #00c6ff;
      padding: 8px 15px;
      border-radius: 8px;
      color: #002e53;
      box-shadow: 0 2px 8px #00c6ff30;
      margin-top: 13px;
      margin-right: 18px;
      align-self: flex-end;
      z-index: 2;
      position: absolute;
      right: 0;
      top: 13px;
    }

    .container {
      flex: 1;
      max-width: 700px;
      margin: 20px auto;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .question-box {
      margin-bottom: 20px;
    }

    .question {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .options button {
      padding: 12px 18px;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 16px;
      text-align: left;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .options button:hover {
      background: #00c6ff;
      color: #000;
    }

    .options button.selected {
      background: #00c6ff;
      color: #000;
      border-color: #0072ff;
    }

    .nav-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    .nav-buttons button {
      padding: 10px 20px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      background: #0072ff;
      color: #fff;
      cursor: pointer;
    }

    .nav-buttons button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    @media(max-width: 900px) {
      .header-inner {
        flex-direction: column;
        align-items: center;
        padding: 0 3vw;
        min-height: unset;
      }
      .header-left {
        align-items: center;
        padding-left: 0;
        margin-bottom: 6px;
      }
      #timer {
        position: static;
        margin: 12px 0 0 0;
        align-self: center;
      }
    }

    @media(max-width: 600px) {
      .container {
        max-width: 96vw;
        padding: 5vw 2vw;
      }
      .school-logo {
        width: 46px;
        height: 46px;
      }
      .school-name {
        font-size: 1.08rem;
      }
      .test-subtitle {
        font-size: 0.92rem;
      }
      .exam-title {
        font-size: 1rem;
      }
      .candidate-name {
        font-size: 0.9rem;
        padding: 5px 8px;
      }
    }
    .options button img {
      float: right;
      max-width: 40%;
      border-radius: 6px;
    }
    #noActiveSet {
      color: #ff4e55;
      font-weight: bold;
      text-align: center;
      font-size: 1.2rem;
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-left">
        <span class="exam-title" id="examTitle">Loading Exam...</span>
        <span class="candidate-name" id="candidateName">CANDIDATE:  .</span>
      </div>
      <div class="header-center">
        <img src="logo.png" alt="School Logo" class="school-logo" />
        <div class="school-name">Obafemi Awolowo University</div>
        <div class="test-subtitle">Central Mock Test</div>
      </div>
      <div id="timer">Loading...</div>
    </div>
  </header>

  <div class="container">
    <div id="noActiveSet" style="display:none;">
      No active question set is available. Please contact your instructor.
    </div>
    <div class="question-box" id="questionBox">
      <!-- Content loads here -->
    </div>
    <div class="nav-buttons" id="navButtons" style="display:none;">
      <button onclick="prevQuestion()" id="prevBtn">Previous</button>
      <button onclick="nextQuestion()" id="nextBtn">Next</button>
    </div>
  </div>

  <script>
    // User & Access
    const currentUser = localStorage.getItem('current_user') || 'Guest';
    document.getElementById('candidateName').innerText += currentUser;
    if (!currentUser || currentUser === "Guest") {
      window.location.href = "mock.html";
    }

    // Constants for session
    const MAX_SESSION_QUESTIONS = 60;
    const SESSION_TIME_LIMIT = 40 * 60; // 40 minutes in seconds

    // Questions logic
    let allQuestionSets = [];
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = {};
    let timeLimit = SESSION_TIME_LIMIT;
    let timeRemaining = timeLimit;
    let timerInterval;

    async function loadQuestions() {
      try {
        const res = await fetch('main-questions.json');
        if (!res.ok) throw new Error("Could not load questions");
        const sets = await res.json();
        allQuestionSets = sets;
        // Find active set
        const activeSet = allQuestionSets.find(set => set.status === "ACTIVE");
        if (!activeSet || !activeSet.questions || activeSet.questions.length === 0) {
          document.getElementById("examTitle").textContent = "No Active Exam";
          document.getElementById("questionBox").innerHTML = "";
          document.getElementById('navButtons').style.display = "none";
          document.getElementById('noActiveSet').style.display = "";
          document.getElementById("timer").innerText = "Error!";
          return;
        }
        document.getElementById('examTitle').textContent = activeSet.title || "CBT Test";

        // Get or reset answered question IDs for this user and set
        const currentSetKey = 'set_' + (activeSet.title || '').replace(/\s/g, '_');
        const userKey = `answered_${currentSetKey}_${currentUser}`;
        let answered = [];
        try {
          answered = JSON.parse(localStorage.getItem(userKey) || '[]');
        } catch (e) {
          answered = [];
        }

        let unseenQuestions = activeSet.questions.filter(q => !answered.includes(q.id));
        // If all have been answered, reset and start fresh
        if (unseenQuestions.length === 0) {
          answered = [];
          unseenQuestions = activeSet.questions.slice();
        }

        // Prepare questions for this session, capped at 60
        questions = shuffle(unseenQuestions).slice(0, MAX_SESSION_QUESTIONS);

        // Save key data for use in submission
        window._cbtSessionData = {
          userKey,
          answered
        };

        document.getElementById('noActiveSet').style.display = "none";
        document.getElementById('navButtons').style.display = "";
        renderQuestion();
        timeLimit = SESSION_TIME_LIMIT;
        timeRemaining = timeLimit;
        updateTimerDisplay();
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
      } catch (err) {
        document.getElementById("questionBox").innerHTML =
          `<p style="color:red;">Failed to load questions. Please refresh or try again later.</p>`;
        document.getElementById("timer").innerText = "Error!";
        document.getElementById('navButtons').style.display = "none";
        console.error(err);
      }
    }

    function renderQuestion() {
      const q = questions[currentQuestionIndex];
      const container = document.getElementById("questionBox");

      const questionImageHTML = q.questionImage
        ? `<div style="margin: 10px 0;"><img src="${q.questionImage}" style="max-width:100%; border-radius:8px;"></div>`
        : "";

      const optionsHTML = q.options.map(opt => {
        const isSelected = userAnswers[q.id] === opt.text;
        const hasImage = opt.image ? `<img src="${opt.image}" style="max-height:80px; margin-left:10px;">` : "";
        return `
          <button onclick="selectAnswer(${q.id}, '${opt.text.replace(/'/g,"\\'")}', this)" class="${isSelected ? 'selected' : ''}">
            ${opt.text}${hasImage}
          </button>`;
      }).join('');

      container.innerHTML = `
        <div class="question">${currentQuestionIndex + 1}. ${q.question}</div>
        ${questionImageHTML}
        <div class="options">${optionsHTML}</div>
      `;

      document.getElementById("prevBtn").disabled = currentQuestionIndex === 0;
      document.getElementById("nextBtn").innerText =
        currentQuestionIndex === questions.length - 1 ? 'Submit' : 'Next';

      // Trigger MathJax typesetting
      if (window.MathJax && window.MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    function selectAnswer(qid, answer, btn) {
      userAnswers[qid] = answer;
      document.querySelectorAll(".options button").forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    function nextQuestion() {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
      } else {
        submitTest();
      }
    }

    function prevQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
      }
    }

    function updateTimerDisplay() {
      const mins = String(Math.floor(timeRemaining / 60)).padStart(2, '0');
      const secs = String(timeRemaining % 60).padStart(2, '0');
      document.getElementById("timer").innerText = `Time Remaining: ${mins}:${secs}`;
    }

    function updateTimer() {
      if (timeRemaining <= 0) {
        submitTest();
        return;
      }
      timeRemaining--;
      updateTimerDisplay();
    }

    function submitTest() {
      clearInterval(timerInterval);
      // Save answers and questions for summary
      localStorage.setItem(`answers_${currentUser}`, JSON.stringify(userAnswers));
      localStorage.setItem(`questions_${currentUser}`, JSON.stringify(questions));
      localStorage.setItem(`timeTaken_${currentUser}`, timeLimit - timeRemaining);

      // Update the answered question IDs for this user and set
      const { userKey, answered } = window._cbtSessionData || {};
      if (userKey) {
        const newAnswered = questions.map(q => q.id);
        const updatedAnswered = Array.from(new Set([...(answered||[]), ...newAnswered]));
        localStorage.setItem(userKey, JSON.stringify(updatedAnswered));
      }

      window.location.href = 'result-summary';
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    window.onload = loadQuestions;
  </script>
</body>
</html>
