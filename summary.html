<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exam Summary</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #232526, #414345);
      color: #fff;
      margin: 0;
      min-height: 100vh;
    }
    header {
      background: #1f1f1f;
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header img {
      height: 46px;
      border-radius: 50%;
    }
    .summary-container {
      max-width: 900px;
      margin: 30px auto;
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 28px 18px 24px 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.22);
      position: relative;
    }
    #downloadPdfBtn {
      background: #00c6ff;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      padding: 12px 18px;
      cursor: pointer;
      float: right;
      margin-top: -10px;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #00c6ff;
      letter-spacing: 0.5px;
      margin-top: 24px;
    }
    .details-table-container {
      margin-bottom: 30px;
      overflow-x: auto;
    }
    table.details-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 0;
      background: rgba(255,255,255,0.09);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 14px;
    }
    .details-table th, .details-table td {
      padding: 14px 12px;
      text-align: left;
      font-size: 15px;
      border-bottom: 1px solid rgba(0,198,255,0.08);
    }
    .details-table th {
      background: rgba(0,198,255,0.12);
      color: #00c6ff;
      font-weight: bold;
      width: 220px;
    }
    .details-table tr:last-child td {
      border-bottom: none;
    }
    .score {
      font-size: 20px;
      font-weight: bold;
      color: #00ffae;
    }
    .attempted {
      color: #ffc107;
      font-weight: bold;
    }
    .percentage {
      color: #00c6ff;
      font-size: 17px;
      font-weight: bold;
    }
    .pie-chart-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 30px;
    }
    .pie-chart-section canvas {
      background: rgba(255,255,255,0.10);
      border-radius: 50%;
      margin-top: 7px;
    }
    .question-review {
      background: rgba(255,255,255,0.10);
      margin: 18px 0;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .question-review .question {
      font-size: 17px;
      font-weight: bold;
      margin-bottom: 7px;
    }
    .question-review img {
      max-width: 70%;
      border-radius: 8px;
      margin: 8px 0;
    }
    .option-block {
      margin: 4px 0 4px 0;
    }
    .option-block .label {
      display: inline-block;
      width: 110px;
      font-weight: bold;
      color: #00c6ff;
    }
    .user-answer.correct {
      background: #00ffae22;
      color: #00ffae;
      border-radius: 5px;
      padding: 3px 8px;
      font-weight: 600;
    }
    .user-answer.incorrect {
      background: #ff4e5522;
      color: #ff4e55;
      border-radius: 5px;
      padding: 3px 8px;
      font-weight: 600;
    }
    .correct-answer {
      background: #00c6ff22;
      color: #00c6ff;
      border-radius: 5px;
      padding: 3px 8px;
      font-weight: 600;
    }
    .explanation {
      margin-top: 7px;
      background: rgba(0,198,255,0.08);
      color: #bdeaff;
      border-left: 4px solid #00c6ff;
      padding: 7px 12px;
      border-radius: 6px;
      font-size: 15px;
    }
    @media (max-width: 800px) {
      .summary-container {
        padding: 12px 5px;
      }
      #downloadPdfBtn {
        float: none;
        margin: 10px 0;
        width: 100%;
      }
      .details-table th, .details-table td {
        font-size: 13px;
        padding: 10px 6px;
      }
    }
  </style>
  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/61/HTML5_logo_and_wordmark.svg/120px-HTML5_logo_and_wordmark.svg.png" alt="Logo">
    <div style="font-size: 20px; font-weight: bold;">Exam Summary</div>
  </header>
  <div class="summary-container">
    <button id="downloadPdfBtn">Download as PDF</button>
    <div class="section-title">Details</div>
    <div class="details-table-container">
      <table class="details-table" id="detailsTable">
        <!-- filled by JS -->
      </table>
    </div>
    <div class="pie-chart-section">
      <div style="font-size: 18px; color: #00c6ff; font-weight: bold;">Result Pie Chart</div>
      <canvas id="resultPieChart" width="280" height="280"></canvas>
    </div>
    <div class="section-title">Attempt Review</div>
    <div id="reviewSection"></div>
  </div>
  <script>
    const currentUser = localStorage.getItem('current_user') || 'Guest';
    const answers = JSON.parse(localStorage.getItem(`answers_${currentUser}`) || '{}');
    const questions = JSON.parse(localStorage.getItem(`questions_${currentUser}`) || '[]');
    const timeTaken = Number(localStorage.getItem(`timeTaken_${currentUser}`) || "0");

    // Calculate stats
    const totalQuestions = questions.length;
    const attemptedQuestions = Object.keys(answers).length;
    let score = 0;

    questions.forEach(q => {
      if (
        answers[q.id] !== undefined &&
        typeof answers[q.id] !== 'undefined' &&
        answers[q.id] === q.answer
      ) score++;
    });

    const incorrect = attemptedQuestions - score;
    const notAttempted = totalQuestions - attemptedQuestions;
    const percentage = totalQuestions ? (score / totalQuestions * 100).toFixed(2) : 0;
    const avgSpeed = totalQuestions ? (timeTaken / totalQuestions).toFixed(2) : 0;
    const mins = Math.floor(timeTaken / 60);
    const secs = timeTaken % 60;

    // Fill Table
    document.getElementById('detailsTable').innerHTML = `
      <tr>
        <th>Username</th>
        <td>${currentUser}</td>
      </tr>
      <tr>
        <th>Total Questions</th>
        <td>${totalQuestions}</td>
      </tr>
      <tr>
        <th>Attempted</th>
        <td class="attempted">${attemptedQuestions}</td>
      </tr>
      <tr>
        <th>Correct Answers</th>
        <td class="score">${score}</td>
      </tr>
      <tr>
        <th>Incorrect Answers</th>
        <td style="color:#ff4e55; font-weight:bold;">${incorrect}</td>
      </tr>
      <tr>
        <th>Not Attempted</th>
        <td style="color:#bdeaff; font-weight:bold;">${notAttempted}</td>
      </tr>
      <tr>
        <th>Percentage</th>
        <td class="percentage">${percentage}%</td>
      </tr>
      <tr>
        <th>Avg Speed</th>
        <td>${avgSpeed} sec/question</td>
      </tr>
      <tr>
        <th>Time Taken</th>
        <td>${mins}m ${secs < 10 ? '0' : ''}${secs}s</td>
      </tr>
    `;

    // Pie Chart
    window.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('resultPieChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Correct', 'Incorrect', 'Not Attempted'],
          datasets: [{
            data: [score, incorrect, notAttempted],
            backgroundColor: [
              '#00ffae', // Correct
              '#ff4e55', // Incorrect
              '#bdeaff'  // Not Attempted
            ],
            borderWidth: 2,
            borderColor: '#232526'
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#fff',
                font: {size: 15}
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.parsed;
                  return label;
                }
              }
            }
          }
        }
      });
    });

    // Attempt Review
    function renderReview() {
      let html = '';
      questions.forEach((q, idx) => {
        const userAns = answers[q.id];
        const isCorrect = userAns === q.answer;
        const questionImage = q.questionImage ? `<img src="${q.questionImage}" alt="Question Image" />` : '';
        html += `
          <div class="question-review">
            <div class="question">${idx + 1}. ${q.question}</div>
            ${questionImage}
            <div class="option-block">
              <span class="label">Your Answer:</span>
              <span class="user-answer ${typeof userAns === "undefined" ? "" : (isCorrect ? 'correct' : 'incorrect')}">
                ${typeof userAns === "undefined" ? "<em>Not answered</em>" : userAns}
              </span>
            </div>
            <div class="option-block">
              <span class="label">Correct Answer:</span>
              <span class="correct-answer">${q.answer}</span>
            </div>
            <div class="explanation">
              <strong>Explanation:</strong> <br/>
              ${q.explanation}
            </div>
          </div>
        `;
      });
      document.getElementById('reviewSection').innerHTML = html;
      if (window.MathJax && window.MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    renderReview();
  </script>
  <!-- PDF dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- PDF logic -->
  <script>
    document.getElementById('downloadPdfBtn').addEventListener('click', function () {
      const summaryEl = document.querySelector('.summary-container');
      this.style.display = 'none';

      html2canvas(summaryEl, {scale: 2, useCORS: true}).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new window.jspdf.jsPDF({
          orientation: 'portrait',
          unit: 'pt',
          format: 'a4'
        });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pageWidth - 30;
        const imgHeight = canvas.height * imgWidth / canvas.width;

        let position = 20;
        pdf.addImage(imgData, 'PNG', 15, position, imgWidth, imgHeight);

        let heightLeft = imgHeight;
        while (heightLeft > pageHeight - 40) {
          pdf.addPage();
          position = 10;
          heightLeft -= pageHeight - 40;
          pdf.addImage(
            imgData,
            'PNG',
            15,
            position - heightLeft,
            imgWidth,
            imgHeight
          );
        }

        pdf.save('exam-summary.pdf');
        setTimeout(() => {
          document.getElementById('downloadPdfBtn').style.display = '';
        }, 500);
      });
    });
  </script>
</body>
</html>
