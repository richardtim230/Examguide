<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.90"/>
  <title>Exam Summary</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Tahoma', Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #232526, #414345);
      color: #fff;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: linear-gradient(90deg, #0072ff 0%, #00c6ff 100%);
      color: #fff;
      padding: 28px 0 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 16px rgba(0,0,0,0.10);
      flex-direction: column;
      position: relative;
    }
    header .logo-row {
      display: flex;
      align-items: center;
      gap: 18px;
    }
    header img {
      height: 62px;
      border-radius: 12px;
      background: #fff;
      padding: 6px;
      box-shadow: 0 2px 8px rgba(0,198,255,0.20);
    }
    header .main-title {
      font-size: 2.2rem;
      font-weight: bold;
      letter-spacing: 1.5px;
    }
    header .subtitle {
      font-size: 1.1rem;
      opacity: 0.92;
      margin-top: 5px;
      font-weight: 400;
    }
    .summary-container {
      max-width: 950px;
      margin: 32px auto 32px auto;
      background: rgba(255,255,255,0.09);
      border-radius: 14px;
      padding: 30px 22px 24px 22px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.13);
      flex: 1 0 auto;
    }
    .section-title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #00c6ff;
      letter-spacing: 0.5px;
      margin-top: 24px;
    }
    .details-table-container {
      margin-bottom: 32px;
      overflow-x: auto;
    }
    table.details-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 0;
      background: rgba(255,255,255,0.11);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 14px;
      box-shadow: 0 2px 10px rgba(0,198,255,0.04);
    }
    .details-table th, .details-table td {
      padding: 14px 12px;
      text-align: left;
      font-size: 15px;
      border-bottom: 1.2px solid rgba(0,198,255,0.12);
    }
    .details-table th {
      background: rgba(0,198,255,0.17);
      color: #00c6ff;
      font-weight: bold;
      width: 220px;
    }
    .details-table tr:last-child td {
      border-bottom: none;
    }
    .score {
      font-size: 20px;
      font-weight: bold;
      color: #00ffae;
    }
    .attempted {
      color: #ffc107;
      font-weight: bold;
    }
    .percentage {
      color: #00c6ff;
      font-size: 17px;
      font-weight: bold;
    }
.pie-chart-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin-bottom: 36px;
  width: 100%;
}
.pie-chart-section canvas {
  display: block;
  margin: 16px auto 0 auto;
  background: rgba(255,255,255,0.10);
  border-radius: 50%;
  box-shadow: 0 2px 12px rgba(0,198,255,0.10);
  max-width: 100%;
  height: auto;
}
      .pie-chart-section canvas {
  max-width: 320px;
  width: 100%;
    }
    .question-review {
      background: rgba(255,255,255,0.13);
      margin: 18px 0 26px 0;
      padding: 16px 16px 12px 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .question-review .question {
      font-size: 17px;
      font-weight: bold;
      margin-bottom: 7px;
    }
    .question-review img {
      max-width: 70%;
      border-radius: 8px;
      margin: 8px 0;
    }
    .option-block {
      margin: 4px 0 4px 0;
    }
    .option-block .label {
      display: inline-block;
      width: 120px;
      font-weight: bold;
      color: #00c6ff;
    }
    .user-answer.correct {
      background: #00ffae22;
      color: #00ffae;
      border-radius: 5px;
      padding: 3px 8px;
      font-weight: 600;
    }
    .user-answer.incorrect {
      background: #ff4e5522;
      color: #ff4e55;
      border-radius: 5px;
      padding: 3px 8px;
      font-weight: 600;
    }
    .correct-answer {
      background: #00c6ff22;
      color: #00c6ff;
      border-radius: 5px;
      padding: 3px 8px;
      font-weight: 600;
    }
    .explanation {
      margin-top: 7px;
      background: rgba(0,198,255,0.08);
      color: #bdeaff;
      border-left: 4px solid #00c6ff;
      padding: 7px 12px;
      border-radius: 6px;
      font-size: 15px;
    }
    footer {
      background: linear-gradient(90deg, #0072ff 0%, #00c6ff 100%);
      color: #fff;
      text-align: center;
      padding: 22px 12px 30px 12px;
      font-size: 1.13rem;
      font-weight: 500;
      letter-spacing: 1px;
      box-shadow: 0 -2px 18px rgba(0,0,0,0.10);
      margin-top: 32px;
      position: relative;
    }
    #printBtn {
      background: #fff;
      color: #0072ff;
      border: none;
      border-radius: 7px;
      font-size: 16px;
      font-weight: bold;
      padding: 13px 28px;
      cursor: pointer;
      margin: 0 auto 10px auto;
      display: block;
      transition: background 0.2s, color 0.2s;
      box-shadow: 0 2px 8px rgba(0,198,255,0.09);
    }
    #printBtn:hover {
      background: #00c6ff;
      color: #fff;
    }
    @media (max-width: 800px) {
      .summary-container {
        padding: 12px 5px;
      }
      .details-table th, .details-table td {
        font-size: 13px;
        padding: 10px 6px;
      }
      .section-title {
        font-size: 17px;
      }
      header .main-title {
        font-size: 1.4rem;
      }
      header img {
        height: 40px;
      }
    }
    @media print {
      #printBtn, footer {
        display: none !important;
      }
      body, .summary-container, header {
        background: #fff !important;
        color: #000 !important;
        box-shadow: none !important;
      }
      .pie-chart-section canvas, .question-review, .details-table, header img {
        background: #fff !important;
      }
      header {
        color: #000 !important;
        box-shadow: none !important;
      }
      .correct-answer, .user-answer.correct, .user-answer.incorrect {
        color: #000 !important;
        background: #eee !important;
      }
      .explanation {
        background: #f7faff !important;
        color: #222 !important;
        border-left: 4px solid #00c6ff !important;
      }
    }
  </style>
  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div class="logo-row">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/61/HTML5_logo_and_wordmark.svg/120px-HTML5_logo_and_wordmark.svg.png" alt="Logo">
      <div>
        <div class="main-title">Exam Summary Report</div>
        <div class="subtitle">Review your performance and answers below</div>
      </div>
    </div>
  </header>
  <div class="summary-container">
    <div class="section-title">Details</div>
    <div class="details-table-container">
      <table class="details-table" id="detailsTable">
        <!-- filled by JS -->
      </table>
    </div>
    <div class="pie-chart-section">
      <div style="font-size: 18px; color: #00c6ff; font-weight: bold;">Result Pie Chart</div>
      <canvas id="resultPieChart" width="280" height="280"></canvas>
    </div>
    <div class="section-title">Attempt Review</div>
    <div id="reviewSection"></div>
  </div>
  <footer>
    <button id="printBtn">Print / Save as PDF</button>
    &copy; <span id="year"></span> CBT Platform &mdash; Powered by ExamGuide
  </footer>
  <script>
    // Data and calculations
    const currentUser = localStorage.getItem('current_user') || 'Guest';
    const answers = JSON.parse(localStorage.getItem(`answers_${currentUser}`) || '{}');
    const questions = JSON.parse(localStorage.getItem(`questions_${currentUser}`) || '[]');
    const timeTaken = Number(localStorage.getItem(`timeTaken_${currentUser}`) || "0");

    const totalQuestions = questions.length;
    const attemptedQuestions = Object.keys(answers).length;
    let score = 0;

    questions.forEach(q => {
      if (answers[q.id] !== undefined && typeof answers[q.id] !== 'undefined' && answers[q.id] === q.answer) score++;
    });

    const incorrect = attemptedQuestions - score;
    const notAttempted = totalQuestions - attemptedQuestions;
    const percentage = totalQuestions ? (score / totalQuestions * 100).toFixed(2) : 0;
    const avgSpeed = totalQuestions ? (timeTaken / totalQuestions).toFixed(2) : 0;
    const mins = Math.floor(timeTaken / 60);
    const secs = timeTaken % 60;

    // Fill Table
    document.getElementById('detailsTable').innerHTML = `
      <tr>
        <th>Username</th>
        <td>${currentUser}</td>
      </tr>
      <tr>
        <th>Total Questions</th>
        <td>${totalQuestions}</td>
      </tr>
      <tr>
        <th>Attempted</th>
        <td class="attempted">${attemptedQuestions}</td>
      </tr>
      <tr>
        <th>Correct Answers</th>
        <td class="score">${score}</td>
      </tr>
      <tr>
        <th>Incorrect Answers</th>
        <td style="color:#ff4e55; font-weight:bold;">${incorrect}</td>
      </tr>
      <tr>
        <th>Not Attempted</th>
        <td style="color:#bdeaff; font-weight:bold;">${notAttempted}</td>
      </tr>
      <tr>
        <th>Percentage</th>
        <td class="percentage">${percentage}%</td>
      </tr>
      <tr>
        <th>Avg Speed</th>
        <td>${avgSpeed} sec/question</td>
      </tr>
      <tr>
        <th>Time Taken</th>
        <td>${mins}m ${secs < 10 ? '0' : ''}${secs}s</td>
      </tr>
    `;

    // Pie Chart
    window.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('resultPieChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Correct', 'Incorrect', 'Not Attempted'],
          datasets: [{
            data: [score, incorrect, notAttempted],
            backgroundColor: [
              '#00ffae', // Correct
              '#ff4e55', // Incorrect
              '#bdeaff'  // Not Attempted
            ],
            borderWidth: 2,
            borderColor: '#232526'
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#fff',
                font: {size: 15}
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.parsed;
                  return label;
                }
              }
            }
          }
        }
      });
    });

    // Attempt Review
    function renderReview() {
      let html = '';
      questions.forEach((q, idx) => {
        const userAns = answers[q.id];
        const isCorrect = userAns === q.answer;
        const questionImage = q.questionImage ? `<img src="${q.questionImage}" alt="Question Image" />` : '';
        html += `
          <div class="question-review">
            <div class="question">${idx + 1}. ${q.question}</div>
            ${questionImage}
            <div class="option-block">
              <span class="label">Your Answer:</span>
              <span class="user-answer ${typeof userAns === "undefined" ? "" : (isCorrect ? 'correct' : 'incorrect')}">
                ${typeof userAns === "undefined" ? "<em>Not answered</em>" : userAns}
              </span>
            </div>
            <div class="option-block">
              <span class="label">Correct Answer:</span>
              <span class="correct-answer">${q.answer}</span>
            </div>
            <div class="explanation">
              <strong>Explanation:</strong> <br/>
              ${q.explanation}
            </div>
          </div>
        `;
      });
      document.getElementById('reviewSection').innerHTML = html;
      if (window.MathJax && window.MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }
    renderReview();

    // Print button
    document.getElementById('printBtn').onclick = function() {
      window.print();
    };

    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
