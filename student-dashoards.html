<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="student_dashboard.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="preloaderSpinner" class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-lg">Loading dashboard...</div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-gray-800 text-white transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-30">
            <div class="p-4">
                <h1 class="text-xl font-bold">OAU ExamGuard</h1>
                <p class="text-sm">Student Dashboard</p>
            </div>
            <nav class="mt-4">
                <a href="#dashboard" data-tab="dashboard" class="nav-link block px-4 py-2 hover:bg-indigo-700">Dashboard</a>
                <a href="#mock-tests" data-tab="mock-tests" class="nav-link block px-4 py-2 hover:bg-indigo-700">Mock Tests</a>
                <a href="#exams" data-tab="exams" class="nav-link block px-4 py-2 hover:bg-indigo-700">Exams</a>
                <a href="#study-resources" data-tab="study-resources" class="nav-link block px-4 py-2 hover:bg-indigo-700">Study Resources</a>
                <a href="#messages" data-tab="messages" class="nav-link block px-4 py-2 hover:bg-indigo-700">Messages</a>
                <a href="#profile-settings" data-tab="profile-settings" class="nav-link block px-4 py-2 hover:bg-indigo-700">Profile Settings</a>
                <a href="#logout" data-tab="logout" class="nav-link block px-4 py-2 hover:bg-indigo-700">Logout</a>
            </nav>
        </div>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden md:hidden z-20"></div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="md:hidden p-4">
                <button id="menu-toggle" class="text-gray-800">â˜°</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content p-6 hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold">Welcome, <span id="studentName">!</span></h2>
                    <p class="text-gray-600">Your academic journey, beautifully organized</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Student Details</h3>
                        <div class="space-y-2">
                            <p><strong>Name:</strong> <span id="profileName"></span></p>
                            <p><strong>Student ID:</strong> <span id="studentId"></span></p>
                            <p><strong>Department:</strong> <span id="profileDept"></span></p>
                            <p><strong>Year:</strong> <span id="studentLevel"></span></p>
                            <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                            <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Progress Tracker</h3>
                        <div id="progress-circles" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Announcements</h3>
                        <div id="announcementsPanel"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Quick Access</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-medium">Marketplace</h4>
                                <p class="text-sm text-gray-600">Explore study materials and student essentials.</p>
                                <a href="#" class="text-blue-600 hover:underline">Visit Marketplace</a>
                            </div>
                            <div>
                                <h4 class="font-medium">Blog Home</h4>
                                <p class="text-sm text-gray-600">Read tips, tricks, and student stories.</p>
                                <a href="#" class="text-blue-600 hover:underline">Visit Blog</a>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Achievements & Leaderboard</h3>
                        <div id="leaderboardContainer"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Upcoming Test</h3>
                        <p id="upcomingTest" class="font-medium">None</p>
                        <p id="testCountdown" class="text-gray-600"></p>
                    </div>
                </div>
            </div>

            <!-- Mock Tests Tab -->
            <div id="mock-tests" class="tab-content p-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Mock Tests</h2>
                <p class="text-gray-600 mb-6">Practice and improve your skills with our mock tests</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Available Mock Tests</h3>
                        <div id="testSpinner" class="hidden text-center">Loading...</div>
                        <table id="availableTable" class="w-full">
                            <thead>
                                <tr class="text-left text-gray-600">
                                    <th>Test</th>
                                    <th>Description</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div id="availablePagination" class="mt-4 flex space-x-2 justify-center"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Your Progress</h3>
                        <div id="progressList"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Certificates</h3>
                        <a href="#" class="text-blue-600 hover:underline">Download Certificate</a>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Personalized Study Recommendations</h3>
                        <ul id="recommendations" class="space-y-2"></ul>
                    </div>
                </div>
                <div class="mt-6 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Upcoming Test</h3>
                    <p id="upcomingTest" class="font-medium">None</p>
                    <p id="testCountdown" class="text-gray-600"></p>
                </div>
            </div>

            <!-- Exams Tab -->
            <div id="exams" class="tab-content p-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Exams</h2>
                <p class="text-gray-600 mb-6">Stay on top of your upcoming and past exams</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Assessment Performance & Reviews</h3>
                        <table id="historyTable" class="w-full">
                            <thead>
                                <tr class="text-left text-gray-600">
                                    <th>Test</th>
                                    <th>Date</th>
                                    <th>Score</th>
                                    <th>Review</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div id="historyPagination" class="mt-4 flex space-x-2 justify-center"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Available Assessments</h3>
                        <table id="examAvailableTable" class="w-full">
                            <thead>
                                <tr class="text-left text-gray-600">
                                    <th>Test</th>
                                    <th>Description</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div id="examAvailablePagination" class="mt-4 flex space-x-2 justify-center"></div>
                    </div>
                </div>
            </div>

            <!-- Study Resources Tab -->
            <div id="study-resources" class="tab-content p-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Study Resources</h2>
                <p class="text-gray-600 mb-6">Access essential materials to boost your learning</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Available Resources</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-blue-600 hover:underline">Mathematics Formula Sheet</a></li>
                            <li><a href="#" class="text-blue-600 hover:underline">Physics Concept Notes</a></li>
                            <li><a href="#" class="text-blue-600 hover:underline">Coding Practice Problems</a></li>
                            <li><a href="#" class="text-blue-600 hover:underline">Chemistry Lab Guides</a></li>
                        </ul>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Recommended Resources</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-medium">Calculus Textbook</h4>
                                <p class="text-sm text-gray-600">Comprehensive guide for 300-level calculus.</p>
                                <a href="#" class="text-blue-600 hover:underline">Download</a>
                            </div>
                            <div>
                                <h4 class="font-medium">Physics Video Series</h4>
                                <p class="text-sm text-gray-600">Interactive lectures on mechanics.</p>
                                <a href="#" class="text-blue-600 hover:underline">Watch Now</a>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Study Calendar</h3>
                        <p class="text-gray-600">Your upcoming exams and study sessions.</p>
                        <div class="border p-4">Interactive Calendar (Placeholder)</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Become a Marketer or Blogger!</h3>
                        <p class="text-gray-600">Share your knowledge, sell study materials, or promote products to earn rewards.</p>
                        <a href="#" class="text-blue-600 hover:underline">Get Started</a>
                    </div>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messages" class="tab-content p-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Messages</h2>
                <p class="text-gray-600 mb-6">Stay connected with instructors and peers</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Inbox</h3>
                        <div id="inboxList"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Send a Message</h3>
                        <div class="space-y-4">
                            <select id="recipientSelect" class="w-full p-2 border rounded"></select>
                            <textarea id="messageInput" class="w-full p-2 border rounded" rows="4" placeholder="Type your message..."></textarea>
                            <div class="flex space-x-2">
                                <button id="cancelMessageBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                                <button id="sendMessageBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Settings Tab -->
            <div id="profile-settings" class="tab-content p-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Profile Settings</h2>
                <p class="text-gray-600 mb-6">Manage your personal information and preferences</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Personal Information</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium">Full Name</label>
                                <input id="editName" type="text" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Email</label>
                                <input id="editEmail" type="email" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Phone</label>
                                <input id="editPhone" type="tel" class="w-full p-2 border rounded">
                            </div>
                            <button id="saveProfileBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Change Password</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium">Current Password</label>
                                <input id="currentPassword" type="password" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">New Password</label>
                                <input id="newPassword" type="password" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Confirm New Password</label>
                                <input id="confirmNewPassword" type="password" class="w-full p-2 border rounded">
                            </div>
                            <button id="updatePasswordBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update Password</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logout Tab -->
            <div id="logout" class="tab-content p-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Logout</h2>
                <p class="text-gray-600 mb-6">Safely end your session</p>
                <div class="bg-white p-6 rounded-lg shadow">
                    <p class="mb-4">Are you sure you want to log out? You will be signed out of your account and need to log in again to access your dashboard.</p>
                    <button id="confirm-logout" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Confirm Logout</button>
                </div>
            </div>

            <!-- Currently Scheduled Assessment Modal -->
            <div id="currentAssessmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
                <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Current Scheduled Assessment</h3>
                        <button id="closeAssessmentModal" class="text-gray-600 hover:text-gray-800">&times;</button>
                    </div>
                    <div id="currentAssessmentContent">
                        <p id="modalTestTitle" class="font-medium text-gray-700">Test Title Here</p>
                        <p id="modalTestDescription" class="text-gray-600 text-sm">Short description about the test or any important info for the candidate goes here.</p>
                        <div class="mt-4 space-y-2">
                            <p><strong>Start:</strong> <span id="modalTestStart">-</span></p>
                            <p><strong>End:</strong> <span id="modalTestEnd">-</span></p>
                            <p><strong>Status:</strong> <span id="modalTestStatus">-</span></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button id="startAssessmentBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Start Assessment</button>
                    </div>
                </div>
            </div>

            <!-- Broadcast Message Modal -->
            <div id="broadcastModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
                <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">ðŸ”” Broadcast Message</h3>
                        <button id="closeBroadcastModal" class="text-gray-600 hover:text-gray-800">&times;</button>
                    </div>
                    <div id="broadcastContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modal JavaScript for Current Assessment
        document.getElementById('closeAssessmentModal')?.addEventListener('click', () => {
            document.getElementById('currentAssessmentModal').classList.add('hidden');
        });

        // Update modal with upcoming test data
        function updateAssessmentModal() {
            if (!nextTest || !nextTestStart) {
                document.getElementById('currentAssessmentModal').classList.add('hidden');
                return;
            }
            document.getElementById('modalTestTitle').innerText = nextTest.title || 'Test Title Here';
            document.getElementById('modalTestDescription').innerText = nextTest.description || 'Short description about the test or any important info for the candidate goes here.';
            document.getElementById('modalTestStart').innerText = nextTestStart ? new Date(nextTestStart).toLocaleString() : '-';
            document.getElementById('modalTestEnd').innerText = nextTest.end ? new Date(nextTest.end).toLocaleString() : '-';
            document.getElementById('modalTestStatus').innerText = nextTest.status || 'Scheduled';
            document.getElementById('startAssessmentBtn').onclick = () => startTest(nextTest._id);
            document.getElementById('currentAssessmentModal').classList.remove('hidden');
        }

        // Modal JavaScript for Broadcast Message
        document.getElementById('closeBroadcastModal')?.addEventListener('click', () => {
            document.getElementById('broadcastModal').classList.add('hidden');
        });

        // Override fetchAnnouncements to update broadcast modal
        const originalFetchAnnouncements = fetchAnnouncements;
        fetchAnnouncements = async function() {
            await originalFetchAnnouncements();
            const notifs = await (await fetchWithAuth(API_URL + "notifications")).json();
            const latestNotif = notifs[0]; // Show the most recent announcement
            if (latestNotif) {
                document.getElementById('broadcastContent').innerHTML = `
                    <p class="font-medium text-gray-700">${latestNotif.title}</p>
                    <p class="text-gray-600 text-sm">${latestNotif.message}</p>
                    <p class="text-xs text-gray-500">${formatDate(latestNotif.createdAt)}</p>
                `;
                document.getElementById('broadcastModal').classList.remove('hidden');
            } else {
                document.getElementById('broadcastModal').classList.add('hidden');
            }
        };

        // Override fetchAvailableTests to update assessment modal
        const originalFetchAvailableTests = fetchAvailableTests;
        fetchAvailableTests = async function() {
            await originalFetchAvailableTests();
            updateAssessmentModal();
        };
    </script>
</body>
</html>
