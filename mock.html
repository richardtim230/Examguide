<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Obafemi Awolowo University | Central Mock Test Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=0.8">
  <style>
    html, body {
  height: 100%;
  min-height: 100vh;
  margin: 0;
  padding: 0;
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
  min-height: 100vh;
  margin: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow-x: hidden;
}
.stars {
  position: fixed;
  width: 100vw;
  height: 100vh;
  background: transparent;
  overflow: hidden;
  z-index: 0;
  pointer-events: none;
}
.stars div {
  position: absolute;
  background: white;
  border-radius: 50%;
  animation: twinkle 4s infinite ease-in-out;
}
@keyframes twinkle {
  0%, 100% { opacity: 0.2; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.4); }
}
#notificationPopup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: rgba(8, 24, 57, 0.85);
    padding: 0;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    align-items: center;
    justify-content: center;
    animation: popupFadeIn 0.3s;
}
#notificationPopup.active {
    display: flex !important;
    opacity: 1;
}
@keyframes popupFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
#notificationPopup .popup-content {
    background: #f9fbfd;
    padding: 34px 26px 30px 26px;
    border-radius: 18px;
    box-shadow: 0px 8px 32px rgba(0, 0, 0, 0.24);
    max-width: 600px;
    width: 94vw;
    margin: 0 auto;
    text-align: center;
    font-size: 1.09rem;
    position: relative;
    border: 2px solid #0055b7;
    animation: popupContentFadeIn 0.5s;
}
@keyframes popupContentFadeIn {
  from { opacity: 0; transform: translateY(-32px);}
  to { opacity: 1; transform: translateY(0);}
}
#notificationPopup h2 {
    font-size: 20px;
    color: #003366;
    margin-top: 15px;
    margin-bottom: 18px;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: center;
    font-weight: bold;
}
#notificationPopup ul {
    list-style: inside disc;
    margin-bottom: 22px;
    text-align: left;
    font-size: 15px;
    color: #1a1a1a;
    padding-left: 0;
}
#notificationPopup button.styled-btn,
#notificationPopup button.close-btn {
    display: block;
    width: 100%;
    margin: 10px 0;
    font-family: inherit;
}
#whatsappBtn.styled-btn {
    background: #25D366;
    color: white;
    padding: 12px 25px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin: 10px 0 2px 0;
    transition: background 0.2s, transform 0.2s;
    font-weight: 500;
    box-shadow: 0 2px 7px #25d36633;
}
#whatsappBtn.styled-btn:hover {
    background: #20b058;
}
#closeNotification.close-btn {
    background: #003366;
    color: #fff;
    padding: 10px 0;
    font-size: 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 4px;
    transition: background 0.2s, color 0.2s;
    font-weight: 500;
    box-shadow: 0 1px 5px #00336633;
}
#closeNotification.close-btn:hover {
    background: #0055b7;
    color: #ffe966;
}
#customNotification {
  display: none;
  position: fixed;
  top: 40px;
  left: 50%;
  transform: translateX(-50%);
  background: #003366ee;
  color: #fff;
  padding: 16px 44px 16px 24px;
  border-radius: 12px;
  box-shadow: 0 4px 18px #00000033;
  z-index: 1100;
  font-size: 1.09rem;
  min-width: 280px;
  max-width: 410px;
  text-align: center;
  opacity: 0;
  transition: opacity 0.4s, top 0.4s;
  pointer-events: none;
  border: 1.5px solid #00c6ff;
  font-family: inherit;
  position: fixed;
}
#customNotification.show {
  display: block;
  opacity: 1;
  top: 60px;
  pointer-events: auto;
  animation: notiPopFadeIn 0.5s;
}
@keyframes notiPopFadeIn {
  from { opacity: 0; top: 40px; }
  to { opacity: 1; top: 60px; }
}
#customNotification.success {
  background: #25d366ee;
  color: #1b2e11;
  border: 1.5px solid #17a84b;
}
#customNotification.error {
  background: #ff4136ee;
  color: #fff;
  border: 1.5px solid #c9251b;
}
#customNotification .close-noti {
  position: absolute;
  right: 12px;
  top: 10px;
  background: transparent;
  border: none;
  color: inherit;
  font-size: 20px;
  cursor: pointer;
  opacity: 0.7;
  padding: 0;
}
#customNotification .close-noti:hover {
  opacity: 1;
}
.auth-main-wrapper {
  width: 100vw;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 32px 0;
  z-index: 1;
}
.login-card {
  display: flex;
  flex-direction: row;
  background: rgba(255,255,255,0.14);
  box-shadow: 0 12px 48px 0 rgba(31, 38, 135, 0.22), 0 1.5px 6px #0060e011;
  border-radius: 18px;
  overflow: hidden;
  max-width: 850px;
  width: 96vw;
  min-height: 480px;
  position: relative;
  animation: fadein 0.7s;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
@keyframes fadein {
  from { opacity: 0; transform: scale(0.98);}
  to   { opacity: 1; transform: scale(1);}
}
.login-info {
  background: linear-gradient(115deg,#003366 70%,#0055b7 100%);
  color: #fff;
  flex: 1.1;
  padding: 48px 38px 38px 38px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-width: 220px;
}
.login-info .logo {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 8px 32px #001c3c25;
  margin-bottom: 20px;
  object-fit: contain;
  border: 3px solid #bdeaff77;
}
.login-info .school-name {
  font-size: 1.45rem;
  font-weight: bold;
  letter-spacing: 2px;
  margin-bottom: 12px;
  text-shadow: 0 2px 8px #001c3c33;
  text-align: center;
}
.login-info .subtitle {
  font-size: 1.05rem;
  margin-bottom: 24px;
  color: #bdeaff;
  font-weight: 500;
  text-shadow: 0 1px 4px #001c3c33;
  text-align: center;
}
.login-info .desc {
  font-size: 1rem;
  opacity: 0.93;
  margin-bottom: 0;
  line-height: 1.6;
  text-align: center;
}
.login-form {
  flex: 1.5;
  padding: 40px 28px 28px 28px;
  background: transparent;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-width: 270px;
  max-width: 420px;
  margin: 0 auto;
}
.tab-section {
  width: 100%;
  margin: 0 auto;
  max-width: 400px;
  background: transparent;
  border-radius: 10px;
  animation: fadein 0.5s;
}
.tab-header {
  text-align: center;
  color: white;
  font-size: 1.9rem;
  font-weight: bold;
  margin-bottom: 20px;
  letter-spacing: 1px;
  text-shadow: 0 2px 8px #001c3c33;
}
.login-form form {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 15px;
}
.login-form input,
.register-form input,
.register-form select {
  padding: 12px 14px;
  border-radius: 8px;
  border: 1.5px solid #dde2ee;
  font-size: 1rem;
  color: #003366;
  background: #f7faff;
  transition: border 0.2s;
  outline: none;
  margin-bottom: 12px;
}
.login-form input:focus,
.register-form input:focus,
.register-form select:focus {
  border: 1.5px solid #0072ff;
  background: #fff;
}
.login-form button,
.register-form button {
  padding: 14px 0;
  border-radius: 8px;
  border: none;
  background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
  color: #fff;
  font-size: 1.13rem;
  font-weight: bold;
  box-shadow: 0 2px 8px #0072ff33;
  cursor: pointer;
  margin-top: 8px;
  transition: background 0.2s, box-shadow 0.2s, opacity 0.2s;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}
.login-form button:disabled,
.register-form button:disabled {
  opacity: 0.65;
  cursor: not-allowed;
}
.login-form button:hover:not(:disabled),
.register-form button:hover:not(:disabled) {
  background: linear-gradient(90deg, #0072ff 0%, #00c6ff 100%);
  box-shadow: 0 4px 16px #00336633;
}
.spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid #fff;
  border-top: 3px solid #00c6ff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 10px;
}
@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}
.login-footer {
  margin-top: 18px;
  text-align: center;
  font-size: 0.95rem;
  color: #bdeaff;
  letter-spacing: 0.2px;
  opacity: 0.98;
}
.reset-link {
  color: #ffe966;
  display: inline-block;
  margin-top: 10px;
  text-decoration: underline;
  cursor: pointer;
  font-size: 0.99rem;
  transition: color 0.2s;
}
.reset-link:hover {
  color: #fff;
}
.alternate-link {
  text-align: center;
  margin: 16px 0 0 0;
  font-size: 1.02rem;
  color: white;
  opacity: 0.9;
}
.alternate-link a {
  display: inline-block;
  color: white;
  font-weight: 500;
  text-decoration: bold;
  cursor: pointer;
  margin-left: 2px;
  transition: color 0.2s;
}
.alternate-link a:hover {
  color: #00c6ff;
  text-decoration: underline;
}

/* Responsive Design */
@media (max-width: 900px) {
  .login-card {
    flex-direction: column;
    min-height: auto;
    max-width: 98vw;
    margin: 0 2vw;
  }
  .login-info, .login-form {
    padding: 30px 5vw 18px 5vw;
  }
  .login-form {
    max-width: 100vw;
    min-width: unset;
    padding-bottom: 15px;
  }
  .tab-section {
    max-width: 98vw;
  }
}
@media (max-width: 600px) {
  body {
    align-items: flex-start;
    padding: 0;
  }
  .auth-main-wrapper {
    padding: 8px 0;
  }
  .login-card {
    border-radius: 0;
    max-width: 100vw;
    min-width: 100vw;
    margin: 0;
    box-shadow: none;
  }
  .login-info {
    padding: 18px 2vw 10px 2vw;
    min-width: 0;
  }
  .login-form {
    padding: 18px 2vw 6px 2vw;
    max-width: 100vw;
    min-width: unset;
  }
  .tab-header {
    font-size: 1.32rem;
  }
  #customNotification {
    max-width: 98vw;
    font-size: 0.93rem;
    padding: 13px 22px 13px 16px;
  }
  #notificationPopup .popup-content {
    max-width: 98vw;
    font-size: 1rem;
  }
  .tab-section {
    max-width: 99vw;
  }
}
    /* [CSS goes here, to be provided separately] */
  </style>
</head>
<body>
  <!-- Custom notification UI -->
  <div id="customNotification">
    <button class="close-noti" onclick="hideNotification()" aria-label="Close notification">&times;</button>
    <span id="customNotificationMsg"></span>
  </div>
  <div class="stars"></div>
  <script>
    // Add stars to the background
    document.addEventListener('DOMContentLoaded', function() {
      const starsContainer = document.querySelector('.stars');
      for(let i=0; i<70; i++) {
        let star = document.createElement('div');
        let size = Math.random() * 4 + 1.5;
        star.style.width = star.style.height = `${size}px`;
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.animationDuration = `${Math.random() * 5 + 3}s`;
        starsContainer.appendChild(star);
      }
    });
  </script>
  <!-- Notification Pop-up -->
  <div id="notificationPopup" class="popup" aria-modal="true" role="dialog">
      <div class="popup-content">
        <img src="logo.png" alt="De-Brainstormers Logo" class="logo" style="margin:0 auto 10px auto;display:block;width:70px;height:70px;">
          <h2>Welcome to the Mock Exam Platform</h2>
          <ul>
              <li>Ensure you have a stable internet connection.</li>
              <li>Read all instructions carefully before starting the exam.</li>
              <li>Contact the Admin desk if you encounter any issues.</li>
              <li>You are expected to <b>UPDATE YOUR PROFILE</b> immediately after logging in. Do not take a test without doing that.</li>
              <li>Click on the WhatsApp button below only when you have a question or want to use this platform to host any quiz, tests, exams or survey, otherwise click on the"CLOSE" button to Log in or Register for a scheduled Quiz, Test or Exam.</li>
          </ul>
          <button id="whatsappBtn" class="styled-btn" aria-label="Contact Admin on WhatsApp">Contact Admin on WhatsApp</button>
          <button id="closeNotification" class="close-btn" aria-label="Close Notification">Close</button>
      </div>
  </div>
  <div class="auth-main-wrapper">
    <div class="login-card">
      <!-- Left: Info/brand -->
      <div class="login-info">
        <img src="logo.png" alt="CBT Logo" class="logo">
        <div class="school-name">Obafemi Awolowo University</div>
        <div class="subtitle">Central Mock Test</div>
        <div class="desc">
          <p>Welcome to the official mock test portal.<br>
          Please log in or register to begin.<br>
          <span style="opacity:0.8;font-size:0.97em;">Powered by De-Brainstormers Team</span>
          </p>
        </div>
      </div>
      <!-- Right: Form with alternate links -->
      <div class="login-form">
        <!-- Login Section -->
        <div class="tab-section" id="loginSection">
          <h2 class="tab-header">Log In</h2>
          <form id="authForm" autocomplete="off">
            <input type="text" id="username" placeholder="Username" required autocomplete="username" aria-label="Username">
            <input type="password" id="password" placeholder="Password" required autocomplete="current-password" aria-label="Password">
            <button type="submit" id="loginBtn">
              <span id="loginBtnText">Login</span>
              <span class="spinner" id="loginSpinner" style="display:none;"></span>
            </button>
            <div>
              <span class="reset-link" id="forgotPassword" tabindex="0">Forgot password?</span>
            </div>
          </form>
          <div class="alternate-link">
            Don't have an account yet?
            <a href="#" id="showRegisterSection">Click here to Register</a>
          </div>
          <div class="login-footer">By logging in, you agree to the ICT policy.</div>
        </div>
        <!-- Registration Section -->
<div class="tab-section" id="registerSection" style="display:none;">
  <h2 class="tab-header">Register</h2>
  <form id="registerForm" class="register-form" autocomplete="off">
    <input type="text" id="reg_fullname" placeholder="Full Name" required aria-label="Full Name">
    <input type="text" id="reg_username" placeholder="Username" required autocomplete="username" aria-label="Username">
    <input type="password" id="reg_password" placeholder="Password" required autocomplete="new-password" aria-label="Password">
    <input type="email" id="reg_email" placeholder="Email" required aria-label="Email">
    <select id="reg_faculty" required aria-label="Faculty">
      <option value="">Select Faculty</option>
      <!-- JS populates faculty options here -->
    </select>
    <select id="reg_department" required aria-label="Department" disabled>
      <option value="">Select Department</option>
      <!-- JS populates department options here -->
    </select>
    <select id="reg_level" required aria-label="Level">
      <option value="">Select Level</option>
      <option value="100">100</option>
      <option value="200">200</option>
      <option value="300">300</option>
      <option value="400">400</option>
    </select>
    <input type="tel" id="reg_phone" placeholder="Phone Number" required pattern="[0-9]{11,14}" aria-label="Phone Number">
    <button type="submit" id="registerBtn">
      <span id="registerBtnText">Register</span>
      <span class="spinner" id="registerSpinner" style="display:none;"></span>
    </button>
  </form>
  <div class="alternate-link">
    Already have an account?
    <a href="#" id="showLoginSection">Click here to Login</a>
  </div>
</div>
      </div>
    </div>
  </div>
  <script>

    // OAU Faculties and Departments
const facultyDepartments = {
  "Administration": [
    "Management and Accounting",
    "Public Administration",
    "Local Government and Development Studies",
    "International Relations"
  ],
  "Agriculture": [
    "Agricultural Economics",
    "Animal Science",
    "Crop Production and Protection",
    "Family, Nutrition and Consumer Sciences",
    "Soil Science",
    "Agricultural Extension and Rural Development"
  ],
  "Arts": [
    "African Languages and Literatures",
    "Dramatic Arts",
    "English Language",
    "Foreign Languages",
    "History",
    "Linguistics and African Languages",
    "Music",
    "Philosophy",
    "Religious Studies"
  ],
  "Basic Medical Sciences": [
    "Anatomy and Cell Biology",
    "Human Nutrition and Dietetics",
    "Medical Microbiology and Parasitology",
    "Chemical Pathology",
    "Haematology and Immunology",
    "Morbid Anatomy and Forensic Medicine",
    "Physiology"
  ],
  "Clinical Sciences": [
    "Community Health",
    "Medicine",
    "Nursing Science",
    "Obstetrics, Gynaecology and Perinatology",
    "Paediatrics and Child Health",
    "Psychiatry",
    "Radiology",
    "Surgery"
  ],
  "Dentistry": [
    "Child Dental Health",
    "Oral and Maxillofacial Surgery and Oral Pathology",
    "Preventive and Community Dentistry",
    "Restorative Dentistry"
  ],
  "Education": [
    "Adult Education and Lifelong Learning",
    "Educational Foundations and Counselling",
    "Educational Management",
    "Educational Technology",
    "Fine and Applied Arts Education",
    "Institute of Education",
    "Physical and Health Education",
    "Science and Technology Education",
    "Social Sciences Education"
  ],
  "Environmental Design and Management": [
    "Architecture",
    "Building",
    "Estate Management",
    "Fine and Applied Arts",
    "Quantity Surveying",
    "Urban and Regional Planning"
  ],
  "Law": [
    "Business Law",
    "International Law",
    "Jurisprudence and Private Law",
    "Public Law"
  ],
  "Pharmacy": [
    "Clinical Pharmacy and Pharmacy Administration",
    "Pharmaceutical Chemistry",
    "Pharmaceutical Microbiology",
    "Pharmaceutics",
    "Pharmacognosy",
    "Pharmacology"
  ],
  "Science": [
    "Biochemistry and Molecular Biology",
    "Botany",
    "Chemistry",
    "Computer Science and Engineering",
    "Geology",
    "Mathematics",
    "Microbiology",
    "Physics",
    "Statistics",
    "Zoology"
  ],
  "Social Sciences": [
    "Demography and Social Statistics",
    "Economics",
    "Geography",
    "Political Science",
    "Psychology",
    "Sociology and Anthropology"
  ],
  "Technology": [
    "Agricultural and Environmental Engineering",
    "Chemical Engineering",
    "Civil Engineering",
    "Computer Science and Engineering",
    "Electronic and Electrical Engineering",
    "Food Science and Technology",
    "Materials Science and Engineering",
    "Mechanical Engineering"
  ],
  "Health Sciences": [
    "Medical Rehabilitation",
    "Nursing Science"
  ]
};

const facultySelect = document.getElementById('reg_faculty');
const deptSelect = document.getElementById('reg_department');

// Populate faculty select
function populateFaculties() {
  facultySelect.innerHTML = `<option value="">Select Faculty</option>`;
  Object.keys(facultyDepartments).forEach(faculty => {
    const opt = document.createElement("option");
    opt.value = faculty;
    opt.textContent = faculty;
    facultySelect.appendChild(opt);
  });
}

// Populate department select based on faculty
function populateDepartments(faculty) {
  deptSelect.innerHTML = `<option value="">Select Department</option>`;
  if (facultyDepartments[faculty]) {
    facultyDepartments[faculty].forEach(dept => {
      const opt = document.createElement("option");
      opt.value = dept;
      opt.textContent = dept;
      deptSelect.appendChild(opt);
    });
    deptSelect.disabled = false;
  } else {
    deptSelect.disabled = true;
  }
}

// On faculty change, update departments
facultySelect.addEventListener('change', function() {
  populateDepartments(this.value);
});

// Initialize on DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
  populateFaculties();
  deptSelect.disabled = true;
});
    
    // --- Notification logic ---
    function showNotification(message, type = "") {
      const noti = document.getElementById('customNotification');
      const msgBox = document.getElementById('customNotificationMsg');
      msgBox.textContent = message;
      noti.className = type ? `show ${type}` : 'show';
      noti.style.display = 'block';
      setTimeout(() => {
        if (noti.classList.contains('show')) {
          hideNotification();
        }
      }, 3500);
    }
    function hideNotification() {
      const noti = document.getElementById('customNotification');
      noti.className = '';
      setTimeout(() => { noti.style.display = 'none'; }, 400);
    }

    // Show the notification pop-up
    document.getElementById('notificationPopup').classList.add('active');
    document.getElementById('closeNotification').addEventListener('click', function() {
        document.getElementById('notificationPopup').classList.remove('active');
    });
    document.getElementById('whatsappBtn').addEventListener('click', function() {
        window.open('https://wa.me/+2349155127634', '_blank');
    });

    // --- TOGGLE BETWEEN LOGIN AND REGISTRATION ---
    const loginSection = document.getElementById('loginSection');
    const registerSection = document.getElementById('registerSection');
    const showRegisterSection = document.getElementById('showRegisterSection');
    const showLoginSection = document.getElementById('showLoginSection');

    function showLogin() {
      loginSection.style.display = "";
      registerSection.style.display = "none";
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
    function showRegister() {
      loginSection.style.display = "none";
      registerSection.style.display = "";
      window.scrollTo({top: 0, behavior: 'smooth'});
    }
    showRegisterSection.addEventListener('click', function(e) {
      e.preventDefault();
      showRegister();
    });
    showLoginSection.addEventListener('click', function(e) {
      e.preventDefault();
      showLogin();
    });

    // --- BACKEND LOGIC INTEGRATION ---

    // SET THIS TO YOUR RENDER BACKEND URL:
    const API_URL = "https://examguide.onrender.com/api/auth/";

    function validateUsername(username) {
      return username.trim().length > 0;
    }

    // LOGIN HANDLING
    const authForm = document.getElementById('authForm');
    const loginBtn = document.getElementById('loginBtn');
    const loginBtnText = document.getElementById('loginBtnText');
    const loginSpinner = document.getElementById('loginSpinner');

    async function setLoading(isLoading) {
      if (isLoading) {
        loginBtn.setAttribute("disabled", "disabled");
        loginBtn.style.opacity = "0.7";
        loginSpinner.style.display = "inline-block";
        loginBtnText.style.display = "none";
      } else {
        loginBtn.removeAttribute("disabled");
        loginBtn.style.opacity = "1";
        loginSpinner.style.display = "none";
        loginBtnText.style.display = "inline";
      }
    }

    authForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      let username = document.getElementById('username').value.trim();
      let password = document.getElementById('password').value;
      if (!validateUsername(username) || !password) {
        showNotification("Both fields are required!", "error");
        return;
      }
      await setLoading(true);

      try {
        // Try login first
        let loginResponse = await fetch(API_URL + "login", {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username, password})
        });
        let loginData = await loginResponse.json();

        if (loginResponse.ok) {
          localStorage.setItem('token', loginData.token);
          // Get user role and redirect accordingly
          try {
            let profileResp = await fetch(API_URL.replace(/auth\/$/, '') + "auth/me", {
              headers: { 'Authorization': 'Bearer ' + loginData.token }
            });
            let profileData = await profileResp.json();
            if (profileResp.ok && profileData.user) {
              const role = profileData.user.role;
              if (role === 'superadmin') {
                showNotification("Welcome, Superadmin!", "success");
                setTimeout(() => { window.location.href = "supaadmin.html"; }, 1000);
                await setLoading(false);
                return;
              }
              if (role === 'admin') {
                showNotification("Welcome, Admin!", "success");
                setTimeout(() => { window.location.href = "admin.html"; }, 1000);
                await setLoading(false);
                return;
              }
              if (role === 'uploader') {
                showNotification("Welcome, Uploader!", "success");
                setTimeout(() => { window.location.href = "uploader.html"; }, 1000);
                await setLoading(false);
                return;
              }
              if (role === 'pq-uploader') {
                showNotification("Welcome, Uploader!", "success");
                setTimeout(() => { window.location.href = "pq-uploader.html"; }, 1000);
                await setLoading(false);
                return;
              }
              // Default: student
              showNotification("Welcome, Student!", "success");
              setTimeout(() => { window.location.href = "MainStudentDashboard"; }, 1000);
              await setLoading(false);
              return;
            }
          } catch {
            // fallback
            showNotification("Login successful!", "success");
            setTimeout(() => { window.location.href = "student-dashoards.html"; }, 1000);
          }
          await setLoading(false);
          return;
        }

        // Login failed (user not found)
        showNotification(loginData.message || "Login failed", "error");
      } catch (err) {
        showNotification("Network or server error. Please try again.", "error");
      }
      await setLoading(false);
    });

    // REGISTRATION HANDLING
    const registerForm = document.getElementById('registerForm');
    const registerBtn = document.getElementById('registerBtn');
    const registerBtnText = document.getElementById('registerBtnText');
    const registerSpinner = document.getElementById('registerSpinner');

    async function setRegLoading(isLoading) {
      if (isLoading) {
        registerBtn.setAttribute("disabled", "disabled");
        registerBtn.style.opacity = "0.7";
        registerSpinner.style.display = "inline-block";
        registerBtnText.style.display = "none";
      } else {
        registerBtn.removeAttribute("disabled");
        registerBtn.style.opacity = "1";
        registerSpinner.style.display = "none";
        registerBtnText.style.display = "inline";
      }
    }

    registerForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      // Collect all registration details
      let fullName = document.getElementById('reg_fullname').value.trim();
      let username = document.getElementById('reg_username').value.trim();
      let password = document.getElementById('reg_password').value;
      let email = document.getElementById('reg_email').value.trim();
      let faculty = document.getElementById('reg_faculty').value.trim();
      let department = document.getElementById('reg_department').value.trim();
      let level = document.getElementById('reg_level').value;
      let phone = document.getElementById('reg_phone').value.trim();

      // Basic validation
      if (!fullName || !username || !password || !email || !faculty || !department || !level || !phone) {
        showNotification("All fields are required!", "error");
        return;
      }

      await setRegLoading(true);

      try {
        let registerResponse = await fetch(API_URL + "register", {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            username,
            password,
            email,
            fullname: fullName,
            faculty,
            department,
            level,
            phone
          })
        });
        let registerData = await registerResponse.json();
        if (registerResponse.ok) {
          localStorage.setItem('token', registerData.token);
          showNotification("Registered successfully!", "success");
          setTimeout(() => { window.location.href = 'student-dashoards.html'; }, 1200);
        } else {
          showNotification(registerData.message || "Registration failed", "error");
        }
      } catch (err) {
        showNotification("Network or server error. Please try again.", "error");
      }

      await setRegLoading(false);
    });

    // Password reset (unchanged)
    document.getElementById('forgotPassword').addEventListener('click', async function() {
      let username = prompt("Enter your username for password reset:");
      if (username === null) return;
      username = username.trim();
      if (!validateUsername(username)) {
        showNotification("Username cannot be empty.", "error");
        return;
      }
      let newPass = prompt("Enter your new password:");
      if (!newPass) {
        showNotification("Password cannot be empty.", "error");
        return;
      }
      await setLoading(true);
      try {
        let resp = await fetch(API_URL + "reset", {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username, password: newPass})
        });
        let data = await resp.json();
        if (resp.ok) {
          showNotification("Password reset successful!", "success");
        } else {
          showNotification(data.message || "Reset failed", "error");
        }
      } catch {
        showNotification("Network or server error. Please try again.", "error");
      }
      await setLoading(false);
    });

    if (window.location.protocol !== "https:") {
      console.warn("You are not on a secure connection (HTTPS). Never enter real passwords here.");
    }
  </script>
</body>
</html>
