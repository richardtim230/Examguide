<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Affiliate Dashboard | ExamGuard Nigeria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- SEO -->
  <meta name="description" content="Affiliate dashboard for ExamGuard Nigeria. Track referrals, earnings, analytics, payouts, and manage your affiliate profile.">
  <meta name="keywords" content="examguard affiliate, dashboard, referral, earnings, payout, analytics, Nigeria, student ambassador">
  <meta name="robots" content="index,follow">
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2282/2282759.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ...existing styles... */
    html { scroll-behavior: smooth; }
    .tab-active {
      background: linear-gradient(90deg,#2563eb 60%,#22d3ee 100%);
      color: #fff !important;
    }
    .tab-inactive {
      background: #f1f5f9;
      color: #2563eb;
    }
    .tablist::-webkit-scrollbar { display: none; }
    .tablist { scrollbar-width: none; }
    .fade-in { animation: fadeInUp 1s cubic-bezier(.36,.66,.04,1) both; }
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(24px);}
      100% { opacity: 1; transform: translateY(0);}
    }
    .darkmode {
      background: #111827 !important;
      color: #e5e7eb !important;
    }
    .darkmode .tab-inactive { background: #1e293b !important; color: #22d3ee !important; }
    .darkmode .tab-active { background: linear-gradient(90deg,#0ea5e9 60%,#22d3ee 100%) !important; color: #fff !important; }
    .darkmode .bg-white { background: #1e293b !important; color: #e5e7eb !important; }
    .darkmode .text-blue-900, .darkmode .text-blue-700, .darkmode .text-blue-800 { color: #e5e7eb !important; }
    .darkmode .border-blue-100 { border-color: #334155 !important; }
    .spinner {
      display: inline-block;
      width: 26px;
      height: 26px;
      border: 3px solid #e0e7ff;
      border-top: 3px solid #1e3a8a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .notification-modal-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.24); z-index: 9999;
      display: none; justify-content: center; align-items: center;
    }
    .notification-modal {
      background: #fff; border-radius: 22px; box-shadow: 0 8px 40px #00336633, 0 1.5px 4px #276EF1aa;
      max-width: 97vw; min-width: 300px; width: 100%; max-width: 390px; padding: 2.7rem 1.2rem 1.7rem 1.2rem;
      position: relative; text-align: center;
    }
    .notification-modal .modal-status-icon { font-size: 2.7rem; margin-bottom: 0.7rem;}
    .notification-modal .modal-status-icon.success { color: #27ae60;}
    .notification-modal .modal-status-icon.error { color: #e74c3c;}
    .notification-modal .modal-status-icon.info { color: #276EF1;}
    .notification-modal .modal-title {font-size:1.2rem;font-weight:700;margin-bottom:0.5rem;color:#276EF1;}
    .notification-modal .modal-message {font-size:1.07rem;margin-bottom:1.1rem;color:#1B428C;}
    .notification-modal .close-modal { position:absolute;top:10px;right:18px;background:transparent;border:none;font-size:1.8rem;color:#888;cursor:pointer;opacity:0.7;}
    .notification-modal .close-modal:hover { opacity: 1;}
  </style>
</head>
<body id="body" class="bg-blue-50 min-h-screen flex flex-col">
  <!-- Notification Modal for feedback -->
  <div class="notification-modal-backdrop" id="notifModalBackdrop">
    <div class="notification-modal" id="notifCustomModal" role="dialog" aria-modal="true" aria-labelledby="notifModalTitle">
      <button class="close-modal" id="notifCloseModalBtn" aria-label="Close modal">&times;</button>
      <div id="notifModalContent"></div>
    </div>
  </div>
  <!-- Header/Nav -->
  <nav class="bg-white shadow flex items-center justify-between px-6 py-4">
    <div class="flex items-center gap-3">
      <img src="mainlogo.png" class="h-10" alt="Logo">
      <span class="text-2xl font-bold text-blue-700">ExamGuard Affiliate</span>
    </div>
    <div class="flex gap-2 items-center">
  
      <button id="logoutBtn" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition font-semibold text-sm shadow">Logout</button>
    </div>
  </nav>
  <!-- Tab Navigation -->
  <div class="tablist flex gap-2 overflow-x-auto px-2 sm:px-6 py-3 bg-white border-b border-blue-100">
    <button class="tab-active px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-overview-btn" onclick="showTab('overview')">Overview</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-analytics-btn" onclick="showTab('analytics')">Analytics</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-tools-btn" onclick="showTab('tools')">Referral Tools</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-activity-btn" onclick="showTab('activity')">Activity</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-payments-btn" onclick="showTab('payments')">Payments</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-leaderboard-btn" onclick="showTab('leaderboard')">Leaderboard</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-notifications-btn" onclick="showTab('notifications')">Notifications</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-documents-btn" onclick="showTab('documents')">Documents</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-referrals-btn" onclick="showTab('referrals')">Referrals Tree</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-support-btn" onclick="showTab('support')">Support</button>
    <button class="tab-inactive px-5 py-2 rounded-xl font-bold text-base outline-none transition" id="tab-settings-btn" onclick="showTab('settings')">Profile/Settings</button>
  </div>
  <!-- Main Content -->
  <main class="max-w-7xl mx-auto w-full px-2 sm:px-6 py-8">
    <!-- Overview Tab -->
    <section id="tab-overview" class="fade-in">
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-6 mb-10" id="overviewCards">
        <!-- Cards populated by JS -->
      </div>
      <div class="bg-white rounded-2xl shadow p-6 mb-6">
        <h2 class="text-blue-900 font-bold text-lg mb-4" id="overviewWelcome"></h2>
        <p class="text-blue-700 text-base mb-2">Track your affiliate performance, manage your links, and earn more as you promote ExamGuard.</p>
        <p class="text-blue-700 text-sm">Need help? <a href="#" class="text-blue-600 font-semibold hover:underline">Contact Support</a></p>
      </div>
    </section>
    <!-- Analytics Tab -->
    <section id="tab-analytics" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6 mb-6">
        <h2 class="text-blue-900 font-bold text-lg mb-4">Analytics</h2>
        <div class="flex flex-wrap gap-8" id="analyticsCharts">
          <!-- Charts populated by JS, or use a chart library -->
        </div>
        <div class="mt-8 flex gap-3">
          <button class="px-6 py-2 bg-cyan-600 text-white rounded-lg font-bold hover:bg-cyan-700 transition" id="exportCsvBtn">Export Data (CSV)</button>
          <button class="px-6 py-2 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800 transition" id="downloadPdfBtn">Download PDF Report</button>
        </div>
      </div>
    </section>
    <!-- Referral Tools Tab -->
    <section id="tab-tools" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-blue-900 font-bold text-lg mb-1">Your Referral Link</div>
          <div class="flex items-center gap-2 mb-2">
            <input type="text" readonly id="referralLink" class="px-3 py-2 rounded-lg border border-blue-200 text-blue-700 font-mono w-64 bg-blue-50" />
            <button id="copyReferralBtn" class="px-3 py-2 bg-blue-700 text-white rounded-lg font-semibold hover:bg-blue-800 transition">Copy</button>
          </div>
          <div class="text-blue-900/70 text-sm">Share your link on social media, blogs, or with friends!</div>
        </div>
        <div class="flex gap-2 mt-4 md:mt-0">
          <button class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition flex items-center gap-2" id="shareWhatsappBtn">WhatsApp</button>
          <button class="px-4 py-2 bg-cyan-600 text-white rounded-lg font-bold hover:bg-cyan-700 transition flex items-center gap-2" id="shareTwitterBtn">Twitter</button>
        </div>
      </div>
    </section>
    <!-- Activity Tab -->
    <section id="tab-activity" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <div class="text-blue-900 font-bold text-lg">Recent Activity</div>
          <a href="#" class="text-blue-700 text-sm font-semibold hover:underline">View All</a>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-left text-blue-900" id="activityTable">
            <thead>
              <tr class="border-b border-blue-100">
                <th class="py-2">Date</th>
                <th class="py-2">Action</th>
                <th class="py-2">User</th>
                <th class="py-2">Reward</th>
                <th class="py-2">Status</th>
              </tr>
            </thead>
            <tbody>
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- Payments Tab -->
    <section id="tab-payments" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <div class="text-blue-900 font-bold text-lg">Payments</div>
          <button id="requestPayoutBtn" class="text-blue-700 text-sm font-semibold hover:underline">Request Payout</button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-left text-blue-900" id="paymentsTable">
            <thead>
              <tr class="border-b border-blue-100">
                <th class="py-2">Date</th>
                <th class="py-2">Amount</th>
                <th class="py-2">Method</th>
                <th class="py-2">Status</th>
              </tr>
            </thead>
            <tbody>
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- Leaderboard Tab -->
    <section id="tab-leaderboard" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <div class="text-blue-900 font-bold text-lg">Top Affiliates</div>
          <a href="#" class="text-blue-700 text-sm font-semibold hover:underline">View Leaderboard</a>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-left text-blue-900" id="leaderboardTable">
            <thead>
              <tr class="border-b border-blue-100">
                <th class="py-2">Rank</th>
                <th class="py-2">Name</th>
                <th class="py-2">Referrals</th>
                <th class="py-2">Earnings</th>
              </tr>
            </thead>
            <tbody>
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- Notifications Tab -->
    <section id="tab-notifications" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-blue-900 font-bold text-lg mb-4">Notifications</h2>
        <ul class="space-y-4" id="notificationsList">
          <!-- Populated by JS -->
        </ul>
      </div>
    </section>
    <!-- Documents Tab -->
    <section id="tab-documents" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-blue-900 font-bold text-lg mb-4">Resources & Documents</h2>
        <ul class="space-y-3" id="documentsList">
          <!-- Populated by JS -->
        </ul>
      </div>
    </section>
    <!-- Referrals Tree Tab -->
    <section id="tab-referrals" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-blue-900 font-bold text-lg mb-4">Your Referral Tree</h2>
        <div class="flex flex-col gap-4 text-blue-900" id="referralsTree">
          <!-- Populated by JS -->
        </div>
      </div>
    </section>
    <!-- Support Tab -->
    <section id="tab-support" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-blue-900 font-bold text-lg mb-4">Support & FAQ</h2>
        <div class="mb-6" id="faqList">
          <!-- Populated by JS -->
        </div>
        <form id="supportForm" class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-4">
          <div>
            <label class="text-blue-900 text-sm font-semibold">Your Email</label>
            <input type="email" id="supportEmail" class="w-full px-3 py-2 rounded-lg border border-blue-200 focus:border-blue-500 focus:outline-none text-blue-900 mt-1" placeholder="your@email.com"/>
          </div>
          <div>
            <label class="text-blue-900 text-sm font-semibold">Subject</label>
            <input type="text" id="supportSubject" class="w-full px-3 py-2 rounded-lg border border-blue-200 focus:border-blue-500 focus:outline-none text-blue-900 mt-1" placeholder="Payment Issue"/>
          </div>
          <div class="col-span-2">
            <label class="text-blue-900 text-sm font-semibold">Message</label>
            <textarea id="supportMessage" class="w-full px-3 py-2 rounded-lg border border-blue-200 focus:border-blue-500 focus:outline-none text-blue-900 mt-1" rows="3" placeholder="Describe your issue..."></textarea>
          </div>
        </form>
        <div class="flex gap-3">
          <button id="sendSupportBtn" class="px-6 py-2 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800 transition">Send Message</button>
          <button class="px-6 py-2 bg-cyan-600 text-white rounded-lg font-bold hover:bg-cyan-700 transition" id="liveChatBtn">Live Chat</button>
        </div>
      </div>
    </section>
    <!-- Profile/Settings Tab -->
    <section id="tab-settings" class="hidden fade-in">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center gap-4 mb-4">
          <img id="profilePic" src="" class="h-14 w-14 rounded-full border-2 border-blue-100" alt="Profile">
          <div>
            <div class="text-blue-900 font-bold text-lg" id="profileName"></div>
            <div class="text-blue-700 text-sm" id="profileSince"></div>
            <div class="flex gap-2 mt-2" id="profileLinks"></div>
          </div>
        </div>
        <form id="profileForm" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div>
            <label class="text-blue-900 text-sm font-semibold">Email</label>
            <input type="email" id="profileEmail" class="w-full px-3 py-2 rounded-lg border border-blue-200 focus:border-blue-500 focus:outline-none text-blue-900 mt-1"/>
          </div>
          <div>
            <label class="text-blue-900 text-sm font-semibold">Bank Account</label>
            <input type="text" id="profileBank" class="w-full px-3 py-2 rounded-lg border border-blue-200 focus:border-blue-500 focus:outline-none text-blue-900 mt-1"/>
          </div>
          <div>
            <label class="text-blue-900 text-sm font-semibold">Change Password</label>
            <input type="password" id="profilePassword" class="w-full px-3 py-2 rounded-lg border border-blue-200 focus:border-blue-500 focus:outline-none text-blue-900 mt-1" placeholder="••••••••"/>
          </div>
          <div>
            <label class="text-blue-900 text-sm font-semibold">Notification Preferences</label>
            <select id="profileNotify" class="w-full px-3 py-2 rounded-lg border border-blue-200 focus:border-blue-500 focus:outline-none text-blue-900 mt-1">
              <option value="email">Email</option>
              <option value="sms">SMS</option>
              <option value="push">Push Only</option>
              <option value="all">All</option>
            </select>
          </div>
        </form>
        <div class="mt-6 flex gap-3">
          <button id="updateProfileBtn" class="px-6 py-2 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800 transition">Update Profile</button>
          <button class="px-6 py-2 bg-gray-200 text-blue-700 rounded-lg font-bold hover:bg-gray-300 transition" id="cancelProfileBtn">Cancel</button>
        </div>
      </div>
    </section>
  </main>
  <!-- Footer -->
  <footer class="bg-white border-t border-blue-100 py-6 mt-10 text-center text-blue-900/80 text-sm">
    &copy; 2025 ExamGuard Nigeria Affiliate. All rights reserved.
  </footer>
  <!-- Bootstrap Icons for notifications -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script>
    // Auth
    let affiliateToken = localStorage.getItem("affiliateToken");
    if (!affiliateToken) window.location.href = "affiliate-login.html";

    // Show notification modal
    function showNotificationModal(title, message, type = "info") {
      const backdrop = document.getElementById('notifModalBackdrop');
      const content = document.getElementById('notifModalContent');
      const closeBtn = document.getElementById('notifCloseModalBtn');
      let icon = "";
      if(type==="success") icon = '<span class="modal-status-icon success"><i class="bi bi-check-circle-fill"></i></span>';
      else if(type==="error") icon = '<span class="modal-status-icon error"><i class="bi bi-x-circle-fill"></i></span>';
      else icon = '<span class="modal-status-icon info"><i class="bi bi-info-circle"></i></span>';
      content.innerHTML = `${icon}<div class="modal-title">${title}</div><div class="modal-message">${message}</div>`;
      backdrop.style.display = 'flex';
      closeBtn.onclick = function() { backdrop.style.display = 'none'; };
      backdrop.onclick = function(e) { if(e.target===backdrop) closeBtn.onclick(); };
    }
    // Tabs
    const tabs = [
      'overview','analytics','tools','activity','payments','leaderboard',
      'notifications','documents','referrals','support','settings'
    ];
    function showTab(tab) {
      tabs.forEach(t => {
        document.getElementById(`tab-${t}`).classList.add('hidden');
        document.getElementById(`tab-${t}-btn`).classList.remove('tab-active');
        document.getElementById(`tab-${t}-btn`).classList.add('tab-inactive');
      });
      document.getElementById(`tab-${tab}`).classList.remove('hidden');
      document.getElementById(`tab-${tab}-btn`).classList.remove('tab-inactive');
      document.getElementById(`tab-${tab}-btn`).classList.add('tab-active');
    }
    window.onload = () => { showTab('overview'); loadDashboard(); };

    // Dark mode toggle
    function toggleDark() {
      document.getElementById('body').classList.toggle('darkmode');
    }

    // Logout
    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem("affiliateToken");
      window.location.href = "affiliate-login.html";
    };

    // Dashboard Data Loader (Assume endpoints exist)
    async function loadDashboard() {
      try {
        // Get profile info
        let res = await fetch("https://examguide.onrender.com/api/affiliate/me", {
          headers: { "Authorization": "Bearer " + affiliateToken }
        });
        if (!res.ok) throw new Error("Unauthorized");
        let { affiliate } = await res.json();

        // Overview cards
        let statsRes = await fetch("https://examguide.onrender.com/api/affiliate/stats", {
          headers: { "Authorization": "Bearer " + affiliateToken }
        });
        let stats = await statsRes.json();
        document.getElementById("overviewCards").innerHTML = `
          <div class="bg-white rounded-2xl shadow flex flex-col items-center py-6">
            <svg class="w-8 h-8 mb-2 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3"/></svg>
            <div class="text-2xl font-bold text-blue-900">₦${stats.earnings ?? "0"}</div>
            <div class="text-xs text-blue-600 font-medium">Total Earnings</div>
          </div>
          <div class="bg-white rounded-2xl shadow flex flex-col items-center py-6">
            <svg class="w-8 h-8 mb-2 text-cyan-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m2-4h.01"/></svg>
            <div class="text-2xl font-bold text-blue-900">${stats.clicks ?? "0"}</div>
            <div class="text-xs text-cyan-600 font-medium">Clicks</div>
          </div>
          <div class="bg-white rounded-2xl shadow flex flex-col items-center py-6">
            <svg class="w-8 h-8 mb-2 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>
            <div class="text-2xl font-bold text-blue-900">${stats.conversions ?? "0"}</div>
            <div class="text-xs text-green-600 font-medium">Conversions</div>
          </div>
          <div class="bg-white rounded-2xl shadow flex flex-col items-center py-6">
            <svg class="w-8 h-8 mb-2 text-purple-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-4-4"/></svg>
            <div class="text-2xl font-bold text-blue-900">${stats.referrals ?? "0"}</div>
            <div class="text-xs text-purple-600 font-medium">Referrals</div>
          </div>`;
        document.getElementById("overviewWelcome").textContent = `Welcome, ${affiliate.name || affiliate.email}!`;

        // Referral link
        document.getElementById("referralLink").value = affiliate.referralLink || "";
        document.getElementById("copyReferralBtn").onclick = function() {
          navigator.clipboard.writeText(affiliate.referralLink || "");
          showNotificationModal("Copied!", "Your referral link has been copied.", "success");
        };
        document.getElementById("shareWhatsappBtn").onclick = function() {
          window.open(`https://wa.me/?text=Join%20ExamGuard%20Nigeria!%20${encodeURIComponent(affiliate.referralLink || "")}`, "_blank");
        };
        document.getElementById("shareTwitterBtn").onclick = function() {
          window.open(`https://twitter.com/intent/tweet?text=Join%20ExamGuard%20Nigeria!%20${encodeURIComponent(affiliate.referralLink || "")}`, "_blank");
        };

        // Analytics charts: Example placeholders. Replace with chart library.
        document.getElementById("analyticsCharts").innerHTML = `
          <div class="flex-1 min-w-[250px]">
            <div class="text-blue-700 font-medium mb-2">Earnings Trend</div>
            <div class="w-full h-40 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600 font-bold">${stats.earningsTrend || "[Chart]"}</div>
          </div>
          <div class="flex-1 min-w-[250px]">
            <div class="text-blue-700 font-medium mb-2">Conversion Rate</div>
            <div class="w-full h-40 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600 font-bold">${stats.conversionRate || "[Chart]"}</div>
          </div>
          <div class="flex-1 min-w-[250px]">
            <div class="text-blue-700 font-medium mb-2">Earnings per Click</div>
            <div class="w-full h-40 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600 font-bold">${stats.earningsPerClick || "[Chart]"}</div>
          </div>
        `;

        // Activity Table
        let activityRes = await fetch("https://examguide.onrender.com/api/affiliate/activity", {
          headers: { "Authorization": "Bearer " + affiliateToken }
        });
        let activity = await activityRes.json();
        let tbody = activity.map(act => `
          <tr class="border-b border-blue-50">
            <td class="py-2">${act.date}</td>
            <td class="py-2">${act.action}</td>
            <td class="py-2">${act.user}</td>
            <td class="py-2">₦${act.reward}</td>
            <td class="py-2"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">${act.status}</span></td>
          </tr>
        `).join('');
        document.querySelector("#activityTable tbody").innerHTML = tbody;

        // Payments Table
        let paymentsRes = await fetch("https://examguide.onrender.com/api/affiliate/payments", {
          headers: { "Authorization": "Bearer " + affiliateToken }
        });
        let payments = await paymentsRes.json();
        document.querySelector("#paymentsTable tbody").innerHTML = payments.map(pay => `
          <tr class="border-b border-blue-50">
            <td class="py-2">${pay.date}</td>
            <td class="py-2">₦${pay.amount}</td>
            <td class="py-2">${pay.method}</td>
            <td class="py-2"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">${pay.status}</span></td>
          </tr>
        `).join('');
        document.getElementById("requestPayoutBtn").onclick = async function() {
          showNotificationModal("Processing...", "Your payout request is being processed.", "info");
          let res = await fetch("https://examguide.onrender.com/api/affiliate/request-payout", {
            method: "POST",
            headers: { "Authorization": "Bearer " + affiliateToken }
          });
          let data = await res.json();
          if (res.ok) showNotificationModal("Request Sent", data.message || "Request successful!", "success");
          else showNotificationModal("Error", data.message || "Could not process payout.", "error");
        };

        // Leaderboard Table
        let leaderboardRes = await fetch("https://examguide.onrender.com/api/affiliate/leaderboard", {
          headers: { "Authorization": "Bearer " + affiliateToken }
        });
        let leaderboard = await leaderboardRes.json();
        document.querySelector("#leaderboardTable tbody").innerHTML = leaderboard.map((u,i) => `
          <tr class="border-b border-blue-50">
            <td class="py-2 font-bold text-blue-700">${i+1}</td>
            <td class="py-2">${u.name}</td>
            <td class="py-2">${u.referrals}</td>
            <td class="py-2">₦${u.earnings}</td>
          </tr>
        `).join('');

        // Notifications
        let notifRes = await fetch("https://examguide.onrender.com/api/affiliate/notifications", {
          headers: { "Authorization": "Bearer " + affiliateToken }
        });
        let notifs = await notifRes.json();
        document.getElementById("notificationsList").innerHTML = notifs.map(n => `
          <li class="flex items-center gap-3">
            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">${n.type}</span>
            <span>${n.message}</span>
            <span class="text-blue-700 text-xs ml-auto">${n.timeAgo}</span>
          </li>
        `).join('');

        // Documents
        let docsRes = await fetch("https://examguide.onrender.com/api/affiliate/documents", {
          headers: { "Authorization": "Bearer " + affiliateToken }
        });
        let docs = await docsRes.json();
        document.getElementById("documentsList").innerHTML = docs.map(doc => `
          <li class="flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4h16v16H4z"/></svg>
            <span>${doc.title}</span>
            <a href="${doc.url}" class="ml-auto px-3 py-1 bg-blue-700 text-white rounded hover:bg-blue-800 text-xs font-semibold" download>Download</a>
          </li>
        `).join('');

        // Referrals Tree
        let treeRes = await fetch("https://examguide.onrender.com/api/affiliate/referrals-tree", {
          headers: { "Authorization": "Bearer " + affiliateToken }
        });
        let tree = await treeRes.json();
        let treeHtml = `<div><span class="font-bold">You</span><span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">${tree.directReferrals} Direct Referrals</span></div>`;
        treeHtml += `<div class="ml-8">${tree.children.map(child => `
          <div class="mb-2"><span class="font-semibold">${child.name}</span> <span class="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${child.referrals} Referrals</span></div>
        `).join('')}</div>`;
        document.getElementById("referralsTree").innerHTML = treeHtml;

        // FAQ
        let faqRes = await fetch("https://examguide.onrender.com/api/affiliate/faq", {
          headers: { "Authorization": "Bearer " + affiliateToken }
        });
        let faq = await faqRes.json();
        document.getElementById("faqList").innerHTML = faq.map(q => `
          <div class="font-semibold mb-2">${q.question}</div>
          <div class="text-blue-700 mb-4">${q.answer}</div>
        `).join('');

        // Support form
        document.getElementById("sendSupportBtn").onclick = async function() {
          let email = document.getElementById("supportEmail").value.trim();
          let subject = document.getElementById("supportSubject").value.trim();
          let message = document.getElementById("supportMessage").value.trim();
          if (!email || !subject || !message) {
            showNotificationModal("Error", "Please fill all support fields.", "error");
            return;
          }
          showNotificationModal("Sending...", "Your support message is being sent.", "info");
          let res = await fetch("https://examguide.onrender.com/api/affiliate/support", {
            method: "POST",
            headers: { "Authorization": "Bearer " + affiliateToken, "Content-Type": "application/json" },
            body: JSON.stringify({ email, subject, message })
          });
          let data = await res.json();
          if (res.ok) showNotificationModal("Sent", data.message || "Support message sent!", "success");
          else showNotificationModal("Error", data.message || "Could not send message.", "error");
        };
        document.getElementById("liveChatBtn").onclick = function() {
          window.open("https://wa.me/2348030000000?text=Hello%20ExamGuard%20Support,%20I%20need%20affiliate%20help", "_blank");
        };

        // Profile/Settings
        document.getElementById("profilePic").src = affiliate.profilePic || "https://ui-avatars.com/api/?name=" + encodeURIComponent(affiliate.name || "Affiliate");
        document.getElementById("profileName").textContent = affiliate.name || affiliate.email;
        document.getElementById("profileSince").textContent = "Affiliate since " + (affiliate.since || "Unknown");
        document.getElementById("profileEmail").value = affiliate.email || "";
        document.getElementById("profileBank").value = affiliate.bankAccount || "";
        document.getElementById("profilePassword").value = "";
        document.getElementById("profileNotify").value = affiliate.notify || "email";
        document.getElementById("profileLinks").innerHTML = affiliate.socialLinks?.map(l => `<a href="${l.url}" class="text-blue-700 hover:text-blue-900 text-xs bg-blue-100 px-2 py-1 rounded">${l.platform}</a>`).join('') || "";

        // Profile update
        document.getElementById("updateProfileBtn").onclick = async function() {
          let email = document.getElementById("profileEmail").value.trim();
          let bank = document.getElementById("profileBank").value.trim();
          let password = document.getElementById("profilePassword").value.trim();
          let notify = document.getElementById("profileNotify").value;
          showNotificationModal("Updating...", "Updating your profile...", "info");
          let res = await fetch("https://examguide.onrender.com/api/affiliate/update-profile", {
            method: "POST",
            headers: { "Authorization": "Bearer " + affiliateToken, "Content-Type": "application/json" },
            body: JSON.stringify({ email, bankAccount: bank, password, notify })
          });
          let data = await res.json();
          if (res.ok) showNotificationModal("Success", data.message || "Profile updated!", "success");
          else showNotificationModal("Error", data.message || "Could not update profile.", "error");
        };
        document.getElementById("cancelProfileBtn").onclick = function() { loadDashboard(); };

      } catch(e) {
        showNotificationModal("Error", e.message || "Failed to load dashboard.", "error");
        setTimeout(() => window.location.href = "affiliate-login.html", 3000);
      }
    }
  </script>
</body>
</html>
