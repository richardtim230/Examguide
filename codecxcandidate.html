<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CODECX Student Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=0.80">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow px-4 py-4 flex items-center justify-between">
    <h1 class="text-2xl font-bold text-indigo-800">CODECX Student Dashboard</h1>
    <div class="flex items-center gap-2">
      <img id="studentAvatar" class="w-10 h-10 rounded-full" src="" alt="avatar" />
      <span id="studentNameHeader" class="font-semibold"></span>
      <button onclick="logout()" class="ml-3 px-4 py-1 bg-red-600 text-white rounded hover:bg-red-700">Logout</button>
    </div>
  </header>
  <main class="max-w-3xl mx-auto py-8 px-2">
    <section class="bg-white rounded shadow p-6 mb-8" id="profileSection">
      <h2 class="text-xl font-semibold mb-4">Profile</h2>
      <div class="flex items-center mb-4">
        <img id="studentPassport" class="w-20 h-20 rounded-full border mr-6" src="" alt="Passport"/>
        <div>
          <div id="studentFullName" class="text-lg font-bold"></div>
          <div id="studentMatric" class="text-sm text-gray-500"></div>
          <div id="studentEmail" class="text-sm text-gray-600"></div>
          <div id="studentPhone" class="text-sm text-gray-600"></div>
          <div id="studentNassDue" class="text-sm"></div>
          <div id="studentStatus" class="text-sm mt-2"></div>
        </div>
      </div>
      <div class="flex flex-wrap gap-3 mb-3">
        <button onclick="showReceipt('payment')" class="px-3 py-1 bg-indigo-600 text-white rounded">View Payment Receipt</button>
        <button onclick="showReceipt('nass')" class="px-3 py-1 bg-indigo-600 text-white rounded">View NASS Receipt</button>
      </div>
    </section>
    <section class="bg-white rounded shadow p-6 mb-8" id="activitySection">
      <h2 class="text-xl font-semibold mb-4">Activity</h2>
      <div class="mb-3">
        <button id="attendanceBtn" class="px-3 py-1 bg-green-600 text-white rounded mb-2">Mark Attendance</button>
        <span id="attendanceStatus" class="ml-3 font-semibold"></span>
      </div>
      <div>
        <label class="block mb-1 font-medium">Upload Assignment:</label>
        <input id="assignmentInput" type="file" class="mb-2"/>
        <button onclick="submitAssignment()" class="px-3 py-1 bg-indigo-600 text-white rounded mb-2">Submit</button>
        <span id="assignmentStatus" class="ml-2"></span>
      </div>
    </section>
    <section class="bg-white rounded shadow p-6 mb-8" id="historySection">
      <h2 class="text-xl font-semibold mb-4">History</h2>
      <table class="min-w-full text-sm">
        <thead>
          <tr>
            <th class="px-2 py-1 border">Date</th>
            <th class="px-2 py-1 border">Assignment</th>
            <th class="px-2 py-1 border">Attendance</th>
          </tr>
        </thead>
        <tbody id="historyTable"></tbody>
      </table>
    </section>
    <section class="bg-white rounded shadow p-6" id="notesSection">
      <h2 class="text-xl font-semibold mb-4">Admin Notes</h2>
      <div id="adminNote" class="text-gray-700"></div>
    </section>
    <!-- Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 z-30 bg-black bg-opacity-60 flex items-center justify-center hidden">
      <div class="bg-white p-6 rounded shadow relative max-w-lg w-full">
        <button onclick="closeReceipt()" class="absolute top-2 right-2 text-lg font-bold">&times;</button>
        <div id="receiptModalContent"></div>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    const API_BASE = "https://examguide.onrender.com/api";

    // --- Utility functions
    function showToast(msg, type="info") {
      Toastify({
        text: msg,
        duration: 3500,
        gravity: "top",
        position: "center",
        backgroundColor: type === "success" ? "#16a34a" :
                          type === "error" ? "#dc2626" : "#6366f1"
      }).showToast();
    }
    function logout() {
      localStorage.removeItem('token');
      window.location.href = "codexcclogin.html";
    }

    // --- Receipt Modal
    function showReceipt(type) {
      const student = window.student;
      let src = type === "payment" ? student.paymentReceiptBase64 : student.nassReceiptBase64;
      let label = type === "payment" ? "Payment Receipt" : "NASS Receipt";
      document.getElementById("receiptModalContent").innerHTML = src
        ? `<h3 class="mb-2 font-semibold">${label}</h3><img src="${src}" alt="${label}" class="mb-2 rounded shadow"/><a href="${src}" download="${student.fullName}_${label}.jpg" class="px-3 py-1 bg-indigo-600 text-white rounded">Download</a>`
        : `<div class="text-gray-500">No ${label} available.</div>`;
      document.getElementById("receiptModal").classList.remove("hidden");
    }
    function closeReceipt() {
      document.getElementById("receiptModal").classList.add("hidden");
    }
    document.getElementById("receiptModal").addEventListener("click", function(e) {
      if (e.target === this) closeReceipt();
    });

    // --- Main Logic
    async function loadDashboard() {
      const token = localStorage.getItem('token');
      if (!token) return logout();

      // 1. Get user info from JWT
      let user;
      try {
        const resp = await fetch(`${API_BASE}/auth/me`, {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await resp.json();
        if (!resp.ok || !data.user) throw new Error();
        user = data.user;
      } catch (e) {
        showToast("Session expired. Please log in again.", "error");
        return logout();
      }

      // 2. Fetch candidate registration by matricNumber
      let candidate;
      try {
        // Prefer matricNumber, fallback to loginUsername/email if needed
        let matric = user.matricNumber || user.loginUsername;
        let response = await fetch(`${API_BASE}/codecxreg?matricNumber=${encodeURIComponent(matric)}`);
        if (!response.ok) throw new Error();
        let regList = await response.json();
        // If your backend returns an array, find first match (adjust as needed)
        candidate = Array.isArray(regList) ? regList[0] : regList;
        if (!candidate || (!candidate.matricNumber && !candidate.loginUsername)) throw new Error();
      } catch (e) {
        showToast("Unable to load your registration record.", "error");
        return logout();
      }
      window.student = candidate; // for modal/receipt

      // 3. Render profile
      document.getElementById("studentAvatar").src =
        candidate.passportBase64 || "https://ui-avatars.com/api/?name=" + encodeURIComponent(candidate.fullName || "Student");
      document.getElementById("studentNameHeader").textContent = candidate.fullName || "";
      document.getElementById("studentPassport").src =
        candidate.passportBase64 || "https://ui-avatars.com/api/?name=" + encodeURIComponent(candidate.fullName || "Student");
      document.getElementById("studentFullName").textContent = candidate.fullName || "";
      document.getElementById("studentMatric").textContent = "Matric No: " + (candidate.matricNumber || "");
      document.getElementById("studentEmail").textContent = candidate.email || "";
      document.getElementById("studentPhone").textContent = candidate.phone || "";
      document.getElementById("studentNassDue").innerHTML =
        candidate.nassDue === "yes"
          ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">NASS Paid</span>'
          : '<span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs font-semibold">NASS Not Paid</span>';
      document.getElementById("studentStatus").innerHTML =
        candidate.active
          ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">Active</span>'
          : '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-semibold">Pending Review</span>';

      // 4. Render notes
      document.getElementById("adminNote").textContent = candidate.adminNote || "No feedback yet.";

      // 5. Render activity history
      renderHistory(candidate.activities || []);

      // 6. Initialize today's activity status
      window.student.today = window.student.today || { assignmentSubmitted: false, attendanceMarked: false };
      renderTodayStatus();
    }

    // --- Attendance and Assignment
    document.getElementById("attendanceBtn").onclick = function() {
      if (window.student.today.attendanceMarked) {
        showToast("You have already marked attendance today.", "info");
        return;
      }
      window.student.today.attendanceMarked = true;
      renderTodayStatus();
      showToast("Attendance marked for today!", "success");
      updateTodayHistory({ attendance: true });
    };

    function submitAssignment() {
      const fileInput = document.getElementById("assignmentInput");
      if (!fileInput.files.length) {
        showToast("Please select a file.", "error");
        return;
      }
      // Simulate upload (replace with your backend submission if needed)
      setTimeout(() => {
        window.student.today.assignmentSubmitted = true;
        renderTodayStatus();
        showToast("Assignment uploaded successfully!", "success");
        updateTodayHistory({ assignment: true });
      }, 900);
    }

    function renderTodayStatus() {
      document.getElementById("attendanceStatus").textContent =
        window.student.today.attendanceMarked ? "Marked Present" : "";
      document.getElementById("assignmentStatus").textContent =
        window.student.today.assignmentSubmitted ? "Submitted" : "Not submitted";
    }

    function updateTodayHistory({ attendance = false, assignment = false }) {
      const todayStr = new Date().toISOString().split('T')[0];
      let activities = window.student.activities = window.student.activities || [];
      let today = activities.find(act => act.date === todayStr);
      if (!today) {
        today = { date: todayStr, submittedAssignment: false, markedPresent: false };
        activities.unshift(today);
      }
      if (attendance) today.markedPresent = true;
      if (assignment) today.submittedAssignment = true;
      renderHistory(activities);
    }

    function renderHistory(activities) {
      const tbody = document.getElementById("historyTable");
      tbody.innerHTML = "";
      if (!activities.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-gray-400 text-center">No records yet.</td></tr>`;
        return;
      }
      activities.forEach(act => {
        tbody.innerHTML += `
          <tr>
            <td class="border px-2 py-1">${act.date}</td>
            <td class="border px-2 py-1">
              ${act.submittedAssignment
                ? "<span class='bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold'>Yes</span>"
                : "<span class='bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs font-semibold'>No</span>"
              }
            </td>
            <td class="border px-2 py-1">
              ${act.markedPresent
                ? "<span class='bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold'>Present</span>"
                : "<span class='bg-gray-200 text-gray-800 px-2 py-1 rounded text-xs font-semibold'>Absent</span>"
              }
            </td>
          </tr>
        `;
      });
    }

    window.onload = loadDashboard;
  </script>
</body>
</html>
